<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0A2342">
    <title>Sistema ATP de Clasificación de Pádel - Padeluminatis</title>
    <link rel="icon" type="image/x-icon" href="./imagenes/Logojafs.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="./css/header.css">
    <script type="module" src="./js/firebase-config.js"></script>
    <script type="module" src="./js/usuario-session.js"></script>
    <script type="module" src="./js/enlaceAdmin.js"></script>
    <script src="./js/menu-hamburguesa.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #1a2a6c;
            --secondary: #2c3e50;
            --accent: #f1c40f;
            --positive: #2ecc71;
            --negative: #e74c3c;
            --card-bg: rgba(30, 30, 40, 0.85);
            --text-light: #ecf0f1;
            --text-muted: #bdc3c7;
        }

        body {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--text-light);
            min-height: 100vh;
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .app-main {
            padding: 20px;
            padding-top: 100px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Asegurar que el header se vea correctamente */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: url(./imagenes/ChatGPT\ Image\ 12\ jun\ 2025,\ 13_26_46.png) center/cover;
            padding: 0.8rem 0.6rem;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .app-logo {
            width: 65px;
            height: 65px;
            border-radius: 15px;
            object-fit: cover;
            box-shadow: 0 0 15px rgba(233, 196, 106, 0.4);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .app-title {
            font-size: 1.8rem;
            font-family: 'Orbitron', 'Rajdhani', 'Poppins', sans-serif;
            background: linear-gradient(135deg, #FFD700, #E0B200);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            flex-grow: 1;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .menu-toggle {
            background: transparent;
            border: 1px solid rgba(228, 139, 24, 0.384);
            border-radius: 16px;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .menu-toggle:hover {
            border-color: #E76F51;
            transform: scale(1.05);
        }

        .menu-toggle i {
            color: #E76F51;
            font-size: 1.5rem;
            transition: transform 0.3s ease;
        }

        .app-nav {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100vh;
            background: rgba(30, 30, 30, 0.95);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1001;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            padding: 5rem 1rem 1rem;
            overflow-y: auto;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.2);
        }

        .app-nav.active {
            transform: translateX(300px);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            color: #FFFFFF;
            text-decoration: none;
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1002;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #E76F51;
            transform: scaleY(0);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .nav-item:hover::before {
            transform: scaleY(1);
        }

        .nav-item i {
            font-size: 1.2rem;
            color: #E76F51;
            transition: transform 0.3s ease;
            width: 24px;
            text-align: center;
        }

        .nav-item span {
            font-weight: 500;
            transition: transform 0.3s ease;
        }

        .nav-item:hover {
            background: rgba(0, 230, 211, 0.05);
            transform: translateX(5px);
        }

        .nav-item:hover i {
            transform: scale(1.1);
        }

        .nav-item:hover span {
            transform: translateX(5px);
        }

        .nav-item.active {
            background: rgba(0, 230, 211, 0.1);
            color: #E76F51;
        }

        .nav-item.active::before {
            transform: scaleY(1);
        }

        .nav-item.active i {
            transform: scale(1.1);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 30px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            color: var(--accent);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--text-muted);
            max-width: 800px;
            margin: 0 auto;
        }

        .system-explanation {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin: 20px auto;
            max-width: 900px;
        }

        .system-explanation h2 {
            color: var(--accent);
            margin-bottom: 15px;
            text-align: center;
        }

        .level-system {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .level-bar {
            background: #2c3e50;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
        }

        .level-progress {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.5s ease;
        }

        .level-markers {
            display: flex;
            justify-content: space-between;
            position: absolute;
            width: 100%;
            top: 0;
            padding: 5px;
            font-size: 0.8rem;
        }

        .level-marker {
            flex: 1;
            text-align: center;
        }

        .factors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .factor-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid var(--accent);
        }

        .factor-card h3 {
            color: var(--accent);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
            width: 100%;
            max-width: 100%;
        }

        .panel {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .panel h2 {
            color: var(--accent);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #34495e;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(44, 62, 80, 0.7);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s, background 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(52, 152, 219, 0.2);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
            margin: 10px 0;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.2);
            max-height: 600px;
            overflow-y: auto;
            max-width: 100%;
            width: 100%;
            padding-bottom: 1px;
        }

        .ranking-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 4px;
            margin: 1rem auto;
            background: rgba(18, 20, 25, 0.95);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            position: relative;
        }

        .ranking-table th {
            background: linear-gradient(135deg, rgba(35, 38, 46, 0.95), rgba(25, 28, 35, 0.95));
            color: #e5e5e5;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: none;
            letter-spacing: 0.3px;
            padding: 1rem 0.8rem;
            text-align: center;
            border-bottom: 2px solid rgba(233, 196, 106, 0.3);
            position: relative;
            transition: all 0.3s ease;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
        }

        .ranking-table th:first-child {
            text-align: center;
            width: 8%;
        }

        .ranking-table th:nth-child(2) {
            text-align: left;
            width: 30%;
        }

        .ranking-table th:nth-child(3) {
            text-align: center;
            width: 12%;
        }

        .ranking-table th:nth-child(4),
        .ranking-table th:nth-child(5) {
            text-align: center;
            width: 12%;
        }

        .ranking-table th:nth-child(6) {
            text-align: center;
            width: 11%;
        }

        .ranking-table th:nth-child(7) {
            text-align: center;
            width: 20%;
        }

        .ranking-table tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .ranking-table tr:hover {
            background: rgba(52, 152, 219, 0.1);
            cursor: pointer;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .ranking-table td {
            padding: 0.8rem 0.6rem;
            color: #e5e5e5;
            font-size: 0.75rem;
            border-top: 1px solid rgba(35, 38, 46, 0.5);
            border-bottom: 1px solid rgba(35, 38, 46, 0.5);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
            vertical-align: middle;
        }

        .ranking-table td:first-child {
            text-align: center;
            font-weight: 700;
            color: var(--accent);
            background: rgba(241, 196, 15, 0.1);
        }

        .ranking-table td:nth-child(2) {
            text-align: left;
            padding-left: 0.8rem;
            font-weight: 500;
        }

        .ranking-table td:nth-child(3) {
            text-align: center;
            font-weight: 600;
            color: #3498db;
        }

        .ranking-table td:nth-child(4),
        .ranking-table td:nth-child(5) {
            text-align: center;
            font-weight: 500;
        }

        .ranking-table td:nth-child(6) {
            text-align: center;
            font-weight: 600;
            color: #2ecc71;
        }

        .ranking-table td:nth-child(7) {
            text-align: center;
            font-weight: 700;
            color: var(--accent);
            animation: puntosBrillo 2s ease-in-out infinite;
        }

        @keyframes puntosBrillo {
            0%, 100% { text-shadow: 0 0 5px rgba(241, 196, 15, 0.5); }
            50% { text-shadow: 0 0 15px rgba(241, 196, 15, 0.8), 0 0 20px rgba(241, 196, 15, 0.6); }
        }

        /* Estilos para iconos de raqueta */
        .raqueta-oro { color: #ffd700; }
        .raqueta-plata { color: #c0c0c0; }
        .raqueta-bronce { color: #cd7f32; }

        .player-level {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .level-indicator {
            width: 80px;
            height: 6px;
            background: #2c3e50;
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .level-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
        }

        .level-value {
            font-weight: bold;
            min-width: 40px;
            text-align: right;
        }

        .puntos-elo {
            font-weight: bold;
            color: var(--accent);
        }

        .positive {
            color: var(--positive);
        }

        .negative {
            color: var(--negative);
        }

        .progress-container {
            height: 8px;
            background: #2c3e50;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 4px;
        }

        .history-container {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .history-item {
            background: rgba(44, 62, 80, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid var(--accent);
        }

        .history-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--accent);
        }

        .history-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            font-size: 0.9rem;
        }

        .history-label {
            color: var(--text-muted);
        }

        .history-value {
            font-weight: bold;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 220px;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #1a5f9e);
        }

        .btn-process {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .btn-diagnostic {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .btn-reset {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn-edit {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .status-bar {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.1rem;
        }

        .status-processing {
            color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid var(--accent);
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--card-bg);
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .close-modal {
            position: absolute;
            right: 20px;
            top: 20px;
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: var(--accent);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header h2 {
            color: var(--accent);
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .player-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .player-info div {
            background: rgba(44, 62, 80, 0.7);
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            color: var(--accent);
        }

        .player-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .player-stat {
            background: rgba(44, 62, 80, 0.5);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid var(--accent);
        }

        .stat-title {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent);
        }

        .match-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
        }

        .nav-button {
            background: var(--accent);
            color: var(--primary);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .nav-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(241, 196, 15, 0.3);
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .match-counter {
            background: rgba(44, 62, 80, 0.7);
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            color: var(--accent);
        }

        .match-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .match-info, .factors-list {
            background: rgba(44, 62, 80, 0.3);
            padding: 20px;
            border-radius: 15px;
        }

        .match-info h3, .factors-list h3 {
            color: var(--accent);
            margin-bottom: 15px;
            text-align: center;
        }

        .match-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-label {
            color: var(--text-muted);
        }

        .stat-value {
            font-weight: bold;
            color: var(--text-light);
        }

        .factor-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .factor-nombre {
            color: var(--text-muted);
        }

        .factor-valor {
            font-weight: bold;
        }

        .factor-valor.positive {
            color: var(--positive);
        }

        .factor-valor.negative {
            color: var(--negative);
        }

        .explanation {
            background: rgba(44, 62, 80, 0.3);
            padding: 20px;
            border-radius: 15px;
            border-left: 4px solid var(--accent);
        }

        .explanation h4 {
            color: var(--accent);
            margin-bottom: 15px;
        }

        .explanation ul {
            color: var(--text-muted);
        }

        .explanation li {
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .match-details {
                grid-template-columns: 1fr;
            }
            
            .player-info {
                flex-direction: column;
                align-items: center;
            }
            
            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 20px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
                margin-bottom: 10px;
            }
            
            .app-title {
                font-size: 1.4rem;
            }
            
            .app-logo {
                width: 50px;
                height: 50px;
            }
        }

        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
        }
    </style>
</head>
<body class="app-body">
    <header class="app-header">
        <div class="header-content">
            <img src="./imagenes/Logojafs.png" alt="Logo" class="app-logo">
            <h1 class="app-title">Sistema ATP de Clasificación</h1>
            <button class="menu-toggle" aria-label="Menú">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <nav class="app-nav">
          <a href="./home.html" class="nav-item"><i class="fas fa-home"></i><span>Inicio</span></a>
          <a href="./eventos.html" class="nav-item"><i class="fas fa-calendar-check"></i><span>Eventos</span></a>
          <a href="./calendario.html" class="nav-item"><i class="fas fa-calendar-alt"></i><span>Calendario</span></a>
          <a href="./clasificacion.html" class="nav-item"><i class="fas fa-trophy"></i><span>Clasificación</span></a>
          <a href="./normas.html" class="nav-item"><i class="fas fa-gavel"></i><span>Normas</span></a>
          <a href="./chat.html" class="nav-item"><i class="fas fa-comments"></i><span>Chat</span></a>
          <a href="./ranking.html" class="nav-item active"><i class="fas fa-list-ol"></i><span>Ranking ATP</span></a>
          <a href="./admin.html" class="nav-item nav-admin" style="display:none"><i class="fas fa-user-shield"></i><span>Admin</span></a>
          <a href="./perfil.html" class="nav-item"><i class="fas fa-user"></i><span>Perfil</span></a>
          <a href="./notificaciones.html" class="nav-item"><i class="fas fa-bell"></i><span>Notificaciones</span></a>
          <a href="index.html" class="nav-item nav-logout"><i class="fas fa-sign-out-alt"></i><span>Cerrar sesión</span></a>
        </nav>
    </header>
    <main class="app-main">
        <div class="container">
        <header>
            <h1><i class="fas fa-trophy"></i> Sistema ATP de Clasificación de Pádel</h1>
            <p class="subtitle">Sistema de cálculo de puntosRanking y nivel con precisión milimétrica</p>
        </header>

        <div class="system-explanation">
            <h2><i class="fas fa-calculator"></i> Sistema de Progreso de Nivel</h2>
            
            <div class="level-system">
                <div class="level-bar">
                    <div class="level-progress" style="width: 65%"></div>
                    <div class="level-markers">
                        <div class="level-marker">2.0</div>
                        <div class="level-marker">2.5</div>
                        <div class="level-marker">3.0</div>
                        <div class="level-marker">3.5</div>
                        <div class="level-marker">4.0</div>
                        <div class="level-marker">4.5</div>
                        <div class="level-marker">5.0</div>
                    </div>
                </div>
                <p>El nivel se ajusta en incrementos de ±0.01. Subir de nivel requiere más puntos a medida que aumenta el nivel del jugador.</p>
            </div>
            
            <div class="factors-grid">
                <div class="factor-card">
                    <h3><i class="fas fa-chess-king"></i> Precisión ATP</h3>
                    <p>Diferencias mínimas en resultados generan cambios perceptibles en la clasificación</p>
                </div>
                <div class="factor-card">
                    <h3><i class="fas fa-chart-line"></i> Progresión de nivel</h3>
                    <p>Cada 0.01 de nivel requiere más puntos. Más difícil mejorar en niveles altos</p>
                </div>
                <div class="factor-card">
                    <h3><i class="fas fa-balance-scale"></i> Equilibrio competitivo</h3>
                    <p>Los mejores jugadores se mantienen en lo alto, pero con diferencias perceptibles</p>
                </div>
            </div>
        </div>

        <div class="controls" id="adminControls" style="display: none;">
            <button id="diagnosticBtn" class="btn btn-diagnostic">
                <i class="fas fa-stethoscope"></i> Ver Diagnóstico
            </button>
            <button id="resetBtn" class="btn btn-reset">
                <i class="fas fa-undo"></i> Reiniciar Estadísticas
            </button>
            <button id="editLevelBtn" class="btn btn-edit">
                <i class="fas fa-edit"></i> Editar Niveles
            </button>
        </div>

        <div class="status-bar" id="statusBar">
            Cargando datos automáticamente...
        </div>

        <div class="dashboard">
            <div class="panel">
                <h2><i class="fas fa-chart-bar"></i> Estadísticas Generales</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Jugadores Totales</div>
                        <div class="stat-value" id="totalPlayers">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Partidos Procesados</div>
                        <div class="stat-value" id="totalMatches">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Nivel Promedio</div>
                        <div class="stat-value" id="avgLevel">0.0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Puntos Promedio</div>
                        <div class="stat-value" id="avgPoints">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Mejor Jugador</div>
                        <div class="stat-value" id="topPlayer">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Nivel Más Alto</div>
                        <div class="stat-value" id="topLevel">0.0</div>
                    </div>
                </div>
                
                <h2 style="margin-top: 30px;"><i class="fas fa-history"></i> Últimos Partidos</h2>
                <div class="history-container" id="lastMatches">
                    <div class="history-item">
                        <div class="history-title">Cargando datos...</div>
                        <p>Presione "Cargar Datos Actuales" para ver los partidos</p>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-trophy"></i> Clasificación ATP</h2>
                <div class="table-container">
                    <table class="ranking-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Jugador</th>
                                <th>Nivel</th>
                                <th>PJ</th>
                                <th>PG</th>
                                <th>Win Rate</th>
                                <th>Puntos</th>
                                <th>Δ</th>
                            </tr>
                        </thead>
                        <tbody id="rankingBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 30px; color: var(--text-muted);">
                                    <i class="fas fa-tachometer-alt" style="font-size: 3rem; margin-bottom: 15px; display: block;"></i>
                                    Cargando datos de clasificación...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal para detalles del jugador -->
    <div id="playerModal" class="modal">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            
            <div class="modal-header">
                <h2 id="modalPlayerName">Jugador</h2>
                <div class="player-info">
                    <div id="modalPlayerLevel">Nivel: 0.0</div>
                    <div id="modalPlayerPoints">Puntos Ranking: 0</div>
                </div>
            </div>
            
            <div class="player-stats">
                <div class="player-stat">
                    <div class="stat-title">Partidos Jugados</div>
                    <div class="stat-number" id="modalMatches">0</div>
                </div>
                <div class="player-stat">
                    <div class="stat-title">Victorias</div>
                    <div class="stat-number" id="modalWins">0</div>
                </div>
                <div class="player-stat">
                    <div class="stat-title">Sets (G-P)</div>
                    <div class="stat-number" id="modalSets">0-0</div>
                </div>
                <div class="player-stat">
                    <div class="stat-title">Win Rate</div>
                    <div class="stat-number" id="modalWinRate">0%</div>
                </div>
            </div>
            
            <div class="match-nav">
                <button id="prevMatch" class="nav-button" disabled>Anterior</button>
                <div class="match-counter" id="matchCounter">Partido 0 de 0</div>
                <button id="nextMatch" class="nav-button" disabled>Siguiente</button>
            </div>
            
            <div class="match-details">
                <div class="match-info">
                    <h3>Detalles del Partido</h3>
                    <div id="matchDetails">
                        <p style="text-align: center; color: #bdc3c7;">Selecciona un partido para ver los detalles.</p>
                    </div>
                </div>
                
                <div class="factors-list">
                    <h3>Desglose de Puntos</h3>
                    <div id="matchFactors">
                        <p style="text-align: center; color: #bdc3c7;">Los factores se mostrarán aquí.</p>
                    </div>
                </div>
            </div>
            
            <div class="explanation">
                <h4>¿Cómo se calculan los puntos?</h4>
                <p>El sistema ATP tiene en cuenta múltiples factores para determinar los cambios en el ranking:</p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li><strong>Tipo de partido:</strong> Liga (x1.25), Reto (x1.0), Amistoso (x0.6)</li>
                    <li><strong>Dificultad del rival:</strong> Ganar a rivales más fuertes da más puntos</li>
                    <li><strong>Resultado:</strong> Victoria 2-0 (+15), Victoria 2-1 (+10), Derrota 1-2 (-8), Derrota 0-2 (-12)</li>
                    <li><strong>Diferencia de juegos:</strong> Margen de victoria/derrota en cada set</li>
                    <li><strong>Racha actual:</strong> Bonificación por rachas de victorias</li>
                    <li><strong>Inactividad:</strong> Penalización por no jugar durante más de 21 días</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Estado de la aplicación
        const state = {
            players: [],
            partidos: [],
            equipos: {},
            lastRanking: [],
            processing: false,
            lastUpdate: null
        };

        // Clase para el sistema de puntuación avanzado ATP
        class SistemaPuntuacionATP {
            // Calcular puntos requeridos para el siguiente 0.01 de nivel
            calcularPuntosRequeridos(nivelActual) {
                const base = 50; // Puntos base para nivel 2.0 (más fácil subir)
                const factorDificultad = 1.08; // Incremento más suave
                const diferenciaNivel = nivelActual - 2.0;
                return Math.round(base * Math.pow(factorDificultad, diferenciaNivel * 100));
            }

            // Calcular el cambio de puntos y nivel
            calcularCambio(params) {
                const { jugador, rivales, resultado, tipoPartido, margenSets, experiencia, racha, companero, diasSinJugar } = params;
                
                // 1. Cálculo base según resultado
                let cambioBase = 0;
                if (resultado === 1) { // Victoria
                    cambioBase = margenSets === 2 ? 12 : 8;
                } else { // Derrota
                    cambioBase = margenSets === 2 ? -10 : -6;
                }
                
                // 2. Factor por tipo de partido
                let multiplicador = 1.0;
                switch (tipoPartido) {
                    case 'liga': multiplicador = 1.25; break;
                    case 'reto': multiplicador = 1.0; break;
                    case 'amistoso': multiplicador = 0.6; break;
                }
                
                // 3. Diferencia de nivel entre equipos (el factor más importante)
                const nivelEquipo = (jugador.nivel + (companero?.nivel || jugador.nivel)) / 2;
                const nivelRivales = (rivales[0].nivel + rivales[1].nivel) / 2;
                const diferenciaNivel = nivelEquipo - nivelRivales;
                const ajusteDificultad = diferenciaNivel * (-8);
                
                // 4. Ajuste por racha (máximo ±5 puntos)
                let ajusteRacha = 0;
                if (racha >= 3 && resultado === 1) {
                    ajusteRacha = Math.min(5, racha * 0.7);
                } else if (racha <= -3 && resultado === 0) {
                    ajusteRacha = Math.max(-5, racha * 0.4);
                }
                
                // 5. Ajuste por experiencia (jugadores nuevos ganan más puntos)
                const ajusteExperiencia = Math.max(0, (30 - experiencia) * 0.1);
                
                // 6. Ajuste por inactividad
                const ajusteInactividad = diasSinJugar > 21 ? -Math.min(10, diasSinJugar * 0.1) : 0;
                
                // 7. Calcular cambio total con precisión decimal
                let cambioTotal = (cambioBase + ajusteDificultad + ajusteRacha + ajusteExperiencia + ajusteInactividad) * multiplicador;
                
                // Redondear a 2 decimales para precisión
                cambioTotal = Math.round(cambioTotal * 100) / 100;
                
                // 8. Calcular cambio en el nivel (sistema de progreso ATP)
                const puntosRequeridos = this.calcularPuntosRequeridos(jugador.nivel);
                const cambioNivel = cambioTotal / puntosRequeridos;
                const nuevoNivel = jugador.nivel + (cambioNivel / 100);
                
                // Mantener nivel dentro de límites razonables
                const nivelFinal = Math.max(2.0, Math.min(5.0, parseFloat(nuevoNivel.toFixed(4))));
                
                return {
                    nuevoPuntos: jugador.puntosRanking + cambioTotal,
                    nivel: nivelFinal,
                    cambioPuntos: cambioTotal
                };
            }
        }

        // Actualizar estado de la barra de estado
        function updateStatus(message, isProcessing = false) {
            const statusBar = document.getElementById('statusBar');
            if (!statusBar) return;
            
            if (isProcessing) {
                statusBar.innerHTML = `
                    <div class="status-processing">
                        <div class="spinner"></div>
                        ${message}
                    </div>
                `;
            } else {
                statusBar.textContent = message;
            }
        }

        // Cargar datos automáticamente
        async function cargarDatosAutomaticamente() {
            updateStatus("Esperando autenticación...", true);
            
            try {
                // Esperar a que Firebase Auth esté listo
                let attempts = 0;
                const maxAttempts = 50; // 5 segundos máximo
                
                while (!window.firebase?.auth?.currentUser && attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                // Verificar autenticación después de esperar
                if (!window.firebase?.auth?.currentUser) {
                    updateStatus("Redirigiendo al login...");
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return;
                }
                
                updateStatus("Cargando datos desde Firebase...", true);
                
                // Cargar usuarios
                await cargarUsuarios();
                
                // Cargar equipos
                await cargarEquipos();
                
                // Cargar partidos
                await cargarPartidos();
                
                // Procesar clasificación automáticamente
                await procesarClasificacionAutomatica();
                
                updateStatus(`Datos cargados y procesados: ${state.players.length} jugadores, ${state.partidos.length} partidos.`);
                actualizarEstadisticas();
                actualizarClasificacion();
                actualizarUltimosPartidos();
            } catch (error) {
                updateStatus("Error al cargar datos: " + error.message);
                console.error(error);
            }
        }

        // Procesar clasificación automáticamente (sin guardar)
        async function procesarClasificacionAutomatica() {
            try {
                // Crear sistema de puntuación
                const sistemaPuntuacion = new SistemaPuntuacionATP();
                
                // Procesar cada partido en orden cronológico
                for (const partido of state.partidos) {
                    let jugadoresLocal = [];
                    let jugadoresVisitante = [];
                    
                    if (partido.tipo === 'liga') {
                        jugadoresLocal = obtenerJugadoresEquipo(partido.equipoLocalId);
                        jugadoresVisitante = obtenerJugadoresEquipo(partido.equipoVisitanteId);
                    } else {
                        if (partido.jugadores && partido.jugadores.length >= 4) {
                            jugadoresLocal = partido.jugadores.slice(0, 2).map(id => 
                                state.players.find(p => p.id === id)
                            );
                            jugadoresVisitante = partido.jugadores.slice(2, 4).map(id => 
                                state.players.find(p => p.id === id)
                            );
                        } else {
                            continue;
                        }
                    }
                    
                    if (jugadoresLocal.length < 2 || jugadoresVisitante.length < 2) continue;
                    
                    // Calcular sets ganados
                    const resultado = partido.resultado;
                    const setsLocal = [resultado.set1.puntos1, resultado.set2?.puntos1 || 0, resultado.set3?.puntos1 || 0];
                    const setsVisitante = [resultado.set1.puntos2, resultado.set2?.puntos2 || 0, resultado.set3?.puntos2 || 0];
                    
                    let setsGanadosLocal = 0;
                    let setsGanadosVisitante = 0;
                    
                    for (let i = 0; i < 3; i++) {
                        if (setsLocal[i] > setsVisitante[i]) {
                            setsGanadosLocal++;
                        } else if (setsVisitante[i] > setsLocal[i]) {
                            setsGanadosVisitante++;
                        }
                    }
                    
                    const localGano = setsGanadosLocal > setsGanadosVisitante;
                    const diferenciaMarcador = Math.abs(setsGanadosLocal - setsGanadosVisitante);
                    
                    // Procesar jugadores locales
                    for (const jugador of jugadoresLocal) {
                        if (!jugador) continue;
                        
                        procesarJugadorEnPartido(
                            jugador,
                            jugadoresLocal.find(j => j && j.id !== jugador.id),
                            jugadoresVisitante,
                            localGano ? 1 : 0,
                            setsGanadosLocal,
                            setsGanadosVisitante,
                            diferenciaMarcador,
                            partido.tipo,
                            sistemaPuntuacion,
                            partido.fecha
                        );
                    }
                    
                    // Procesar jugadores visitantes
                    for (const jugador of jugadoresVisitante) {
                        if (!jugador) continue;
                        
                        procesarJugadorEnPartido(
                            jugador,
                            jugadoresVisitante.find(j => j && j.id !== jugador.id),
                            jugadoresLocal,
                            localGano ? 0 : 1,
                            setsGanadosVisitante,
                            setsGanadosLocal,
                            diferenciaMarcador,
                            partido.tipo,
                            sistemaPuntuacion,
                            partido.fecha
                        );
                    }
                }
                
                console.log('✅ Clasificación procesada automáticamente');
            } catch (error) {
                console.error('❌ Error al procesar clasificación automática:', error);
                throw error;
            }
        }

        // Cargar usuarios desde Firebase
        async function cargarUsuarios() {
            try {
                // Verificar que las funciones de Firebase estén disponibles
                if (!window.getDocs || !window.collection || !window.firebase?.db) {
                    throw new Error('Funciones de Firebase no disponibles');
                }
                
                const usuariosSnap = await window.getDocs(window.collection(window.firebase.db, "usuarios"));
                state.players = usuariosSnap.docs.map((doc) => {
                    const data = doc.data();
                    const nivel = parseFloat(data.nivel) || 2.0;
                    
                    return {
                        id: doc.id,
                        name: data.nombreUsuario || data.displayName || 'Sin nombre',
                        nivel: nivel,
                        puntosRanking: data.puntosRanking || Math.round(500 + (nivel * 100)),
                        matches: data.matches || 0,
                        wins: data.wins || 0,
                        setsWon: data.setsWon || 0,
                        setsLost: data.setsLost || 0,
                        racha: data.racha || 0,
                        lastPlayed: data.lastPlayed?.toDate() || null
                    };
                });
                console.log(`✅ Cargados ${state.players.length} usuarios`);
                return state.players;
            } catch (error) {
                console.error('❌ Error al cargar usuarios:', error);
                throw new Error('No se pudieron cargar los usuarios desde Firebase');
            }
        }

        // Cargar equipos desde Firebase
        async function cargarEquipos() {
            try {
                const equiposSnap = await window.getDocs(window.collection(window.firebase.db, "equipos"));
                state.equipos = {};
                equiposSnap.docs.forEach(doc => {
                    const data = doc.data();
                    state.equipos[doc.id] = {
                        id: doc.id,
                        nombre: data.nombre || `Equipo ${doc.id}`,
                        jugadores: data.jugadores || []
                    };
                });
                console.log(`✅ Cargados ${Object.keys(state.equipos).length} equipos`);
                return state.equipos;
            } catch (error) {
                console.error('❌ Error al cargar equipos:', error);
                state.equipos = {};
                return state.equipos;
            }
        }

        // Cargar partidos desde Firebase
        async function cargarPartidos() {
            try {
                let partidosArr = [];
                
                // Cargar partidos de liga
                const calendarioSnap = await window.getDocs(window.collection(window.firebase.db, "calendario"));
                for (const jornadaDoc of calendarioSnap.docs) {
                    const partidosSnap = await window.getDocs(window.collection(window.firebase.db, `calendario/${jornadaDoc.id}/partidos`));
                    partidosSnap.forEach(partidoDoc => {
                        const partido = partidoDoc.data();
                        if (partido.resultado && partido.resultado.set1) {
                            partidosArr.push({
                                ...partido,
                                id: partidoDoc.id,
                                tipo: 'liga',
                                fecha: partido.fecha?.toDate() || new Date(),
                                equipoLocalId: partido.equipoLocal,
                                equipoVisitanteId: partido.equipoVisitante
                            });
                        }
                    });
                }
                
                // Cargar partidos amistosos
                const amistososSnap = await window.getDocs(window.collection(window.firebase.db, "partidosAmistosos"));
                amistososSnap.forEach(doc => {
                    const partido = doc.data();
                    if (partido.resultado && partido.resultado.set1) {
                        partidosArr.push({
                            ...partido,
                            id: doc.id,
                            tipo: 'amistoso',
                            fecha: partido.fecha?.toDate() || new Date(),
                            jugadores: partido.jugadores || []
                        });
                    }
                });
                
                // Cargar partidos de reto
                const retosSnap = await window.getDocs(window.collection(window.firebase.db, "partidosReto"));
                retosSnap.forEach(doc => {
                    const partido = doc.data();
                    if (partido.resultado && partido.resultado.set1) {
                        partidosArr.push({
                            ...partido,
                            id: doc.id,
                            tipo: 'reto',
                            fecha: partido.fecha?.toDate() || new Date(),
                            jugadores: partido.jugadores || []
                        });
                    }
                });
                
                // Ordenar por fecha
                state.partidos = partidosArr.sort((a, b) => a.fecha - b.fecha);
                console.log(`✅ Cargados ${state.partidos.length} partidos`);
                return state.partidos;
            } catch (error) {
                console.error('❌ Error al cargar partidos:', error);
                state.partidos = [];
                return state.partidos;
            }
        }

        // Obtener jugadores de un equipo
        function obtenerJugadoresEquipo(equipoId) {
            const equipo = state.equipos[equipoId];
            if (!equipo || !equipo.jugadores) return [];
            return equipo.jugadores.map(jugadorId => {
                return state.players.find(j => j.id === jugadorId) || generarJugadorFantasma(jugadorId);
            });
        }

        // Generar jugador fantasma cuando no se encuentra en la base de datos
        function generarJugadorFantasma(jugadorId) {
            return { 
                id: jugadorId, 
                name: 'Desconocido', 
                nivel: 2.0, 
                puntosRanking: 800, 
                matches: 0, 
                wins: 0, 
                setsWon: 0, 
                setsLost: 0, 
                racha: 0
            };
        }

        // Guardar datos actualizados en Firebase
        async function guardarDatosActualizados() {
            try {
                const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js');
                
                // Actualizar solo jugadores reales (no fantasmas)
                const jugadoresReales = state.players.filter(p => p.name !== 'Desconocido');
                
                for (const jugador of jugadoresReales) {
                    const jugadorRef = doc(window.firebase.db, 'usuarios', jugador.id);
                    await updateDoc(jugadorRef, {
                        nivel: jugador.nivel,
                        puntosRanking: Math.round(jugador.puntosRanking),
                        matches: jugador.matches,
                        wins: jugador.wins,
                        setsWon: jugador.setsWon,
                        setsLost: jugador.setsLost,
                        racha: jugador.racha,
                        lastPlayed: jugador.lastPlayed,
                        ultimaActualizacion: new Date()
                    });
                }
                
                console.log(`✅ Datos actualizados para ${jugadoresReales.length} jugadores`);
            } catch (error) {
                console.error('❌ Error al guardar datos:', error);
                throw new Error('No se pudieron guardar los datos actualizados');
            }
        }

        // Procesar clasificación
        async function procesarClasificacion() {
            if (state.processing) return;
            state.processing = true;
            updateStatus("Procesando clasificación con precisión ATP...", true);
            
            try {
                // Crear sistema de puntuación
                const sistemaPuntuacion = new SistemaPuntuacionATP();
                
                // Procesar cada partido en orden cronológico
                for (const partido of state.partidos) {
                    let jugadoresLocal = [];
                    let jugadoresVisitante = [];
                    
                    if (partido.tipo === 'liga') {
                        jugadoresLocal = obtenerJugadoresEquipo(partido.equipoLocalId);
                        jugadoresVisitante = obtenerJugadoresEquipo(partido.equipoVisitanteId);
                    } else {
                        if (partido.jugadores && partido.jugadores.length >= 4) {
                            jugadoresLocal = partido.jugadores.slice(0, 2).map(id => 
                                state.players.find(p => p.id === id)
                            );
                            jugadoresVisitante = partido.jugadores.slice(2, 4).map(id => 
                                state.players.find(p => p.id === id)
                            );
                        } else {
                            continue;
                        }
                    }
                    
                    if (jugadoresLocal.length < 2 || jugadoresVisitante.length < 2) continue;
                    
                    // Calcular sets ganados
                    const resultado = partido.resultado;
                    const setsLocal = [resultado.set1.puntos1, resultado.set2?.puntos1 || 0, resultado.set3?.puntos1 || 0];
                    const setsVisitante = [resultado.set1.puntos2, resultado.set2?.puntos2 || 0, resultado.set3?.puntos2 || 0];
                    
                    let setsGanadosLocal = 0;
                    let setsGanadosVisitante = 0;
                    
                    for (let i = 0; i < 3; i++) {
                        if (setsLocal[i] > setsVisitante[i]) {
                            setsGanadosLocal++;
                        } else if (setsVisitante[i] > setsLocal[i]) {
                            setsGanadosVisitante++;
                        }
                    }
                    
                    const localGano = setsGanadosLocal > setsGanadosVisitante;
                    const diferenciaMarcador = Math.abs(setsGanadosLocal - setsGanadosVisitante);
                    
                    // Procesar jugadores locales
                    for (const jugador of jugadoresLocal) {
                        if (!jugador) continue;
                        
                        procesarJugadorEnPartido(
                            jugador,
                            jugadoresLocal.find(j => j && j.id !== jugador.id),
                            jugadoresVisitante,
                            localGano ? 1 : 0,
                            setsGanadosLocal,
                            setsGanadosVisitante,
                            diferenciaMarcador,
                            partido.tipo,
                            sistemaPuntuacion,
                            partido.fecha
                        );
                    }
                    
                    // Procesar jugadores visitantes
                    for (const jugador of jugadoresVisitante) {
                        if (!jugador) continue;
                        
                        procesarJugadorEnPartido(
                            jugador,
                            jugadoresVisitante.find(j => j && j.id !== jugador.id),
                            jugadoresLocal,
                            localGano ? 0 : 1,
                            setsGanadosVisitante,
                            setsGanadosLocal,
                            diferenciaMarcador,
                            partido.tipo,
                            sistemaPuntuacion,
                            partido.fecha
                        );
                    }
                }
                
                // Guardar datos actualizados en Firebase
                await guardarDatosActualizados();
                
                // Actualizar UI
                actualizarEstadisticas();
                actualizarClasificacion();
                actualizarUltimosPartidos();
                
                updateStatus(`Clasificación ATP procesada y guardada (${new Date().toLocaleTimeString()})`);
                state.processing = false;
            } catch (error) {
                updateStatus("Error al procesar clasificación: " + error.message);
                console.error(error);
                state.processing = false;
            }
        }

        // Procesar un jugador en un partido
        function procesarJugadorEnPartido(jugador, companero, rivales, resultado, setsGanados, setsPerdidos, diferenciaMarcador, tipoPartido, sistemaPuntuacion, fecha) {
            // No procesar jugadores fantasma
            if (jugador.name === 'Desconocido') {
                return;
            }
            
            // Calcular días sin jugar
            const diasSinJugar = jugador.lastPlayed ? 
                Math.floor((fecha - jugador.lastPlayed) / (1000*60*60*24)) : 0;
            
            // Calcular cambio de puntos
            const resultadoPuntuacion = sistemaPuntuacion.calcularCambio({
                jugador: jugador,
                rivales: rivales.filter(Boolean).filter(r => r.name !== 'Desconocido'),
                resultado: resultado,
                tipoPartido: tipoPartido,
                margenSets: diferenciaMarcador,
                experiencia: jugador.matches,
                racha: jugador.racha,
                companero: companero && companero.name !== 'Desconocido' ? companero : null,
                diasSinJugar: diasSinJugar
            });
            
            // Extraer valores para el historial
            const cambioBase = resultado === 1 ? (diferenciaMarcador === 2 ? 12 : 8) : (diferenciaMarcador === 2 ? -10 : -6);
            const multiplicador = tipoPartido === 'liga' ? 1.25 : tipoPartido === 'reto' ? 1.0 : 0.6;
            
            // Calcular ajustes para el historial
            const nivelEquipo = (jugador.nivel + (companero?.nivel || jugador.nivel)) / 2;
            const nivelRivales = rivales.filter(r => r.name !== 'Desconocido').reduce((sum, r) => sum + r.nivel, 0) / rivales.filter(r => r.name !== 'Desconocido').length;
            const diferenciaNivel = nivelEquipo - nivelRivales;
            const ajusteDificultad = diferenciaNivel * (-8);
            
            const ajusteRacha = (jugador.racha >= 3 && resultado === 1) ? Math.min(5, jugador.racha * 0.7) : 
                               (jugador.racha <= -3 && resultado === 0) ? Math.max(-5, jugador.racha * 0.4) : 0;
            
            const ajusteExperiencia = Math.max(0, (30 - jugador.matches) * 0.1);
            const ajusteInactividad = diasSinJugar > 21 ? -Math.min(10, diasSinJugar * 0.1) : 0;
            
            // Actualizar datos del jugador
            jugador.puntosRanking = resultadoPuntuacion.nuevoPuntos;
            jugador.nivel = resultadoPuntuacion.nivel;
            jugador.matches++;
            
            if (resultado === 1) {
                jugador.wins++;
                jugador.racha = jugador.racha >= 0 ? jugador.racha + 1 : 1;
            } else {
                jugador.racha = jugador.racha <= 0 ? jugador.racha - 1 : -1;
            }
            
            jugador.setsWon += setsGanados;
            jugador.setsLost += setsPerdidos;
            jugador.lastPlayed = fecha;
            jugador.cambioPuntos = resultadoPuntuacion.cambioPuntos;
            
            // Guardar historial del partido
            if (!jugador.history) jugador.history = [];
            jugador.history.push({
                fecha: fecha,
                tipoPartido: tipoPartido,
                resultado: resultado,
                setsGanados: setsGanados,
                setsPerdidos: setsPerdidos,
                puntosRankingAntes: jugador.puntosRanking - resultadoPuntuacion.cambioPuntos,
                puntosRankingDespues: jugador.puntosRanking,
                nivelAntes: jugador.nivel - (resultadoPuntuacion.nivel - jugador.nivel),
                nivelDespues: jugador.nivel,
                desglose: [
                    { nombre: 'Tipo de partido', valor: tipoPartido.toUpperCase(), tipo: 'info' },
                    { nombre: 'Resultado base', valor: `${resultado === 1 ? '+' : ''}${cambioBase}`, tipo: resultado === 1 ? 'positive' : 'negative' },
                    { nombre: 'Dificultad rival', valor: `${ajusteDificultad >= 0 ? '+' : ''}${ajusteDificultad.toFixed(1)}`, tipo: ajusteDificultad >= 0 ? 'positive' : 'negative' },
                    { nombre: 'Ajuste racha', valor: `${ajusteRacha >= 0 ? '+' : ''}${ajusteRacha.toFixed(1)}`, tipo: ajusteRacha >= 0 ? 'positive' : 'negative' },
                    { nombre: 'Experiencia', valor: `${ajusteExperiencia >= 0 ? '+' : ''}${ajusteExperiencia.toFixed(1)}`, tipo: ajusteExperiencia >= 0 ? 'positive' : 'negative' },
                    { nombre: 'Inactividad', valor: `${ajusteInactividad >= 0 ? '+' : ''}${ajusteInactividad.toFixed(1)}`, tipo: ajusteInactividad >= 0 ? 'positive' : 'negative' },
                    { nombre: 'Multiplicador', valor: `x${multiplicador}`, tipo: 'info' },
                    { nombre: 'Total', valor: `${resultadoPuntuacion.cambioPuntos >= 0 ? '+' : ''}${resultadoPuntuacion.cambioPuntos.toFixed(1)}`, tipo: resultadoPuntuacion.cambioPuntos >= 0 ? 'positive' : 'negative' }
                ]
            });
        }

        // Actualizar estadísticas generales
        function actualizarEstadisticas() {
            if (state.players.length === 0) return;
            
            const jugadoresReales = state.players.filter(p => p.name !== 'Desconocido');
            const totalPlayers = jugadoresReales.length;
            const totalMatches = state.partidos.length;
            const avgLevel = jugadoresReales.reduce((sum, p) => sum + p.nivel, 0) / totalPlayers;
            const avgPoints = jugadoresReales.reduce((sum, p) => sum + p.puntosRanking, 0) / totalPlayers;
            
            // Encontrar mejor jugador
            const topPlayer = [...jugadoresReales].sort((a, b) => b.puntosRanking - a.puntosRanking)[0];
            const topLevel = [...jugadoresReales].sort((a, b) => b.nivel - a.nivel)[0];
            
            document.getElementById('totalPlayers').textContent = totalPlayers;
            document.getElementById('totalMatches').textContent = totalMatches;
            document.getElementById('avgLevel').textContent = avgLevel.toFixed(2);
            document.getElementById('avgPoints').textContent = Math.round(avgPoints);
            document.getElementById('topPlayer').textContent = topPlayer.name;
            document.getElementById('topLevel').textContent = topLevel.nivel.toFixed(2);
        }

        // Actualizar tabla de clasificación
        function actualizarClasificacion() {
            const tbody = document.getElementById('rankingBody');
            if (!tbody) return;
            
            // Ordenar jugadores por puntos de ranking (excluir fantasmas)
            const sortedPlayers = [...state.players]
                .filter(p => p.name !== 'Desconocido')
                .sort((a, b) => b.puntosRanking - a.puntosRanking);
            
            let html = '';
            sortedPlayers.forEach((player, index) => {
                // Calcular delta con posición anterior
                let delta = '';
                const lastPosition = state.lastRanking.findIndex(p => p.id === player.id);
                if (lastPosition !== -1) {
                    const positionChange = lastPosition - index;
                    if (positionChange > 0) {
                        delta = `<span class="positive">↑${positionChange}</span>`;
                    } else if (positionChange < 0) {
                        delta = `<span class="negative">↓${Math.abs(positionChange)}</span>`;
                    } else {
                        delta = `<span>→</span>`;
                    }
                }
                
                // Calcular win rate
                const winRate = player.matches > 0 ? Math.round((player.wins / player.matches) * 100) : 0;
                
                // Agregar iconos especiales para los primeros lugares
                let raquetaIcon = '';
                if (index === 0) raquetaIcon = '<i class="fas fa-trophy raqueta-oro" style="margin-right: 5px;"></i>';
                else if (index === 1) raquetaIcon = '<i class="fas fa-medal raqueta-plata" style="margin-right: 5px;"></i>';
                else if (index === 2) raquetaIcon = '<i class="fas fa-award raqueta-bronce" style="margin-right: 5px;"></i>';
                
                html += `
                    <tr data-id="${player.id}" onclick="mostrarHistorialJugador('${player.id}')" style="cursor: pointer;">
                        <td>${index + 1}</td>
                        <td>${raquetaIcon}${player.name}</td>
                        <td>${player.nivel.toFixed(2)}</td>
                        <td>${player.matches}</td>
                        <td>${player.wins}</td>
                        <td>${winRate}%</td>
                        <td class="puntos-elo">${Math.round(player.puntosRanking)}</td>
                        <td>${delta}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            
            // Guardar copia para próximos deltas
            state.lastRanking = JSON.parse(JSON.stringify(sortedPlayers));
        }

        // Actualizar últimos partidos
        function actualizarUltimosPartidos() {
            const container = document.getElementById('lastMatches');
            if (!container) return;
            
            // Tomar los últimos 5 partidos
            const ultimosPartidos = [...state.partidos].sort((a, b) => b.fecha - a.fecha).slice(0, 5);
            
            if (ultimosPartidos.length === 0) {
                container.innerHTML = '<div class="history-item">No hay partidos recientes</div>';
                return;
            }
            
            let html = '';
            ultimosPartidos.forEach(partido => {
                const fecha = partido.fecha.toLocaleDateString('es-ES');
                let jugadoresLocal = [];
                let jugadoresVisitante = [];
                
                if (partido.tipo === 'liga') {
                    jugadoresLocal = obtenerJugadoresEquipo(partido.equipoLocalId).map(j => j.name);
                    jugadoresVisitante = obtenerJugadoresEquipo(partido.equipoVisitanteId).map(j => j.name);
                } else {
                    jugadoresLocal = partido.jugadores.slice(0, 2).map(id => {
                        const j = state.players.find(p => p.id === id);
                        return j ? j.name : 'Desconocido';
                    });
                    
                    jugadoresVisitante = partido.jugadores.slice(2, 4).map(id => {
                        const j = state.players.find(p => p.id === id);
                        return j ? j.name : 'Desconocido';
                    });
                }
                
                const sets = partido.resultado ? [
                    partido.resultado.set1,
                    partido.resultado.set2,
                    partido.resultado.set3
                ].filter(s => s).map(s => `${s.puntos1}-${s.puntos2}`).join(', ') : 'Sin resultado';
                
                // Calcular impacto en puntos
                let jugadoresIds = [];
                if (partido.tipo === 'liga') {
                    jugadoresIds = [
                        ...obtenerJugadoresEquipo(partido.equipoLocalId).map(j => j.id),
                        ...obtenerJugadoresEquipo(partido.equipoVisitanteId).map(j => j.id)
                    ];
                } else {
                    jugadoresIds = [...partido.jugadores];
                }
                
                const cambios = jugadoresIds.map(id => {
                    const j = state.players.find(p => p.id === id);
                    return j ? j.cambioPuntos : 0;
                });
                
                html += `
                    <div class="history-item">
                        <div class="history-title">${fecha} • ${partido.tipo.toUpperCase()}</div>
                        <div class="history-details">
                            <div>
                                <span class="history-label">Local:</span>
                                <span class="history-value">${jugadoresLocal.join(' & ')}</span>
                            </div>
                            <div>
                                <span class="history-label">Visitante:</span>
                                <span class="history-value">${jugadoresVisitante.join(' & ')}</span>
                            </div>
                            <div>
                                <span class="history-label">Resultado:</span>
                                <span class="history-value">${sets}</span>
                            </div>
                            <div>
                                <span class="history-label">Cambio puntos:</span>
                                <span class="history-value">${cambios.map(c => c > 0 ? '+' + c.toFixed(1) : c.toFixed(1)).join(' / ')}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Reiniciar estadísticas (manteniendo niveles originales)
        async function reiniciarEstadisticas() {
            if (!confirm("¿Estás seguro de que quieres reiniciar todas las estadísticas? Esta acción no se puede deshacer.")) {
                return;
            }
            
            updateStatus("Reiniciando estadísticas...", true);
            
            try {
                // Verificar autenticación
                if (!window.firebase || !window.firebase.auth || !window.firebase.auth.currentUser) {
                    throw new Error("Se requiere autenticación para reiniciar estadísticas");
                }
                
                const { doc, updateDoc, getDoc } = await import('https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js');
                
                // Reiniciar todos los jugadores manteniendo sus niveles originales
                const jugadoresReales = state.players.filter(p => p.name !== 'Desconocido');
                
                for (const jugador of jugadoresReales) {
                    // Obtener el nivel original del usuario
                    const userDoc = await getDoc(doc(window.firebase.db, 'usuarios', jugador.id));
                    const nivelOriginal = userDoc.exists() ? userDoc.data().nivel || 2.0 : 2.0;
                    
                    const jugadorRef = doc(window.firebase.db, 'usuarios', jugador.id);
                    await updateDoc(jugadorRef, {
                        nivel: nivelOriginal, // Mantener nivel original
                        puntosRanking: 700,
                        matches: 0,
                        wins: 0,
                        setsWon: 0,
                        setsLost: 0,
                        racha: 0,
                        lastPlayed: null,
                        ultimaActualizacion: new Date()
                    });
                }
                
                // Recargar datos
                await cargarDatosAutomaticamente();
                
                updateStatus(`Estadísticas reiniciadas para ${jugadoresReales.length} jugadores (niveles mantenidos)`);
                console.log(`✅ Estadísticas reiniciadas para ${jugadoresReales.length} jugadores`);
            } catch (error) {
                updateStatus("Error al reiniciar estadísticas: " + error.message);
                console.error('❌ Error al reiniciar estadísticas:', error);
            }
        }

        // Editar niveles de jugadores
        async function editarNiveles() {
            if (!confirm("¿Quieres entrar en modo edición de niveles? Podrás ajustar el nivel de cada jugador.")) {
                return;
            }
            
            try {
                // Crear modal de edición
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                
                const jugadoresReales = state.players.filter(p => p.name !== 'Desconocido');
                
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                        <div class="modal-header">
                            <h2>Editar Niveles de Jugadores</h2>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <p>Modifica los niveles de los jugadores. Los cambios se guardarán automáticamente.</p>
                        </div>
                        <div style="display: grid; gap: 10px;">
                            ${jugadoresReales.map((jugador, index) => `
                                <div style="display: flex; align-items: center; gap: 15px; padding: 10px; background: rgba(44, 62, 80, 0.3); border-radius: 8px;">
                                    <div style="flex: 1;">
                                        <strong>${jugador.name}</strong>
                                        <div style="font-size: 0.9rem; color: #bdc3c7;">ID: ${jugador.id}</div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <label style="font-size: 0.9rem;">Nivel:</label>
                                        <input type="number" 
                                               step="0.01" 
                                               min="2.0" 
                                               max="5.0" 
                                               value="${jugador.nivel.toFixed(2)}" 
                                               style="width: 80px; padding: 5px; border-radius: 4px; border: 1px solid #34495e; background: rgba(44, 62, 80, 0.7); color: white;"
                                               onchange="actualizarNivelJugador('${jugador.id}', this.value)">
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div style="margin-top: 20px; text-align: center;">
                            <button onclick="this.closest('.modal').remove()" style="background: var(--accent); color: var(--primary); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                                Cerrar
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Cerrar modal al hacer clic fuera
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
            } catch (error) {
                console.error('❌ Error al abrir editor de niveles:', error);
                alert('Error al abrir el editor de niveles: ' + error.message);
            }
        }

        // Función para actualizar nivel de un jugador
        async function actualizarNivelJugador(jugadorId, nuevoNivel) {
            try {
                const nivel = parseFloat(nuevoNivel);
                if (isNaN(nivel) || nivel < 2.0 || nivel > 5.0) {
                    alert('El nivel debe estar entre 2.0 y 5.0');
                    return;
                }
                
                const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js');
                
                const jugadorRef = doc(window.firebase.db, 'usuarios', jugadorId);
                await updateDoc(jugadorRef, {
                    nivel: nivel,
                    ultimaActualizacion: new Date()
                });
                
                // Actualizar estado local
                const jugador = state.players.find(p => p.id === jugadorId);
                if (jugador) {
                    jugador.nivel = nivel;
                }
                
                console.log(`✅ Nivel actualizado para ${jugadorId}: ${nivel}`);
                
                // Actualizar UI
                actualizarClasificacion();
                
            } catch (error) {
                console.error('❌ Error al actualizar nivel:', error);
                alert('Error al actualizar nivel: ' + error.message);
            }
        }

        // Ejecutar diagnóstico
        function ejecutarDiagnostico() {
            if (state.players.length === 0) {
                updateStatus("Primero cargue y procese los datos");
                return;
            }
            
            let diagnosticResults = "🔍 DIAGNÓSTICO DEL SISTEMA ATP:\n\n";
            
            // Estadísticas básicas
            const jugadoresReales = state.players.filter(p => p.name !== 'Desconocido');
            diagnosticResults += "📊 ESTADÍSTICAS GENERALES:\n";
            diagnosticResults += `- Jugadores: ${jugadoresReales.length}\n`;
            diagnosticResults += `- Nivel promedio: ${(jugadoresReales.reduce((s, p) => s + p.nivel, 0) / jugadoresReales.length).toFixed(4)}\n`;
            
            // Distribución de niveles
            diagnosticResults += "\n📈 DISTRIBUCIÓN DE NIVELES:\n";
            const niveles = [2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0];
            niveles.forEach((nivel, i) => {
                const next = niveles[i+1] || 5.5;
                const count = jugadoresReales.filter(p => p.nivel >= nivel && p.nivel < next).length;
                diagnosticResults += `- ${nivel.toFixed(1)}-${next.toFixed(1)}: ${count} jugadores\n`;
            });
            
            // Top jugadores
            const topRanking = [...jugadoresReales].sort((a, b) => b.puntosRanking - a.puntosRanking).slice(0, 3);
            diagnosticResults += "\n🏆 TOP 3 POR PUNTOS:\n";
            topRanking.forEach((p, i) => {
                diagnosticResults += `  ${i+1}. ${p.name}: ${Math.round(p.puntosRanking)} pts (nivel ${p.nivel.toFixed(4)})\n`;
            });
            
            // Jugadores con mayor progreso/receso
            const mayorProgreso = [...jugadoresReales].sort((a, b) => b.cambioPuntos - a.cambioPuntos).slice(0, 3);
            const mayorReceso = [...jugadoresReales].sort((a, b) => a.cambioPuntos - b.cambioPuntos).slice(0, 3);
            
            diagnosticResults += "\n📈 MAYOR PROGRESO (ÚLTIMO PROCESO):\n";
            mayorProgreso.forEach((p, i) => {
                diagnosticResults += `  ${i+1}. ${p.name}: +${p.cambioPuntos.toFixed(1)} pts\n`;
            });
            
            diagnosticResults += "\n📉 MAYOR RECESO (ÚLTIMO PROCESO):\n";
            mayorReceso.forEach((p, i) => {
                diagnosticResults += `  ${i+1}. ${p.name}: ${p.cambioPuntos.toFixed(1)} pts\n`;
            });
            
            alert(diagnosticResults);
            updateStatus("Diagnóstico ATP ejecutado. Ver resultados en el alert.");
        }

        // Variables globales para el modal
        let currentPlayer = null;
        let currentMatchIndex = 0;

        // Mostrar historial de jugador al hacer clic en una fila
        function mostrarHistorialJugador(playerId) {
            // Buscar el jugador por ID en el estado
            const player = state.players.find(p => p.id === playerId);
            if (!player) {
                console.error('❌ Jugador no encontrado:', playerId);
                return;
            }
            
            currentPlayer = player;
            currentMatchIndex = 0;
            
            // Mostrar el modal
            const modal = document.getElementById('playerModal');
            modal.style.display = 'block';
            
            // Actualizar información del jugador
            document.getElementById('modalPlayerName').textContent = player.name;
            document.getElementById('modalPlayerLevel').textContent = `Nivel ${player.nivel.toFixed(2)}`;
            document.getElementById('modalPlayerPoints').textContent = `${Math.round(player.puntosRanking)} pts`;
            document.getElementById('modalMatches').textContent = player.matches;
            document.getElementById('modalWins').textContent = player.wins;
            document.getElementById('modalSets').textContent = `${player.setsWon}-${player.setsLost}`;
            document.getElementById('modalWinRate').textContent = player.matches > 0 ? `${Math.round((player.wins / player.matches) * 100)}%` : '0%';
            
            // Mostrar primer partido si existe historial
            if (player.history && player.history.length > 0) {
                mostrarPartidoDetalle(0);
            } else {
                document.getElementById('matchDetails').innerHTML = '<p style="text-align: center; color: #bdc3c7;">No hay historial de partidos disponible.</p>';
                document.getElementById('matchFactors').innerHTML = '';
                document.getElementById('matchCounter').textContent = 'Sin partidos';
                document.getElementById('prevMatch').disabled = true;
                document.getElementById('nextMatch').disabled = true;
            }
        }

        // Función para mostrar detalles de un partido específico
        function mostrarPartidoDetalle(index) {
            if (!currentPlayer || !currentPlayer.history || currentPlayer.history.length === 0) return;
            
            const partido = currentPlayer.history[index];
            currentMatchIndex = index;
            
            // Actualizar contador
            document.getElementById('matchCounter').textContent = `Partido ${index + 1} de ${currentPlayer.history.length}`;
            
            // Habilitar/deshabilitar botones de navegación
            document.getElementById('prevMatch').disabled = index === 0;
            document.getElementById('nextMatch').disabled = index === currentPlayer.history.length - 1;
            
            // Calcular cambios
            const cambioRanking = partido.puntosRankingDespues - partido.puntosRankingAntes;
            const cambioNivel = partido.nivelDespues - partido.nivelAntes;
            
            // Determinar si subió o bajó de nivel
            let nivelChange = '';
            if (cambioNivel > 0) {
                nivelChange = '🔼 Subió de nivel';
            } else if (cambioNivel < 0) {
                nivelChange = '🔽 Bajó de nivel';
            } else {
                nivelChange = '➡️ Sin cambio de nivel';
            }
            
            // Asegurar que la fecha sea un objeto Date válido
            let fechaPartido;
            if (partido.fecha instanceof Date) {
                fechaPartido = partido.fecha;
            } else if (typeof partido.fecha === 'string') {
                fechaPartido = new Date(partido.fecha);
            } else if (partido.fecha && partido.fecha.toDate) {
                // Si es un timestamp de Firebase
                fechaPartido = partido.fecha.toDate();
            } else {
                fechaPartido = new Date();
            }
            
            // Mostrar detalles del partido
            document.getElementById('matchDetails').innerHTML = `
                <div class="match-stat">
                    <span class="stat-label">Fecha</span>
                    <span class="stat-value">${fechaPartido.toLocaleDateString('es-ES')}</span>
                </div>
                <div class="match-stat">
                    <span class="stat-label">Tipo</span>
                    <span class="stat-value">${partido.tipoPartido.toUpperCase()}</span>
                </div>
                <div class="match-stat">
                    <span class="stat-label">Resultado</span>
                    <span class="stat-value">${partido.resultado === 1 ? 'Victoria' : 'Derrota'}</span>
                </div>
                <div class="match-stat">
                    <span class="stat-label">Sets</span>
                    <span class="stat-value">${partido.setsGanados}-${partido.setsPerdidos}</span>
                </div>
                <div class="match-stat">
                    <span class="stat-label">Cambio Puntos</span>
                    <span class="stat-value ${cambioRanking >= 0 ? 'positive' : 'negative'}">${cambioRanking >= 0 ? '+' : ''}${cambioRanking.toFixed(1)}</span>
                </div>
                <div class="match-stat">
                    <span class="stat-label">Cambio Nivel</span>
                    <span class="stat-value">${cambioNivel >= 0 ? '+' : ''}${cambioNivel.toFixed(4)}</span>
                </div>
                <div class="match-stat">
                    <span class="stat-label">Estado Nivel</span>
                    <span class="stat-value">${nivelChange}</span>
                </div>
            `;
            
            // Mostrar desglose de puntos
            mostrarDesglosePuntos(partido);
        }

        // Mostrar desglose de puntos
        function mostrarDesglosePuntos(partido) {
            const desglose = partido.desglose || [];
            let html = '<div class="factors-list">';
            
            desglose.forEach(factor => {
                const tipo = factor.tipo || 'info';
                let clase = '';
                
                if (tipo === 'positive') clase = 'positive';
                else if (tipo === 'negative') clase = 'negative';
                
                html += `
                    <div class="factor-item">
                        <span class="factor-nombre">${factor.nombre}</span>
                        <span class="factor-valor ${clase}">${factor.valor}</span>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('matchFactors').innerHTML = html;
        }

        // Inicializar eventos
        function inicializarEventos() {
            document.getElementById('diagnosticBtn').addEventListener('click', ejecutarDiagnostico);
            document.getElementById('resetBtn').addEventListener('click', reiniciarEstadisticas);
            document.getElementById('editLevelBtn').addEventListener('click', editarNiveles);
            
            // Eventos del modal
            document.querySelector('.close-modal').addEventListener('click', () => {
                document.getElementById('playerModal').style.display = 'none';
            });
            
            // Cerrar modal al hacer clic fuera
            window.addEventListener('click', (event) => {
                if (event.target === document.getElementById('playerModal')) {
                    document.getElementById('playerModal').style.display = 'none';
                }
            });
            
            // Navegación entre partidos
            document.getElementById('prevMatch').addEventListener('click', () => {
                if (currentMatchIndex > 0) {
                    mostrarPartidoDetalle(currentMatchIndex - 1);
                }
            });
            
            document.getElementById('nextMatch').addEventListener('click', () => {
                if (currentPlayer && currentPlayer.history && currentMatchIndex < currentPlayer.history.length - 1) {
                    mostrarPartidoDetalle(currentMatchIndex + 1);
                }
            });
        }

        // Debug del header
        function debugHeader() {
            console.log('🔍 DEBUG DEL HEADER:');
            console.log('===================');
            
            const header = document.querySelector('.app-header');
            const logo = document.querySelector('.app-logo');
            const title = document.querySelector('.app-title');
            const menuToggle = document.querySelector('.menu-toggle');
            const nav = document.querySelector('.app-nav');
            
            console.log('Header encontrado:', header);
            console.log('Logo encontrado:', logo);
            console.log('Título encontrado:', title);
            console.log('Menu toggle encontrado:', menuToggle);
            console.log('Nav encontrado:', nav);
            
            if (logo) {
                console.log('Logo src:', logo.src);
                console.log('Logo width:', logo.width);
                console.log('Logo height:', logo.height);
                console.log('Logo computed style:', window.getComputedStyle(logo));
            }
            
            if (header) {
                console.log('Header background:', window.getComputedStyle(header).background);
                console.log('Header position:', window.getComputedStyle(header).position);
                console.log('Header z-index:', window.getComputedStyle(header).zIndex);
            }
            
            if (nav) {
                console.log('Nav position:', window.getComputedStyle(nav).position);
                console.log('Nav left:', window.getComputedStyle(nav).left);
                console.log('Nav transform:', window.getComputedStyle(nav).transform);
            }
            
            // Verificar si el script del menú se cargó
            console.log('Menu hamburguesa script cargado:', typeof window.menuHamburguesaLoaded !== 'undefined');
        }

        // Verificar si el usuario es admin y mostrar controles
        async function verificarAdminYMostrarControles() {
            try {
                // Esperar a que enlaceAdmin.js se cargue
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Verificar si el usuario es admin
                const user = window.firebase?.auth?.currentUser;
                if (!user) {
                    console.log('❌ Usuario no autenticado en verificación admin');
                    return;
                }
                
                const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js');
                const userDoc = await getDoc(doc(window.firebase.db, 'usuarios', user.uid));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const isAdmin = userData.rol === 'Admin';
                    
                    const adminControls = document.getElementById('adminControls');
                    if (adminControls) {
                        adminControls.style.display = isAdmin ? 'flex' : 'none';
                        console.log(`🔐 Controles admin ${isAdmin ? 'mostrados' : 'ocultos'} para usuario: ${userData.nombreUsuario || user.email}`);
                    }
                } else {
                    console.log('❌ Documento de usuario no encontrado');
                }
            } catch (error) {
                console.error('❌ Error al verificar admin:', error);
            }
        }

        // Función para esperar a que Firebase esté listo
        async function esperarFirebase() {
            let attempts = 0;
            const maxAttempts = 100; // 10 segundos máximo
            
            while (attempts < maxAttempts) {
                if (window.firebase?.auth && window.getDocs && window.collection) {
                    console.log('✅ Firebase está listo');
                    return true;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            console.error('❌ Firebase no se inicializó en el tiempo esperado');
            return false;
        }

        // Iniciar aplicación
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Ranking ATP cargado');
            inicializarEventos();
            
            // Esperar a que Firebase esté completamente inicializado
            setTimeout(async () => {
                try {
                    const firebaseReady = await esperarFirebase();
                    if (!firebaseReady) {
                        updateStatus("Error: Firebase no se pudo inicializar. Recargando página...");
                        setTimeout(() => window.location.reload(), 3000);
                        return;
                    }
                    
                    // Cargar datos automáticamente
                    await cargarDatosAutomaticamente();
                    
                    // Verificar admin y mostrar controles
                    await verificarAdminYMostrarControles();
                    
                    // Debug después de un pequeño delay para asegurar que todo esté cargado
                    setTimeout(debugHeader, 1000);
                } catch (error) {
                    console.error('❌ Error en inicialización:', error);
                    updateStatus("Error en la inicialización: " + error.message);
                }
            }, 1000);
        });
    </script>
    <script src="./js/menu-hamburguesa.js"></script>
    <script>
        // Script adicional para asegurar que el menú funcione
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔧 Script adicional del menú cargado');
            
            // Verificar si el menú hamburguesa se inicializó correctamente
            setTimeout(function() {
                const menuToggle = document.querySelector('.menu-toggle');
                const appNav = document.querySelector('.app-nav');
                
                if (menuToggle && appNav) {
                    console.log('✅ Elementos del menú encontrados');
                    
                    // Agregar overlay si no existe
                    if (!document.querySelector('.nav-overlay')) {
                        const overlay = document.createElement('div');
                        overlay.className = 'nav-overlay';
                        overlay.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0, 0, 0, 0.5);
                            backdrop-filter: blur(3px);
                            z-index: 998;
                            opacity: 0;
                            visibility: hidden;
                            transition: all 0.3s ease;
                        `;
                        document.body.appendChild(overlay);
                        console.log('✅ Overlay creado');
                    }
                    
                    // Función de toggle personalizada
                    function toggleMenu() {
                        const isOpen = appNav.classList.contains('active');
                        const overlay = document.querySelector('.nav-overlay');
                        
                        if (isOpen) {
                            appNav.classList.remove('active');
                            if (overlay) {
                                overlay.style.opacity = '0';
                                overlay.style.visibility = 'hidden';
                            }
                            document.body.style.overflow = 'auto';
                            console.log('🔒 Menú cerrado');
                        } else {
                            appNav.classList.add('active');
                            if (overlay) {
                                overlay.style.opacity = '1';
                                overlay.style.visibility = 'visible';
                            }
                            document.body.style.overflow = 'hidden';
                            console.log('🔓 Menú abierto');
                        }
                    }
                    
                    // Event listeners adicionales
                    menuToggle.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        toggleMenu();
                    });
                    
                    const overlay = document.querySelector('.nav-overlay');
                    if (overlay) {
                        overlay.addEventListener('click', toggleMenu);
                    }
                    
                    // Cerrar con Escape
                    document.addEventListener('keydown', function(e) {
                        if (e.key === 'Escape' && appNav.classList.contains('active')) {
                            toggleMenu();
                        }
                    });
                    
                    console.log('✅ Event listeners adicionales configurados');
                } else {
                    console.error('❌ Elementos del menú no encontrados');
                }
            }, 500);
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <link rel="icon" type="image/x-icon" href="./imagenes/Logojafs.png">
    <title>Simulador Visual Real - Ranking Pádel</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap');

        :root {
            --primary-color: #E9C46A;
            --secondary-color: #2A9D8F;
            --accent-color: #E76F51;
            --dark-accent: #264653;
            --gradient-gold: linear-gradient(135deg, #FFD700, #E0B200);
            --row-bg: rgba(32, 35, 42, 0.95);
            --row-alt-bg: rgba(25, 28, 35, 0.95);
            --row-hover: rgba(35, 38, 46, 0.98);
            --border-color: rgba(35, 38, 46, 0.5);
            --cell-bg: rgba(35, 38, 46, 0.8);
            --cell-alt-bg: rgba(28, 30, 37, 0.8);
            --points-bg: rgba(191, 161, 58, 0.15);
            --points-text: #FFD700;
            --points-glow: 0 0 15px rgba(255, 215, 0, 0.3);
            --team-color: #eaf6ff;
            --team-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            --title-gradient: linear-gradient(90deg, #FFD700 0%, #E0B200 100%);
            --title-glow: 0 0 20px rgba(255, 215, 0, 0.2);
            --text-color: #e5e5e5;
            --font-main: 'Montserrat', 'Poppins', sans-serif;
            --leader-bg: rgba(255, 215, 0, 0.15);
            --top4-bg: rgba(191, 161, 58, 0.08);
            --relegation-bg: rgba(231, 111, 81, 0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: var(--text-color);
            font-family: var(--font-main);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            overflow: hidden;
            padding-top: 20px;
            margin-top: 20px;
        }

        .page-header {
            text-align: center;
            padding: 20px;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        .page-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            background: var(--title-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: var(--title-glow);
        }

        .page-header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
            max-width: 100%;
            overflow: hidden;
        }

        .panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.15);
            max-width: 100%;
            overflow: hidden;
        }

        .panel-title {
            font-size: 1.5rem;
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }

        .panel-title i {
            margin-right: 10px;
        }

        .tabla-responsive-wrapper {
            position: relative;
            z-index: 2;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            background: rgba(18, 20, 25, 0.95);
            max-width: 100%;
            width: 100%;
            padding-bottom: 1px;
        }

        .ranking-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 4px;
            margin: 1rem auto;
            background: rgba(18, 20, 25, 0.95);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            table-layout: fixed;
        }

        .ranking-table th {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.3));
            padding: 1rem 0.6rem;
            text-align: center;
            font-weight: 700;
            font-size: 0.9rem;
            white-space: nowrap;
            color: var(--primary-color);
            border-bottom: 3px solid rgba(255, 255, 255, 0.15);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            letter-spacing: 0.5px;
        }

        .ranking-table th:hover {
            background: rgba(0, 0, 0, 0.4);
            color: var(--points-text);
        }

        /* Distribución elegante y equilibrada de columnas */
        .ranking-table {
            width: 100%;
            table-layout: fixed;
            border-spacing: 0;
            border-collapse: separate;
        }

        .ranking-table th:nth-child(1),
        .ranking-table td:nth-child(1) {
            width: 8%;
            min-width: 8%;
            max-width: 8%;
        }

        .ranking-table th:nth-child(2),
        .ranking-table td:nth-child(2) {
            width: 28%;
            min-width: 28%;
            max-width: 28%;
        }

        .ranking-table th:nth-child(3),
        .ranking-table td:nth-child(3) {
            width: 12%;
            min-width: 12%;
            max-width: 12%;
        }

        .ranking-table th:nth-child(4),
        .ranking-table td:nth-child(4) {
            width: 10%;
            min-width: 10%;
            max-width: 10%;
        }

        .ranking-table th:nth-child(5),
        .ranking-table td:nth-child(5) {
            width: 10%;
            min-width: 10%;
            max-width: 10%;
        }

        .ranking-table th:nth-child(6),
        .ranking-table td:nth-child(6) {
            width: 10%;
            min-width: 10%;
            max-width: 10%;
        }

        .ranking-table th:nth-child(7),
        .ranking-table td:nth-child(7) {
            width: 22%;
            min-width: 22%;
            max-width: 22%;
        }

        .ranking-table td {
            padding: 0.8rem 0.6rem;
            border-bottom: none;
            font-size: 0.95rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            height: auto;
            vertical-align: middle;
            text-align: center;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            transition: all 0.3s ease;
            border-radius: 0;
            position: relative;
        }

        /* Fondos por filas completas en lugar de columnas individuales */
        .ranking-table tr:nth-child(odd) td {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
        }

        .ranking-table tr:nth-child(even) td {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
        }

        /* Excepciones para columnas específicas */
        .ranking-table td:nth-child(1) {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(191, 161, 58, 0.08));
            font-weight: 700;
            color: var(--primary-color);
        }

        .ranking-table td:nth-child(7) {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(191, 161, 58, 0.08));
            font-weight: 700;
            color: var(--points-text);
            font-size: 0.65rem !important;
        }

        /* Centrar específicamente la columna de puntos */
        .ranking-table td:nth-child(7) {
            text-align: center;
            padding: 0.8rem 0.6rem;
        }

        .ranking-table tr {
            height: auto;
            transition: all 0.3s ease;
        }

        .ranking-table tr:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .ranking-table tr:hover td {
            color: #ffffff;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.08));
        }

        .ranking-table tr:hover td:nth-child(1) {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(191, 161, 58, 0.1));
        }

        .ranking-table tr:hover td:nth-child(7) {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.25), rgba(191, 161, 58, 0.15));
        }

        .ranking-table td:nth-child(2) {
            text-align: left;
            padding-left: 0.8rem;
            white-space: normal;
            word-wrap: break-word;
            overflow: visible;
        }

        /* Ajustar padding de columnas numéricas para mejor centrado */
        .ranking-table td:nth-child(1),
        .ranking-table td:nth-child(3),
        .ranking-table td:nth-child(4),
        .ranking-table td:nth-child(5),
        .ranking-table td:nth-child(6) {
            text-align: center;
            padding: 0.8rem 0.4rem;
        }

        /* Top 3 con medallas y fondos cristalinos más fuertes */
        .ranking-table tr:nth-child(1) {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.35), rgba(191, 161, 58, 0.25));
            border-left: 4px solid #FFD700;
            backdrop-filter: blur(10px);
        }

        .ranking-table tr:nth-child(1) td:nth-child(2)::before {
            content: "🥇 ";
            margin-right: 8px;
            font-size: 1.2em;
            animation: medalGlow 2s ease-in-out infinite alternate;
        }

        .ranking-table tr:nth-child(2) {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.35), rgba(169, 169, 169, 0.25));
            border-left: 4px solid #C0C0C0;
            backdrop-filter: blur(10px);
        }

        .ranking-table tr:nth-child(2) td:nth-child(2)::before {
            content: "🥈 ";
            margin-right: 8px;
            font-size: 1.2em;
            animation: medalGlow 2s ease-in-out infinite alternate;
        }

        .ranking-table tr:nth-child(3) {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.35), rgba(184, 115, 51, 0.25));
            border-left: 4px solid #CD7F32;
            backdrop-filter: blur(10px);
        }

        .ranking-table tr:nth-child(3) td:nth-child(2)::before {
            content: "🥉 ";
            margin-right: 8px;
            font-size: 1.2em;
            animation: medalGlow 2s ease-in-out infinite alternate;
        }

        /* Top 10 (posiciones 4-10) con fondo cristalino */
        .ranking-table tr:nth-child(n+4):nth-child(-n+10) {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.15), rgba(41, 128, 185, 0.1));
            backdrop-filter: blur(8px);
            border-left: 3px solid #3498db;
        }

        /* Top 20 (posiciones 11-20) con fondo cristalino */
        .ranking-table tr:nth-child(n+11):nth-child(-n+20) {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.15), rgba(39, 174, 96, 0.1));
            backdrop-filter: blur(8px);
            border-left: 3px solid #2ecc71;
        }

        /* Top 30 (posiciones 21-30) con fondo cristalino */
        .ranking-table tr:nth-child(n+21):nth-child(-n+30) {
            background: linear-gradient(135deg, rgba(155, 89, 182, 0.15), rgba(142, 68, 173, 0.1));
            backdrop-filter: blur(8px);
            border-left: 3px solid #9b59b6;
        }

        /* Resto de jugadores con raquetas animadas */
        .ranking-table tr:nth-child(n+4) td:nth-child(2)::before {
            content: "🎾 ";
            margin-right: 8px;
            font-size: 1em;
            animation: racketColor 3s ease-in-out infinite;
        }

        /* Animaciones */
        @keyframes medalGlow {
            0% { 
                filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5));
                transform: scale(1);
            }
            100% { 
                filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.8));
                transform: scale(1.1);
            }
        }

        @keyframes racketColor {
            0% { 
                filter: hue-rotate(0deg) brightness(1);
                transform: rotate(0deg);
            }
            25% { 
                filter: hue-rotate(90deg) brightness(1.2);
                transform: rotate(5deg);
            }
            50% { 
                filter: hue-rotate(180deg) brightness(1);
                transform: rotate(0deg);
            }
            75% { 
                filter: hue-rotate(270deg) brightness(1.2);
                transform: rotate(-5deg);
            }
            100% { 
                filter: hue-rotate(360deg) brightness(1);
                transform: rotate(0deg);
            }
        }

        .ranking-table td:first-child {
            border-top-left-radius: 6px;
            border-bottom-left-radius: 6px;
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
            min-width: 40px;
            background: var(--leader-bg);
        }

        .ranking-table td:last-child {
            border-top-right-radius: 6px;
            border-bottom-right-radius: 6px;
            background: var(--points-bg);
            color: var(--points-text);
            font-weight: 700;
            font-size: 0.65rem !important;
            text-align: center;
            padding: 0.6rem 0.4rem;
            border-radius: 6px;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            position: relative;
            overflow: hidden;
            display: table-cell;
            box-shadow: var(--points-glow);
        }

        .ranking-table td:last-child::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.2), transparent);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: 100%; }
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #0f1419, #1a2a6c, #2c3e50);
            margin: 2% auto;
            padding: 0;
            border-radius: 20px;
            width: 95%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.7);
            border: 3px solid rgba(255, 215, 0, 0.3);
            position: relative;
            backdrop-filter: blur(15px);
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            height: calc(90vh - 100px);
        }

        .player-stats-grid {
            margin-top: 30px;
            padding: 20px 25px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2));
            border-radius: 15px;
            border: 2px solid rgba(255, 215, 0, 0.15);
        }
        
        .player-stats-grid h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.3rem;
            text-shadow: 0 0 15px rgba(241, 196, 15, 0.6);
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.06));
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            border: 2px solid rgba(255, 215, 0, 0.2);
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 215, 0, 0.4);
        }

        .stat-icon {
            font-size: 1.2rem;
            margin-bottom: 6px;
            filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.3));
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 4px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .stat-label {
            font-size: 0.7rem;
            color: #e5e5e5;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
        }

        .match-history {
            padding: 20px 25px;
            flex: 1;
            overflow-y: auto;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.5));
            border-top: 3px solid rgba(255, 215, 0, 0.2);
        }

        .match-history h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.3rem;
            text-shadow: 0 0 15px rgba(241, 196, 15, 0.6);
            font-weight: 700;
            letter-spacing: 1px;
        }

        .match-details {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid rgba(255, 215, 0, 0.15);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
        }

        .match-details div {
            margin-bottom: 8px;
            font-size: 0.95rem;
            color: #e5e5e5;
            line-height: 1.6;
        }

        .match-details b {
            color: var(--primary-color);
            font-weight: 700;
        }

        .match-factors {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(255, 215, 0, 0.15);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
        }

        .match-factors h4 {
            color: var(--primary-color);
            font-size: 1.1rem;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(241, 196, 15, 0.3);
        }

        .match-factors ul {
            list-style: none;
            padding: 0;
        }

        .match-factors li {
            margin-bottom: 8px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border-left: 3px solid rgba(255, 215, 0, 0.3);
            font-size: 0.9rem;
        }

        .match-factors b {
            color: var(--primary-color);
            font-weight: 700;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            right: 20px;
            top: 15px;
            z-index: 10;
            cursor: pointer;
            transition: color 0.3s;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .close:hover {
            color: var(--primary-color);
            background: rgba(0, 0, 0, 0.7);
            border-color: var(--primary-color);
            transform: scale(1.1);
        }

        .modal-header {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(191, 161, 58, 0.08));
            padding: 30px 35px 25px;
            border-radius: 20px 20px 0 0;
            border-bottom: 2px solid rgba(255, 215, 0, 0.2);
            position: relative;
        }

        .modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #FFD700, #E0B200, #FFD700);
            border-radius: 20px 20px 0 0;
        }

        .modal-header h2 {
            margin: 0 0 20px 0;
            color: var(--primary-color);
            font-size: 2rem;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            font-weight: 700;
        }

        .player-badge {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .level-badge, .points-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            text-align: center;
            min-width: 80px;
        }

        .level-badge {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: 1px solid #3498db;
        }

        .points-badge {
            background: var(--gradient-gold);
            color: #2c3e50;
            border: 1px solid var(--primary-color);
        }

        .match-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(191, 161, 58, 0.05));
            padding: 18px 20px;
            border-radius: 12px;
            border: 2px solid rgba(255, 215, 0, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .nav-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: linear-gradient(135deg, #2980b9, #1f5f8b);
            transform: scale(1.05);
        }

        .nav-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        #matchCounter {
            color: var(--primary-color);
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .panel {
                padding: 10px;
            }
            
            .ranking-table {
                min-width: 100%;
                font-size: 0.7rem;
            }
            
            .ranking-table th,
            .ranking-table td {
                padding: 6px 3px;
                font-size: 0.7rem;
            }
            
            .page-header h1 {
                font-size: 1.8rem;
            }
            
            .page-header .subtitle {
                font-size: 0.9rem;
            }
            
            .modal-content {
                width: 98%;
                margin: 1% auto;
                max-height: 95vh;
            }
            
            .player-stats-grid {
                height: 20vh;
                max-height: 100px;
                padding: 6px 12px;
            }
            
            .stat-card {
                padding: 6px;
            }
            
            .stat-icon {
                font-size: 0.9rem;
            }
            
            .stat-value {
                font-size: 0.8rem;
            }
            
            .stat-label {
                font-size: 0.55rem;
            }
            
            .match-history {
                padding: 10px 12px;
            }
            
            .match-history h3 {
                font-size: 1rem;
            }
            
            .match-details,
            .match-factors {
                padding: 12px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .container {
                padding-top: 5px;
            }
            
            .panel {
                padding: 8px;
            }
            
            .ranking-table {
                font-size: 0.65rem;
            }
            
            .ranking-table th,
            .ranking-table td {
                padding: 4px 2px;
                font-size: 0.65rem;
            }
        }

        .comparison-panel {
            margin-top: 30px;
        }

        .comparison-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            align-items: end;
        }

        .player-selector {
            flex: 1;
            min-width: 200px;
        }

        .player-selector label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .player-select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            color: var(--text-color);
            font-size: 0.95rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .player-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        .player-select option {
            background: rgba(0, 0, 0, 0.9);
            color: var(--text-color);
        }

        .compare-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .compare-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .compare-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .comparison-chart {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid rgba(255, 215, 0, 0.15);
            backdrop-filter: blur(10px);
            margin-top: 20px;
            min-height: 400px;
            position: relative;
        }

        .comparison-chart canvas {
            max-height: 300px;
            width: 100% !important;
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-color);
            font-weight: 600;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .legend-item:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
        }

        .player1-color {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .player2-color {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        /* Datos comparativos en texto */
        .comparison-stats {
            margin-top: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .comparison-stats h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-comparison {
            background: rgba(255, 255, 255, 0.08);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .stat-comparison h5 {
            color: var(--secondary-color);
            margin-bottom: 10px;
            font-size: 1rem;
            text-align: center;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 5px 0;
        }

        .stat-row:last-child {
            margin-bottom: 0;
        }

        .stat-label {
            font-weight: 500;
            color: var(--text-color);
        }

        .stat-value {
            font-weight: 600;
            color: var(--points-text);
        }

        .stat-difference {
            font-size: 0.85rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .stat-difference.positive {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .stat-difference.negative {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .stat-difference.neutral {
            background: rgba(149, 165, 166, 0.2);
            color: #95a5a6;
            border: 1px solid rgba(149, 165, 166, 0.3);
        }

        .comparison-summary {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            text-align: center;
        }

        .comparison-summary h5 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .summary-text {
            color: var(--text-color);
            line-height: 1.6;
        }

        /* Mejoras responsive */
        @media (max-width: 768px) {
            .comparison-chart {
                padding: 15px;
                margin-top: 15px;
            }

            .chart-legend {
                gap: 15px;
                flex-direction: column;
                align-items: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .stat-comparison {
                padding: 12px;
            }

            .comparison-stats {
                padding: 15px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="./css/header.css">
</head>
<body>
    <header class="app-header">
        <div class="header-content">
            <img src="./imagenes/Logojafs.png" alt="Logo" class="app-logo">
            <h1 class="app-title">Ranking en Tiempo Real - Padeluminatis</h1>
            <button class="menu-toggle" aria-label="Menú">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <nav class="app-nav">
            <a href="./home.html" class="nav-item"><i class="fas fa-home"></i><span>Inicio</span></a>
            <a href="./eventos.html" class="nav-item"><i class="fas fa-calendar-check"></i><span>Eventos</span></a>
            <a href="./calendario.html" class="nav-item"><i class="fas fa-calendar-alt"></i><span>Calendario</span></a>
            <a href="./clasificacion.html" class="nav-item"><i class="fas fa-trophy"></i><span>Clasificación</span></a>
            <a href="./normas.html" class="nav-item"><i class="fas fa-gavel"></i><span>Normas</span></a>
            <a href="./chat.html" class="nav-item"><i class="fas fa-comments"></i><span>Chat</span></a>
            <a href="./simulador-visual-real.html" class="nav-item active"><i class="fas fa-chart-line"></i><span>Ranking</span></a>
            <a href="./admin.html" class="nav-item nav-admin" style="display:none"><i class="fas fa-user-shield"></i><span>Admin</span></a>
            <a href="./perfil.html" class="nav-item"><i class="fas fa-user"></i><span>Perfil</span></a>
            <a href="./notificaciones.html" class="nav-item"><i class="fas fa-bell"></i><span>Notificaciones</span></a>
            <a href="#" class="nav-item nav-logout"><i class="fas fa-sign-out-alt"></i><span>Cerrar sesión</span></a>
        </nav>
    </header>
    
    <div class="container" style="margin-top: 30px;">
        <div class="panel">
            <h2 class="panel-title">
                <i class="fas fa-trophy"></i>
                Ranking de Jugadores
            </h2>
            <div class="tabla-responsive-wrapper">
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>Pos</th>
                            <th>Jugador</th>
                            <th>Nivel</th>
                            <th>PJ</th>
                            <th>PG</th>
                            <th>Sets</th>
                            <th>Puntos</th>
                        </tr>
                    </thead>
                    <tbody id="rankingBody">
                        <!-- Los datos se cargarán dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para detalles del jugador -->
    <div id="playerModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-header">
                <h2 id="modalPlayerName">Detalles del Jugador</h2>
                <div class="player-badge">
                    <span id="modalPlayerLevel" class="level-badge"></span>
                    <span id="modalPlayerPoints" class="points-badge"></span>
                </div>
            </div>
            
            <div class="modal-body">
                <div class="match-history">
                    <h3>📈 Historial de Partidos</h3>
                    <div class="match-navigation">
                        <button id="prevMatch" class="nav-btn">←</button>
                        <span id="matchCounter">Partido 1 de X</span>
                        <button id="nextMatch" class="nav-btn">→</button>
                    </div>
                    
                    <div id="matchDetails" class="match-details">
                        <!-- Detalles del partido actual -->
                    </div>
                    
                    <div id="matchFactors" class="match-factors">
                        <!-- Factores del partido actual -->
                    </div>
                </div>
                
                <div class="player-stats-grid">
                    <h3>📊 Estadísticas del Jugador</h3>
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-icon">🎾</div>
                            <div class="stat-value" id="modalPlayerMatches">0</div>
                            <div class="stat-label">Partidos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">🏆</div>
                            <div class="stat-value" id="modalPlayerWins">0</div>
                            <div class="stat-label">Victorias</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">📊</div>
                            <div class="stat-value" id="modalPlayerWinRate">0%</div>
                            <div class="stat-label">Win Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">⚡</div>
                            <div class="stat-value" id="modalPlayerSets">0-0</div>
                            <div class="stat-label">Sets</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sección de comparación de usuarios -->
    <div class="comparison-panel">
        <h3 class="panel-title">
            <i>📊</i>
            Comparar Usuarios
        </h3>
        <div class="comparison-controls">
            <div class="player-selector">
                <label for="player1Select">Jugador 1:</label>
                <select id="player1Select" class="player-select">
                    <option value="">Seleccionar jugador...</option>
                </select>
            </div>
            <div class="player-selector">
                <label for="player2Select">Jugador 2:</label>
                <select id="player2Select" class="player-select">
                    <option value="">Seleccionar jugador...</option>
                </select>
            </div>
            <button id="compareBtn" class="compare-btn" disabled>
                📊 Comparar Progreso
            </button>
        </div>
        <div id="comparisonChart" class="comparison-chart" style="display: none;">
            <div class="chart-legend">
                <div class="legend-item">
                    <span class="legend-color player1-color"></span>
                    <span id="legendPlayer1">Jugador 1</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color player2-color"></span>
                    <span id="legendPlayer2">Jugador 2</span>
                </div>
            </div>
            <div id="comparisonStats" class="comparison-stats" style="display:none;"></div>
        </div>
    </div>

    <script type="module">
    import { db } from './js/firebase-config.js';
    import { collection, getDocs, updateDoc, doc, query, orderBy, collectionGroup, setDoc } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

    let players = [];
    let equipos = {};
    let partidos = [];
    let posicionesAnteriores = {};
    let rankingAnterior = [];

    async function cargarJugadoresYEquipos() {
      console.log('Cargando jugadores y equipos...');
      
      // Solo cargar jugadores si no están ya cargados desde Firestore
      if (players.length === 0) {
        const usuariosSnap = await getDocs(collection(db, "usuarios"));
        players = usuariosSnap.docs.map(doc => {
          const data = doc.data();
          const nivel = parseFloat(data.nivel) || 2.0;
          return {
            id: doc.id,
            name: data.nombreUsuario || data.displayName || data.nombre || 'Sin nombre',
            nivel: nivel,
            puntosRanking: calcularPuntosInicio(nivel),
            puntosNivel: 300,
            progresoNivel: 50,
            matches: 0,
            wins: 0,
            setsWon: 0,
            setsLost: 0,
            history: []
          };
        });
        console.log('Jugadores cargados desde usuarios:', players.length);
      } else {
        console.log('Jugadores ya cargados desde Firestore:', players.length);
      }
      
      // Cargar equipos
      const equiposSnap = await getDocs(collection(db, "equipos"));
      equipos = {};
      equiposSnap.docs.forEach(doc => {
        const data = doc.data();
        equipos[doc.id] = {
          id: doc.id,
          nombre: data.nombre || `Equipo ${doc.id}`,
          jugadores: data.jugadores || []
        };
      });
      console.log('Equipos cargados:', Object.keys(equipos).length);
      
      // Cargar jornadas y partidos
      partidos = [];
      const calendarioSnap = await getDocs(collection(db, "calendario"));
      console.log('Jornadas encontradas:', calendarioSnap.docs.length);
      
      for (const jornadaDoc of calendarioSnap.docs) {
        const partidosSnap = await getDocs(collection(db, `calendario/${jornadaDoc.id}/partidos`));
        partidosSnap.docs.forEach(doc => {
          const data = doc.data();
          if (data.resultado && data.resultado.set1) {
            partidos.push({
              ...data,
              id: doc.id,
              tipo: 'liga',
              fecha: data.fecha?.toDate ? data.fecha.toDate() : new Date(),
              equipoLocalId: data.equipoLocal,
              equipoVisitanteId: data.equipoVisitante
            });
          }
        });
      }
      // Cargar partidos amistosos
      const amistososSnap = await getDocs(collection(db, "partidosAmistosos"));
      amistososSnap.docs.forEach(doc => {
        const data = doc.data();
        if (data.resultado && data.resultado.set1) {
          partidos.push({
            ...data,
            id: doc.id,
            tipo: 'amistoso',
            fecha: data.fecha?.toDate ? data.fecha.toDate() : new Date(),
            jugadores: data.jugadores || []
          });
        }
      });
      // Cargar partidos reto
      const retosSnap = await getDocs(collection(db, "partidosReto"));
      retosSnap.docs.forEach(doc => {
        const data = doc.data();
        if (data.resultado && data.resultado.set1) {
          partidos.push({
            ...data,
            id: doc.id,
            tipo: 'reto',
            fecha: data.fecha?.toDate ? data.fecha.toDate() : new Date(),
            jugadores: data.jugadores || []
          });
        }
      });
      // Ordenar partidos por fecha
      partidos = partidos.sort((a, b) => a.fecha - b.fecha);
      console.log('Partidos cargados:', partidos.length);
      console.log('Carga completada');
    }

    function calcularCambioPuntosElo(player, comp, resultado, victoria, rivales, tipo) {
      // Lógica de Elo más justa y equilibrada
      const avgRivalElo = rivales.reduce((acc, r) => acc + (r.elo || 1000), 0) / rivales.length;
      const expected = 1 / (1 + Math.pow(10, (avgRivalElo - player.elo) / 400));
      
      // Factor K más equilibrado
      let k = 32;
      if (player.matches >= 30) k = 16;
      else if (player.matches >= 10) k = 24;
      
      const ri = victoria ? 1 : 0;
      
      // Factores más equilibrados y justos
      const factorNivelPartido = ((player.nivel + comp.nivel + rivales[0].nivel + rivales[1].nivel) / 4 - 2.0) * 2.0;
      const factorCompanero = (player.nivel - comp.nivel) * 1.5;
      const factorRivales = ((rivales[0].nivel + rivales[1].nivel) / 2 - player.nivel) * 2.0;
      
      // Factor de marcador más equilibrado
      const diffJuegos = Math.abs(resultado.juegosLocal - resultado.juegosVisitante);
      const factorMarcador = victoria ? diffJuegos * 1.0 : -diffJuegos * 0.8;
      
      const factorNivelIndividual = (player.nivel - 2.0) * 1.5;
      
      // Factores de tipo de partido más equilibrados
      let factorTipoPartido = 0;
      switch (tipo) {
        case 'liga': factorTipoPartido = 2.0; break;
        case 'reto': factorTipoPartido = 1.5; break;
        case 'amistoso': factorTipoPartido = 0.5; break;
        case 'torneo': factorTipoPartido = 2.5; break;
        default: factorTipoPartido = 1.0;
      }
      
      // Factor de experiencia más moderado
      const factorExperiencia = Math.min(1.5, player.matches * 0.1);
      
      // Factor de racha más equilibrado
      let factorRacha = 0;
      if (player.matches > 0) {
        const porcentajeVictorias = (player.wins / player.matches) * 100;
        if (porcentajeVictorias < 25) factorRacha = 1.0;
        else if (porcentajeVictorias > 75) factorRacha = -0.8;
      }
      
      // Factor de presión más moderado
      let factorPresion = 0;
      if (tipo === 'liga' && player.matches < 5) factorPresion = 1.0;
      else if (tipo === 'liga' && player.matches > 20) factorPresion = -0.5;
      
      // Suma de factores más equilibrada
      const sumaFactores = factorNivelPartido + factorCompanero + factorRivales + factorMarcador + 
                          factorNivelIndividual + factorTipoPartido + factorExperiencia + factorRacha + factorPresion;
      
      // Cálculo final más equilibrado
      const change = k * (ri - expected) + sumaFactores;
      
      // Limitar el cambio máximo para evitar cambios extremos
      const maxChange = 50;
      const finalChange = Math.max(-maxChange, Math.min(maxChange, change));
      
      // Calcular dificultad real (diferencia de nivel promedio)
      const dificultadReal = Math.abs(((rivales[0].nivel + rivales[1].nivel) / 2) - player.nivel);
      
      return {
        cambio: finalChange,
        dificultad: dificultadReal,
        factores: {
          nivelPartido: factorNivelPartido,
          companero: factorCompanero,
          rivales: factorRivales,
          marcador: factorMarcador,
          nivelIndividual: factorNivelIndividual,
          tipoPartido: factorTipoPartido,
          experiencia: factorExperiencia,
          racha: factorRacha,
          presion: factorPresion
        }
      };
    }

    // Función para calcular cambio de nivel estilo Pokémon
    function calcularCambioNivel(player, rivales, victoria, cambioPuntos) {
      const nivelPromedioRivales = (rivales[0].nivel + rivales[1].nivel) / 2;
      const diferenciaNivel = nivelPromedioRivales - player.nivel;
      
      // Base de cambio de nivel
      let cambioNivel = 0;
      
      if (victoria) {
        // Sistema Pokémon: Más puntos si ganas contra rivales de nivel alto
        if (diferenciaNivel > 0.5) {
          // Ganas contra rivales mucho más fuertes: +0.03
          cambioNivel = 0.03;
        } else if (diferenciaNivel > 0.2) {
          // Ganas contra rivales más fuertes: +0.02
          cambioNivel = 0.02;
        } else if (diferenciaNivel > -0.2) {
          // Ganas contra rivales de nivel similar: +0.01
          cambioNivel = 0.01;
        } else if (diferenciaNivel > -0.5) {
          // Ganas contra rivales más débiles: +0.005
          cambioNivel = 0.005;
        } else {
          // Ganas contra rivales mucho más débiles: +0.002
          cambioNivel = 0.002;
        }
      } else {
        // Sistema Pokémon: Pierdes más nivel si pierdes contra rivales débiles
        if (diferenciaNivel < -0.5) {
          // Pierdes contra rivales mucho más débiles: -0.03
          cambioNivel = -0.03;
        } else if (diferenciaNivel < -0.2) {
          // Pierdes contra rivales más débiles: -0.02
          cambioNivel = -0.02;
        } else if (diferenciaNivel < 0.2) {
          // Pierdes contra rivales de nivel similar: -0.01
          cambioNivel = -0.01;
        } else if (diferenciaNivel < 0.5) {
          // Pierdes contra rivales más fuertes: -0.005
          cambioNivel = -0.005;
        } else {
          // Pierdes contra rivales mucho más fuertes: -0.002
          cambioNivel = -0.002;
        }
      }
      
      // Factor adicional basado en el cambio de puntos
      const factorPuntos = Math.abs(cambioPuntos) / 50; // Normalizar a 0-1
      cambioNivel *= (0.5 + factorPuntos * 0.5); // Entre 50% y 100% del cambio base
      
      // Limitar el nivel entre 2.00 y 4.00
      const nuevoNivel = Math.max(2.00, Math.min(4.00, player.nivel + cambioNivel));
      
      return {
        cambioNivel: nuevoNivel - player.nivel,
        nuevoNivel: nuevoNivel,
        diferenciaRivales: diferenciaNivel
      };
    }

    // Función para calcular progreso de nivel (usando niveles manuales)
    function calcularProgresoNivel(nivel) {
      // Niveles manuales que añadiste: 3.20, 3.25, etc.
      const niveles = [
        { nivel: 2.00, nombre: "Principiante" },
        { nivel: 2.50, nombre: "Novato" },
        { nivel: 3.00, nombre: "Intermedio Bajo" },
        { nivel: 3.20, nombre: "Intermedio" },
        { nivel: 3.25, nombre: "Intermedio Alto" },
        { nivel: 3.30, nombre: "Avanzado Bajo" },
        { nivel: 3.35, nombre: "Avanzado" },
        { nivel: 3.40, nombre: "Avanzado Alto" },
        { nivel: 3.45, nombre: "Experto" },
        { nivel: 3.50, nombre: "Maestro" },
        { nivel: 4.00, nombre: "Leyenda" }
      ];
      
      // Encontrar el nivel actual y el siguiente
      let nivelActual = niveles[0];
      let nivelSiguiente = null;
      
      for (let i = 0; i < niveles.length; i++) {
        if (nivel >= niveles[i].nivel) {
          nivelActual = niveles[i];
          nivelSiguiente = niveles[i + 1] || null;
        } else {
          break;
        }
      }
      
      let progreso = 0;
      let puntosParaSubir = 0;
      
      if (nivelSiguiente) {
        progreso = ((nivel - nivelActual.nivel) / (nivelSiguiente.nivel - nivelActual.nivel)) * 100;
        puntosParaSubir = nivelSiguiente.nivel - nivel;
      } else {
        progreso = 100;
        puntosParaSubir = 0;
      }
      
      return {
        nivel: nivel,
        nombre: nivelActual.nombre,
        progreso: Math.min(100, Math.max(0, progreso)),
        puntosParaSubir: Math.max(0, puntosParaSubir),
        nivelSiguiente: nivelSiguiente ? nivelSiguiente.nivel : nivel
      };
    }

    window.addEventListener('DOMContentLoaded', async () => {
      console.log('Página cargada, inicializando...');
      await renderTablaVacia();
      
      // Cargar datos iniciales
      try {
        // Primero intentar cargar desde Firestore
        const rankingCargado = await cargarRankingDesdeFirestore();
        
        if (!rankingCargado) {
          // Si no hay datos en Firestore, procesar desde cero
          console.log('🔄 Procesando partidos desde cero...');
          await reiniciarNivelesYPuntos();
          console.log('Niveles y puntos reiniciados con nuevo sistema');
          await cargarJugadoresYEquipos();
          console.log('Datos iniciales cargados');
          await procesarPartidosDesdeCero();
          console.log('Procesamiento inicial completado con nuevo sistema');
          
          // Guardar en Firestore para futuras cargas
          await guardarRankingEnFirestore();
        } else {
          // Si se cargó desde Firestore, verificar si hay nuevos partidos
          await cargarJugadoresYEquipos();
          console.log('✅ Datos cargados desde Firestore');
          
          const hayNuevosPartidos = await verificarNuevosPartidos();
          if (hayNuevosPartidos) {
            console.log('🔄 Procesando nuevos partidos...');
            await procesarPartidosDesdeCero();
            console.log('✅ Nuevos partidos procesados');
          }
        }
        
        // Actualizar tabla
        updateRankingTable();
        
        // Cargar usuarios en selects para comparación
        cargarUsuariosEnSelects();
      } catch (error) {
        console.error('Error al cargar datos iniciales:', error);
      }
      

    });

    async function renderTablaVacia() {
      // Opcional: puedes mostrar la tabla vacía o con los puntos/niveles base
      const usuariosSnap = await getDocs(collection(db, "usuarios"));
      const tbody = document.getElementById('rankingBody');
      tbody.innerHTML = '';
      usuariosSnap.forEach(docu => {
        const data = docu.data();
        tbody.innerHTML += `<tr><td>-</td><td>${data.nombreUsuario || data.nombre || 'Sin nombre'}</td><td>0</td><td>0</td><td>0</td><td>0-0</td><td>0</td></tr>`;
      });
    }

    async function guardarRankingEnFirestore() {
      console.log('💾 Guardando ranking en Firestore...');
      try {
        // Guardar datos de cada jugador en la colección Ranking
        for (const player of players) {
          const rankingData = {
            id: player.id,
            name: player.name,
            nivel: player.nivel,
            puntosRanking: player.puntosRanking,
            puntosRankingInicio: calcularPuntosInicio(player.nivel),
            matches: player.matches || 0,
            wins: player.wins || 0,
            setsWon: player.setsWon || 0,
            setsLost: player.setsLost || 0,
            racha: player.racha || 0,
            historial: player.history || [],
            ultimaActualizacion: new Date(),
            version: '2.0' // Para futuras actualizaciones del sistema
          };
          
          await setDoc(doc(db, "Ranking", player.id), rankingData);
        }
        console.log('✅ Ranking guardado correctamente en Firestore');
      } catch (error) {
        console.error('❌ Error al guardar ranking:', error);
      }
    }

    async function cargarRankingDesdeFirestore() {
      console.log('📥 Cargando ranking desde Firestore...');
      try {
        const rankingSnap = await getDocs(collection(db, "Ranking"));
        if (!rankingSnap.empty) {
          players = rankingSnap.docs.map(doc => {
            const data = doc.data();
            return {
              id: data.id,
              name: data.name,
              nivel: data.nivel || 2.0,
              puntosRanking: data.puntosRanking || calcularPuntosInicio(data.nivel || 2.0),
              matches: data.matches || 0,
              wins: data.wins || 0,
              setsWon: data.setsWon || 0,
              setsLost: data.setsLost || 0,
              racha: data.racha || 0,
              history: data.historial || []
            };
          });
          console.log('✅ Ranking cargado desde Firestore:', players.length, 'jugadores');
          
          // Cargar usuarios en selects para comparación
          cargarUsuariosEnSelects();
          
          return true;
        } else {
          console.log('⚠️ No hay datos en Firestore, se procesarán los partidos');
          return false;
        }
      } catch (error) {
        console.error('❌ Error al cargar ranking:', error);
        return false;
      }
    }

    async function verificarNuevosPartidos() {
      console.log('🔍 Verificando si hay nuevos partidos...');
      try {
        // Cargar partidos actuales
        const partidosActuales = [];
        const calendarioSnap = await getDocs(collection(db, "calendario"));
        
        for (const jornadaDoc of calendarioSnap.docs) {
          const partidosSnap = await getDocs(collection(db, `calendario/${jornadaDoc.id}/partidos`));
          partidosSnap.docs.forEach(doc => {
            const data = doc.data();
            if (data.resultado && data.resultado.set1) {
              partidosActuales.push({
                ...data,
                id: doc.id,
                tipo: 'liga',
                fecha: data.fecha?.toDate ? data.fecha.toDate() : new Date()
              });
            }
          });
        }
        
        // Cargar partidos amistosos
        const amistososSnap = await getDocs(collection(db, "partidosAmistosos"));
        amistososSnap.docs.forEach(doc => {
          const data = doc.data();
          if (data.resultado && data.resultado.set1) {
            partidosActuales.push({
              ...data,
              id: doc.id,
              tipo: 'amistoso',
              fecha: data.fecha?.toDate ? data.fecha.toDate() : new Date()
            });
          }
        });
        
        // Comparar con partidos procesados
        const partidosProcesados = players.reduce((total, player) => total + (player.history?.length || 0), 0) / 4; // 4 jugadores por partido
        
        if (partidosActuales.length > partidosProcesados) {
          console.log(`🆕 Nuevos partidos detectados: ${partidosActuales.length - partidosProcesados}`);
          return true;
        } else {
          console.log('✅ No hay nuevos partidos');
          return false;
        }
      } catch (error) {
        console.error('❌ Error al verificar nuevos partidos:', error);
        return false;
      }
    }

    async function reiniciarNivelesYPuntos() {
      // Reinicia los niveles y puntos de todos los usuarios con el nuevo sistema
      console.log('🔄 Reiniciando niveles y puntos con nuevo sistema...');
      const usuariosSnap = await getDocs(collection(db, "usuarios"));
      for (const docu of usuariosSnap.docs) {
        const data = docu.data();
        const nivelBase = data.nivel || 2.00;
        const puntosBase = calcularPuntosInicio(nivelBase);
        console.log(`Usuario ${data.nombreUsuario || data.nombre}: Nivel ${nivelBase} → Puntos ${puntosBase}`);
        await updateDoc(doc(db, "usuarios", docu.id), {
          nivel: nivelBase,
          puntosRanking: puntosBase,
          puntosRankingInicio: puntosBase,
          partidosJugados: 0,
          victorias: 0,
          setsGanados: 0,
          setsPerdidos: 0,
          dificultadMedia: 0,
          historial: [],
          racha: 0
        });
      }
      console.log('✅ Niveles y puntos reiniciados correctamente');
    }

    async function procesarPartidosDesdeCero() {
      // Variables y funciones auxiliares necesarias para el procesamiento de partidos
      let rankingAnterior = [];
      let posicionesAnteriores = {};
      
      function obtenerJugadoresEquipo(equipoId) {
        const equipo = equipos[equipoId];
        if (!equipo || !equipo.jugadores) return [];
        return equipo.jugadores.map(jugadorId => {
          return players.find(j => j.id === jugadorId) || { id: jugadorId, name: 'Desconocido', nivel: 2.0, puntosRanking: calcularPuntosInicio(2.0), puntosNivel: 300, matches: 0, wins: 0, setsWon: 0, setsLost: 0, history: [] };
        });
      }
      

      
      // Instancia del sistema de puntuación avanzado (debes definir la clase o función correspondiente)
      const sistemaPuntuacion = new SistemaPuntuacionAvanzado();
      
      // Lógica de procesamiento de partidos y actualización de usuarios
      rankingAnterior = players.map(p => ({ id: p.id, puntosRanking: p.puntosRanking }));
      const sortedPrev = [...players].map(corregirDatosJugador).sort((a, b) => b.puntosRanking - a.puntosRanking);
      sortedPrev.forEach((p, idx) => { posicionesAnteriores[p.id] = idx; });
      for (const partido of partidos) {
        console.log('Procesando partido:', partido);
        let jugadoresLocal = [];
        let jugadoresVisitante = [];
        if (partido.tipo === 'liga') {
          jugadoresLocal = obtenerJugadoresEquipo(partido.equipoLocalId);
          jugadoresVisitante = obtenerJugadoresEquipo(partido.equipoVisitanteId);
        } else {
          if (partido.jugadores && partido.jugadores.length >= 4) {
            jugadoresLocal = partido.jugadores.slice(0, 2).map(jid => players.find(j => j.id === jid) || { id: jid, name: 'Desconocido', nivel: 2.0, puntosRanking: calcularPuntosInicio(2.0), puntosNivel: 300, matches: 0, wins: 0, setsWon: 0, setsLost: 0, history: [] });
            jugadoresVisitante = partido.jugadores.slice(2, 4).map(jid => players.find(j => j.id === jid) || { id: jid, name: 'Desconocido', nivel: 2.0, puntosRanking: calcularPuntosInicio(2.0), puntosNivel: 300, matches: 0, wins: 0, setsWon: 0, setsLost: 0, history: [] });
          } else {
            jugadoresLocal = players.slice(0, 2);
            jugadoresVisitante = players.slice(2, 4);
          }
        }
        if (jugadoresLocal.length < 2 || jugadoresVisitante.length < 2) continue;
        const resultado = partido.resultado;
        if (!resultado || !resultado.set1) continue;
        const setsLocal = [resultado.set1.puntos1, resultado.set2?.puntos1 || 0, resultado.set3?.puntos1 || 0];
        const setsVisitante = [resultado.set1.puntos2, resultado.set2?.puntos2 || 0, resultado.set3?.puntos2 || 0];
        let setsGanadosLocal = 0;
        let setsGanadosVisitante = 0;
        for (let i = 0; i < 3; i++) {
          if (setsLocal[i] > setsVisitante[i]) {
            setsGanadosLocal++;
          } else if (setsVisitante[i] > setsLocal[i]) {
            setsGanadosVisitante++;
          }
        }
        const team1Wins = setsGanadosLocal > setsGanadosVisitante;
        const diferenciaMarcador = Math.abs(setsGanadosLocal - setsGanadosVisitante);
        const setsJugados = (resultado.set1 ? 1 : 0) + (resultado.set2 ? 1 : 0) + (resultado.set3 ? 1 : 0);
        [...jugadoresLocal, ...jugadoresVisitante].forEach((player, idx) => {
          const win = (idx < 2 && team1Wins) || (idx >= 2 && !team1Wins);
          const companero = idx % 2 === 0 ? (idx < 2 ? jugadoresLocal[1] : jugadoresVisitante[1]) : (idx < 2 ? jugadoresLocal[0] : jugadoresVisitante[0]);
          const rivales = idx < 2 ? jugadoresVisitante : jugadoresLocal;
          const experiencia = player.matches || 0;
          let racha = player.racha || 0;
          if (win) {
            racha = racha >= 0 ? racha + 1 : 1;
          } else {
            racha = racha <= 0 ? racha - 1 : -1;
          }
          player.racha = racha;
          
          // Actualizar estadísticas del jugador
          player.matches = (player.matches || 0) + 1;
          if (win) player.wins = (player.wins || 0) + 1;
          player.setsWon = (player.setsWon || 0) + (idx < 2 ? setsGanadosLocal : setsGanadosVisitante);
          player.setsLost = (player.setsLost || 0) + (idx < 2 ? setsGanadosVisitante : setsGanadosLocal);
          
          // Declarar solo una vez por jugador:
          let puntosAntes = player.puntosRanking;
          let nivelAntes = player.nivel;
          const resultadoPuntuacion = sistemaPuntuacion.calcularCambio({
            jugador: player,
            rivales: rivales,
            resultado: win ? 1 : 0,
            tipoPartido: partido.tipo || 'liga',
            margenSets: diferenciaMarcador,
            experiencia: experiencia,
            racha: racha,
            setsJugados: setsJugados,
            companero: companero,
            formaRivales: rivales.reduce((a, r) => a + (r.racha || 0), 0),
            esPartidoDecisivo: false,
            diasSinJugar: 0
          });
          console.log(`Jugador: ${player.name}, puntos obtenidos: ${resultadoPuntuacion.puntos.toFixed(2)}, cambio nivel: ${resultadoPuntuacion.cambioNivel.toFixed(3)}`);
          
          // Sumar/restar los puntosRanking obtenidos en este partido
          player.puntosRanking += resultadoPuntuacion.puntos;
          player.puntosRanking = Math.max(0, player.puntosRanking);
          
          // Aplicar cambio de nivel con límite estricto de ±0.03 (ya aplicado en la clase)
          player.nivel = Math.max(1.0, Math.min(5.0, player.nivel + resultadoPuntuacion.cambioNivel));
          
          // Guardar en el historial el nivel antes y después, y el cambio de puntos y nivel
          player.history.push({
            partidoId: partido.id,
            fecha: partido.fecha,
            rival: rivales.map(r => r.name),
            rivalNiveles: rivales.map(r => r.nivel || 2.0),
            companero: companero.name,
            companeroNivel: companero.nivel || 2.0,
            resultado: win ? 'victoria' : 'derrota',
            puntosRankingAntes: puntosAntes,
            puntosRankingDespues: player.puntosRanking,
            nivelAntes: nivelAntes,
            nivelDespues: player.nivel,
            cambioNivel: resultadoPuntuacion.cambioNivel,
            desglose: resultadoPuntuacion.desglose,
            desgloseReal: {
              cambioElo: resultadoPuntuacion.cambioElo,
              factoresAdicionales: resultadoPuntuacion.factoresAdicionales,
              sumaTotal: resultadoPuntuacion.sumaTotal,
              limiteAplicado: resultadoPuntuacion.limiteAplicado
            },
            racha: racha,
            diferenciaMarcador: diferenciaMarcador,
            setsGanados: idx < 2 ? setsGanadosLocal : setsGanadosVisitante,
            setsPerdidos: idx < 2 ? setsGanadosVisitante : setsGanadosLocal
          });
        });
      }
      updateRankingTable();
      console.log('Ranking actualizado:', players.map(p => ({ name: p.name, puntosRanking: p.puntosRanking, nivel: p.nivel })));
      console.log('Procesamiento completado. Jugadores procesados:', players.length);
      
      // Cargar usuarios en selects para comparación
      cargarUsuariosEnSelects();
      
      // Guardar en Firestore después del procesamiento
      await guardarRankingEnFirestore();
    }

    // 2. Modal de desglose de puntos por partido
    // Añadir función mostrarModalJugador con desglose detallado
    function mostrarModalJugador(player) {
      const modal = document.getElementById('playerModal');
      document.getElementById('modalPlayerName').textContent = player.name;
      document.getElementById('modalPlayerLevel').textContent = `Nivel: ${parseFloat(player.nivel).toFixed(2)}`;
      document.getElementById('modalPlayerPoints').textContent = `Puntos: ${player.puntosRanking.toFixed(2)}`;
      document.getElementById('modalPlayerMatches').textContent = player.matches;
      document.getElementById('modalPlayerWins').textContent = player.wins;
      document.getElementById('modalPlayerWinRate').textContent = player.matches > 0 ? `${((player.wins / player.matches) * 100).toFixed(1)}%` : '0%';
      document.getElementById('modalPlayerSets').textContent = `${player.setsWon}-${player.setsLost}`;

      // Desglose de partidos
      const matchDetails = document.getElementById('matchDetails');
      const matchFactors = document.getElementById('matchFactors');
      matchDetails.innerHTML = '';
      matchFactors.innerHTML = '';
      if (player.history && player.history.length > 0) {
        let idx = player.history.length - 1;
        mostrarPartido(idx);
        let currentIdx = idx;
        document.getElementById('prevMatch').onclick = () => {
          if (currentIdx > 0) { currentIdx--; mostrarPartido(currentIdx); }
        };
        document.getElementById('nextMatch').onclick = () => {
          if (currentIdx < player.history.length - 1) { currentIdx++; mostrarPartido(currentIdx); }
        };
        function mostrarPartido(i) {
          const h = player.history[i];
          const rivalesInfo = h.rival.map((r, idx) => `${r} (Nivel ${h.rivalNiveles ? h.rivalNiveles[idx].toFixed(2) : '2.00'})`).join(' & ');
          matchDetails.innerHTML = `
            <div><b>Rivales:</b> ${rivalesInfo}</div>
            <div><b>Compañero:</b> ${h.companero} (Nivel ${h.companeroNivel ? h.companeroNivel.toFixed(2) : '2.00'})</div>
            <div><b>Resultado:</b> ${h.resultado}</div>
            <div><b>Puntos antes:</b> ${h.puntosRankingAntes.toFixed(2)}</div>
            <div><b>Puntos después:</b> ${h.puntosRankingDespues.toFixed(2)}</div>
            <div><b>Cambio puntos:</b> <span style='color:${(h.puntosRankingDespues-h.puntosRankingAntes)>=0?'#2ecc71':'#e74c3c'};'>${(h.puntosRankingDespues-h.puntosRankingAntes).toFixed(2)}</span></div>
            <div><b>Nivel antes:</b> ${h.nivelAntes ? h.nivelAntes.toFixed(2) : '-'}</div>
            <div><b>Nivel después:</b> ${h.nivelDespues ? h.nivelDespues.toFixed(2) : '-'}</div>
            <div><b>Cambio nivel:</b> <span style='color:${(h.cambioNivel)>=0?'#2ecc71':'#e74c3c'};'>${(h.cambioNivel).toFixed(3)}</span></div>
            <div><b>Diferencia marcador:</b> ${h.diferenciaMarcador}</div>
            <div><b>Racha:</b> ${h.racha}</div>
            <div><b>Sets ganados:</b> ${h.setsGanados} | <b>Sets perdidos:</b> ${h.setsPerdidos}</div>
          `;
          // Desglose real de puntos aplicados
          if (h.desgloseReal && typeof h.desgloseReal === 'object') {
            let desgloseHtml = '<h4>📊 Desglose Completo de Puntos:</h4>';
            desgloseHtml += '<div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 15px;">';
            desgloseHtml += '<h5 style="color: #3498db; margin-bottom: 10px;">🔢 Cálculo Detallado:</h5>';
            desgloseHtml += `<div style="margin-bottom: 8px;"><b>🏆 Sistema Elo:</b> <span style='color:${h.desgloseReal.cambioElo >= 0 ? '#2ecc71' : '#e74c3c'};'>${h.desgloseReal.cambioElo.toFixed(2)}</span></div>`;
            desgloseHtml += `<div style="margin-bottom: 8px;"><b>⚡ Factores Adicionales:</b> <span style='color:${h.desgloseReal.factoresAdicionales >= 0 ? '#2ecc71' : '#e74c3c'};'>${h.desgloseReal.factoresAdicionales.toFixed(2)}</span></div>`;
            desgloseHtml += `<div style="margin-bottom: 8px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px;"><b>📊 Suma Total (Elo + Factores):</b> <span style='color:${h.desgloseReal.sumaTotal >= 0 ? '#2ecc71' : '#e74c3c'}; font-size: 1.1em; font-weight: bold;'>${h.desgloseReal.sumaTotal.toFixed(2)}</span></div>`;
            
            if (h.desgloseReal.limiteAplicado) {
              desgloseHtml += `<div style="margin-bottom: 8px;"><b>⚠️ Límite Aplicado:</b> <span style='color: #f39c12;'>Sí (máx ±40 puntos)</span></div>`;
            }
            
            desgloseHtml += `<div style="margin-top: 10px; padding: 8px; background: rgba(255,215,0,0.1); border-radius: 5px;"><b>🎯 Puntos Finales Aplicados:</b> <span style='color: #f1c40f; font-size: 1.2em; font-weight: bold;'>${(h.puntosRankingDespues - h.puntosRankingAntes).toFixed(2)}</span></div>`;
            desgloseHtml += '</div>';
            
            // Desglose de factores individuales
            if (h.desglose && typeof h.desglose === 'object') {
              desgloseHtml += '<h5 style="color: #3498db; margin-bottom: 10px;">🔍 Desglose de Factores Adicionales:</h5>';
              desgloseHtml += '<ul style="font-size:0.9em; list-style: none; padding: 0;">';
              for (const [clave, valor] of Object.entries(h.desglose)) {
                if (typeof valor === 'number' && !clave.includes('Nivel')) {
                  desgloseHtml += `<li style="margin-bottom: 5px; padding: 4px 8px; background: rgba(0,0,0,0.2); border-radius: 4px;"><b>${clave}:</b> <span style='color:${valor >= 0 ? '#2ecc71' : '#e74c3c'};'>${valor.toFixed(2)}</span></li>`;
                }
              }
              desgloseHtml += '</ul>';
              desgloseHtml += `<div style="margin-top: 10px; padding: 8px; background: rgba(52, 152, 219, 0.1); border-radius: 5px; border-left: 3px solid #3498db;"><b>📋 Total Factores Adicionales:</b> <span style='color: #3498db; font-weight: bold;'>${h.desgloseReal.factoresAdicionales.toFixed(2)}</span></div>`;
            }
            
            matchFactors.innerHTML = desgloseHtml;
          } else {
            matchFactors.innerHTML = '<i>No hay desglose disponible para este partido.</i>';
          }
          document.getElementById('matchCounter').textContent = `Partido ${i + 1} de ${player.history.length}`;
        }
      } else {
        matchDetails.innerHTML = '<i>No hay historial de partidos.</i>';
        matchFactors.innerHTML = '';
      }
      modal.style.display = 'block';
      document.querySelector('#playerModal .close').onclick = () => { modal.style.display = 'none'; };
      window.onclick = (event) => { if (event.target == modal) modal.style.display = 'none'; };
    }

    function corregirDatosJugador(player) {
      player.nivel = (player.nivel !== undefined && player.nivel !== null && !isNaN(player.nivel)) ? parseFloat(player.nivel) : 2.0;
      if (player.elo !== undefined && player.elo !== null && !isNaN(player.elo)) {
        player.puntosRanking = parseFloat(player.elo);
      }
      if (player.puntosRanking === undefined || player.puntosRanking === null || isNaN(player.puntosRanking)) {
        player.puntosRanking = calcularPuntosInicio(player.nivel);
      }
      if (isNaN(player.puntosRanking)) player.puntosRanking = 0;
      player.puntosNivel = (player.puntosNivel !== undefined && player.puntosNivel !== null && !isNaN(player.puntosNivel)) ? parseFloat(player.puntosNivel) : 0;
      player.progresoNivel = (player.progresoNivel !== undefined && player.progresoNivel !== null && !isNaN(player.progresoNivel)) ? parseFloat(player.progresoNivel) : 0;
      player.matches = (player.matches !== undefined && player.matches !== null && !isNaN(player.matches)) ? parseInt(player.matches) : 0;
      player.wins = (player.wins !== undefined && player.wins !== null && !isNaN(player.wins)) ? parseInt(player.wins) : 0;
      player.setsWon = (player.setsWon !== undefined && player.setsWon !== null && !isNaN(player.setsWon)) ? parseInt(player.setsWon) : 0;
      player.setsLost = (player.setsLost !== undefined && player.setsLost !== null && !isNaN(player.setsLost)) ? parseInt(player.setsLost) : 0;
      return player;
    }

    function obtenerJugadoresEquipo(equipoId) {
      const equipo = equipos[equipoId];
      if (!equipo || !equipo.jugadores) return [];
      return equipo.jugadores.map(jugadorId => {
        return players.find(j => j.id === jugadorId) || { id: jugadorId, name: 'Desconocido', nivel: 2.0, puntosRanking: calcularPuntosInicio(2.0), puntosNivel: 300, matches: 0, wins: 0, setsWon: 0, setsLost: 0, history: [] };
      });
    }

    function addRowClickEvents() {
      const tbody = document.getElementById('rankingBody');
      if (!tbody) return;
      Array.from(tbody.children).forEach((tr, idx) => {
        tr.onclick = () => {
          const sortedPlayers = [...players].map(corregirDatosJugador).sort((a, b) => b.puntosRanking - a.puntosRanking);
          mostrarModalJugador(sortedPlayers[idx]);
        };
      });
    }

    function updateRankingTable() {
      console.log('Actualizando tabla de ranking...');
      const tbody = document.getElementById('rankingBody');
      if (!tbody) {
        console.error('No se encontró el tbody');
        return;
      }
      tbody.innerHTML = '';
      const sortedPlayers = [...players].map(corregirDatosJugador).sort((a, b) => b.puntosRanking - a.puntosRanking);
      console.log('Jugadores ordenados:', sortedPlayers.length);
      
      const rankingActual = sortedPlayers.map(p => p.id);
      let idsUltimoPartido = [];
      if (partidos && partidos.length > 0) {
        const ultimo = partidos[partidos.length - 1];
        if (ultimo.tipo === 'liga') {
          idsUltimoPartido = [
            ...(ultimo.equipoLocalId ? obtenerJugadoresEquipo(ultimo.equipoLocalId).map(j => j.id) : []),
            ...(ultimo.equipoVisitanteId ? obtenerJugadoresEquipo(ultimo.equipoVisitanteId).map(j => j.id) : [])
          ];
        } else if (ultimo.jugadores && ultimo.jugadores.length >= 4) {
          idsUltimoPartido = ultimo.jugadores;
        }
      }
      
      sortedPlayers.forEach((player, index) => {
        let deltaPuntos = 0;
        let deltaHtml = '';
        let cambioPos = '';
        if (idsUltimoPartido.includes(player.id)) {
          const lastMatch = player.history && player.history.length > 0 ? player.history[player.history.length - 1] : null;
          if (lastMatch) {
            deltaPuntos = lastMatch.puntosRankingDespues - lastMatch.puntosRankingAntes;
            if (deltaPuntos > 0) deltaHtml = `<span style='color:#2ecc71;font-weight:bold;'>&uarr; +${deltaPuntos.toFixed(2)}</span>`;
            else if (deltaPuntos < 0) deltaHtml = `<span style='color:#e74c3c;font-weight:bold;'>&darr; ${deltaPuntos.toFixed(2)}</span>`;
          }
          if (posicionesAnteriores[player.id] !== undefined) {
            const diff = posicionesAnteriores[player.id] - index;
            if (diff > 0) cambioPos = `<span style='color:#2ecc71;font-weight:bold;'>&uarr;${diff}</span>`;
            else if (diff < 0) cambioPos = `<span style='color:#e74c3c;font-weight:bold;'>&darr;${Math.abs(diff)}</span>`;
            else cambioPos = `<span style='color:#bdc3c7;font-weight:bold;'>&rarr;0</span>`;
          }
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="font-weight: bold; color: #f1c40f;">${index + 1} ${cambioPos}</td>
          <td><div style="font-weight: 600;">${player.name} ${deltaHtml}</div></td>
          <td style="color: #fff; font-weight: bold;">${parseFloat(player.nivel).toFixed(2)}</td>
          <td style="text-align: center;"><div style="font-weight: bold;">${player.matches || 0}</div></td>
          <td style="text-align: center;"><div style="font-weight: bold; color: #2ecc71;">${player.wins || 0}</div></td>
          <td style="text-align: center;"><div style="font-weight: bold;">${player.setsWon || 0}-${player.setsLost || 0}</div></td>
          <td class="puntos-elo" style="color: #f1c40f; font-weight: bold; font-size: 0.65rem !important;">${player.puntosRanking.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });
      addRowClickEvents();
      console.log('Tabla de ranking actualizada correctamente');
    }

    // === FUNCIONALIDAD DE COMPARACIÓN DE USUARIOS ===
    let chart = null;

    // Función para cargar usuarios en los selects
    function cargarUsuariosEnSelects() {
      console.log('📋 Cargando usuarios en selects de comparación...');
      const player1Select = document.getElementById('player1Select');
      const player2Select = document.getElementById('player2Select');
      
      if (!player1Select || !player2Select) {
        console.warn('⚠️ No se encontraron los elementos select');
        return;
      }
      
      // Limpiar opciones existentes
      player1Select.innerHTML = '<option value="">Seleccionar jugador...</option>';
      player2Select.innerHTML = '<option value="">Seleccionar jugador...</option>';
      
      // Verificar que hay jugadores disponibles
      if (!players || players.length === 0) {
        console.warn('⚠️ No hay jugadores disponibles para cargar en selects');
        return;
      }
      
      // Ordenar jugadores por puntos
      const sortedPlayers = [...players].map(corregirDatosJugador).sort((a, b) => b.puntosRanking - a.puntosRanking);
      console.log(`📊 Cargando ${sortedPlayers.length} jugadores en selects`);
      
      // Añadir opciones
      sortedPlayers.forEach(player => {
        const option1 = document.createElement('option');
        option1.value = player.id;
        option1.textContent = `${player.name} (${player.puntosRanking.toFixed(2)} pts)`;
        player1Select.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = player.id;
        option2.textContent = `${player.name} (${player.puntosRanking.toFixed(2)} pts)`;
        player2Select.appendChild(option2);
      });
      
      console.log('✅ Usuarios cargados en selects correctamente');
    }

    // Función para habilitar/deshabilitar botón de comparación
    function actualizarBotonComparacion() {
      const player1Select = document.getElementById('player1Select');
      const player2Select = document.getElementById('player2Select');
      const compareBtn = document.getElementById('compareBtn');
      
      if (player1Select && player2Select && compareBtn) {
        const player1Selected = player1Select.value;
        const player2Selected = player2Select.value;
        
        compareBtn.disabled = !player1Selected || !player2Selected || player1Selected === player2Selected;
      }
    }

    // Función para comparar usuarios
    function compararUsuarios() {
      console.log('📊 Iniciando comparación de usuarios...');
      const player1Id = document.getElementById('player1Select').value;
      const player2Id = document.getElementById('player2Select').value;
      
      if (!player1Id || !player2Id || player1Id === player2Id) {
        console.warn('⚠️ Selección inválida para comparación');
        return;
      }
      
      const player1 = players.find(p => p.id === player1Id);
      const player2 = players.find(p => p.id === player2Id);
      
      if (!player1 || !player2) {
        console.warn('⚠️ No se encontraron los jugadores seleccionados');
        return;
      }
      
      console.log(`📈 Comparando: ${player1.name} vs ${player2.name}`);
      
      // Preparar datos para el gráfico
      const datos = prepararDatosComparacion(player1, player2);
      mostrarGraficoComparacion(datos);
      
      // Mostrar datos comparativos
      mostrarDatosComparativos(player1, player2);
      
      console.log('✅ Comparación completada');
    }

    // Función para preparar datos de comparación
    function prepararDatosComparacion(player1, player2) {
      const datos = {
        labels: [],
        datasets: [
          {
            label: player1.name,
            data: [],
            borderColor: '#e74c3c',
            backgroundColor: 'rgba(231, 76, 60, 0.1)',
            borderWidth: 3,
            fill: false,
            tension: 0.4
          },
          {
            label: player2.name,
            data: [],
            borderColor: '#3498db',
            backgroundColor: 'rgba(52, 152, 219, 0.1)',
            borderWidth: 3,
            fill: false,
            tension: 0.4
          }
        ]
      };
      
      // Obtener historial de partidos
      const historial1 = player1.history || [];
      const historial2 = player2.history || [];
      
      // Crear puntos de datos para cada partido
      let puntos1 = player1.puntosRankingInicio || calcularPuntosInicio(player1.nivel);
      let puntos2 = player2.puntosRankingInicio || calcularPuntosInicio(player2.nivel);
      
      // Punto inicial
      datos.labels.push('Inicio');
      datos.datasets[0].data.push(puntos1);
      datos.datasets[1].data.push(puntos2);
      
      // Procesar historial de partidos
      const maxPartidos = Math.max(historial1.length, historial2.length);
      
      for (let i = 0; i < maxPartidos; i++) {
        const partido1 = historial1[i];
        const partido2 = historial2[i];
        
        if (partido1) {
          puntos1 = partido1.puntosRankingDespues;
        }
        if (partido2) {
          puntos2 = partido2.puntosRankingDespues;
        }
        
        datos.labels.push(`Partido ${i + 1}`);
        datos.datasets[0].data.push(puntos1);
        datos.datasets[1].data.push(puntos2);
      }
      
      return datos;
    }

    // Función para mostrar el gráfico de comparación
    function mostrarGraficoComparacion(datos) {
        const chartContainer = document.getElementById('comparisonChart');
        
        if (!chartContainer) return;
        
        // Mostrar contenedor
        chartContainer.style.display = 'block';
        
        // Actualizar leyenda
        document.getElementById('legendPlayer1').textContent = datos.datasets[0].label;
        document.getElementById('legendPlayer2').textContent = datos.datasets[1].label;
        
        console.log('✅ Comparación mostrada en formato lista');
    }

    // Mostrar datos comparativos en texto debajo de la gráfica
    function mostrarDatosComparativos(player1, player2) {
        if (!player1 || !player2) return;
        const statsDiv = document.getElementById('comparisonStats');
        if (!statsDiv) return;

        // Calcular winrate y sets
        const winrate1 = player1.matches > 0 ? ((player1.wins / player1.matches) * 100).toFixed(1) : '0';
        const winrate2 = player2.matches > 0 ? ((player2.wins / player2.matches) * 100).toFixed(1) : '0';
        const sets1 = player1.setsWon + '-' + player1.setsLost;
        const sets2 = player2.setsWon + '-' + player2.setsLost;
        
        // Diferencias
        const diffPuntos = (player1.puntosRanking - player2.puntosRanking).toFixed(1);
        const diffNivel = (player1.nivel - player2.nivel).toFixed(3);
        
        function diffClass(val) {
            if (val > 0) return 'positive';
            if (val < 0) return 'negative';
            return 'neutral';
        }
        
        // HTML con diseño de lista mejorado
        statsDiv.innerHTML = `
            <h4>📊 Comparativa de Puntos y Niveles</h4>
            <div class="stats-grid">
                <div class="stat-comparison">
                    <h5>${player1.name}</h5>
                    <div class="stat-row">
                        <span class="stat-label">Nivel Actual</span>
                        <span class="stat-value">${player1.nivel.toFixed(3)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Puntos Ranking</span>
                        <span class="stat-value">${player1.puntosRanking.toFixed(1)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Partidos Jugados</span>
                        <span class="stat-value">${player1.matches}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Victorias</span>
                        <span class="stat-value">${player1.wins}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Winrate</span>
                        <span class="stat-value">${winrate1}%</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Sets (G-P)</span>
                        <span class="stat-value">${sets1}</span>
                    </div>
                </div>
                <div class="stat-comparison">
                    <h5>${player2.name}</h5>
                    <div class="stat-row">
                        <span class="stat-label">Nivel Actual</span>
                        <span class="stat-value">${player2.nivel.toFixed(3)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Puntos Ranking</span>
                        <span class="stat-value">${player2.puntosRanking.toFixed(1)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Partidos Jugados</span>
                        <span class="stat-value">${player2.matches}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Victorias</span>
                        <span class="stat-value">${player2.wins}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Winrate</span>
                        <span class="stat-value">${winrate2}%</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Sets (G-P)</span>
                        <span class="stat-value">${sets2}</span>
                    </div>
                </div>
            </div>
            <div class="comparison-summary">
                <h5>📈 Diferencias Clave</h5>
                <div class="stat-row">
                    <span class="stat-label">Diferencia de Puntos</span>
                    <span class="stat-difference ${diffClass(diffPuntos)}">${diffPuntos > 0 ? '+' : ''}${diffPuntos}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Diferencia de Nivel</span>
                    <span class="stat-difference ${diffClass(diffNivel)}">${diffNivel > 0 ? '+' : ''}${diffNivel}</span>
                </div>
                <div class="summary-text">
                    ${diffPuntos > 0 ? `${player1.name} tiene ${Math.abs(diffPuntos)} puntos más que ${player2.name}.` : diffPuntos < 0 ? `${player2.name} tiene ${Math.abs(diffPuntos)} puntos más que ${player1.name}.` : 'Ambos jugadores tienen los mismos puntos de ranking.'}
                    <br>
                    ${diffNivel > 0 ? `${player1.name} tiene un nivel ${Math.abs(diffNivel)} superior a ${player2.name}.` : diffNivel < 0 ? `${player2.name} tiene un nivel ${Math.abs(diffNivel)} superior a ${player1.name}.` : 'Ambos jugadores tienen el mismo nivel.'}
                </div>
            </div>
        `;
        statsDiv.style.display = 'block';
    }

    // Inicializar funcionalidad de comparación
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🚀 Inicializando funcionalidad de comparación...');
      
      // Cargar usuarios en selects después de que se carguen los datos
      setTimeout(() => {
        cargarUsuariosEnSelects();
      }, 1000);
      
      // Event listeners para selects
      const player1Select = document.getElementById('player1Select');
      const player2Select = document.getElementById('player2Select');
      const compareBtn = document.getElementById('compareBtn');
      
      if (player1Select) {
        player1Select.addEventListener('change', actualizarBotonComparacion);
        console.log('✅ Event listener añadido a player1Select');
      }
      
      if (player2Select) {
        player2Select.addEventListener('change', actualizarBotonComparacion);
        console.log('✅ Event listener añadido a player2Select');
      }
      
      if (compareBtn) {
        compareBtn.addEventListener('click', compararUsuarios);
        console.log('✅ Event listener añadido a compareBtn');
      }
      
      console.log('✅ Funcionalidad de comparación inicializada');
    });
    </script>
    <script src="./js/menu-hamburguesa.js"></script>
    <script type="module" src="./js/enlaceAdmin.js"></script>
    <script type="module" src="./js/usuario-session.js"></script>

    <script>
    // Función para calcular puntos de inicio basados en nivel
    function calcularPuntosInicio(nivel) {
      const nivelBase = 2.0;
      const puntosBase = 500;
      const puntosPorNivel = 1.5;
      
      if (nivel <= nivelBase) {
        return puntosBase;
      }
      
      const diferenciaNivel = nivel - nivelBase;
      const incremento = diferenciaNivel * 100 * puntosPorNivel; // 100 * 1.5 = 150 por cada 0.01
      
      return puntosBase + incremento;
    }

    // Clase SistemaPuntuacionAvanzado para el cálculo de puntos y nivel
    class SistemaPuntuacionAvanzado {
      calcularCambio({
        jugador,
        rivales,
        resultado, // 1 victoria, 0 derrota
        tipoPartido,
        margenSets,
        experiencia,
        racha,
        setsJugados,
        companero,
        formaRivales,
        esPartidoDecisivo,
        diasSinJugar
      }) {
        // === SISTEMA ELO MEJORADO ===
        const avgRivalElo = rivales.reduce((acc, r) => acc + (r.puntosRanking || calcularPuntosInicio(2.0)), 0) / rivales.length;
        const expected = 1 / (1 + Math.pow(10, (avgRivalElo - (jugador.puntosRanking || calcularPuntosInicio(2.0))) / 400));
        
        // Factor K más equilibrado para cambios menores
        let k = 20; // Reducido de 32
        if (jugador.matches >= 30) k = 12; // Reducido de 16
        else if (jugador.matches >= 10) k = 16; // Reducido de 24
        
        const ri = resultado;
        const cambioElo = k * (ri - expected);
        
        // === FACTORES ADICIONALES MEJORADOS ===
        // Eliminamos la base fija y usamos solo factores dinámicos
        
        // Factor de margen de sets mejorado (basado en diferencia de nivel)
        const nivelRivales = rivales.reduce((a, r) => a + (r.nivel || 2), 0) / rivales.length;
        const diffNivel = nivelRivales - (jugador.nivel || 2);
        const factorResultado = resultado === 1 ? 1 : -1;
        
        // Margen de sets más sensible a la diferencia de nivel (aumentado)
        const factorSets = margenSets * (2.5 + Math.abs(diffNivel) * 0.5) * factorResultado;
        
        // Racha mejorada (máximo ±5 puntos)
        const factorRacha = Math.max(-5, Math.min(5, (racha || 0) * 1.2));
        
        // Experiencia aumentada
        const factorExp = Math.min(4, experiencia * 0.6);
        
        // Factor compañero mejorado (más influyente)
        let factorComp = 0;
        if (companero) {
          const diffCompanero = (companero.nivel || 2) - (jugador.nivel || 2);
          const diffPuntosCompanero = (companero.puntosRanking || calcularPuntosInicio(2.0)) - (jugador.puntosRanking || calcularPuntosInicio(2.0));
          // Penalización por jugar con compañero inferior, bonificación por superior
          factorComp = (diffCompanero * 3.5 + diffPuntosCompanero * 0.002) * factorResultado;
          factorComp = Math.max(-6, Math.min(6, factorComp)); // Límite ±6 puntos
        }
        
        // Forma de rivales mejorada (basada en puntosRanking actual)
        const avgRivalPuntos = rivales.reduce((a, r) => a + (r.puntosRanking || calcularPuntosInicio(2.0)), 0) / rivales.length;
        const diffPuntosRivales = avgRivalPuntos - (jugador.puntosRanking || calcularPuntosInicio(2.0));
        const factorFormaRivales = diffPuntosRivales * 0.003 * factorResultado;
        
        // Factor decisivo aumentado
        const factorDecisivo = esPartidoDecisivo ? 4 : 0;
        
        // Días sin jugar mejorado
        const factorDias = diasSinJugar ? -Math.min(4, diasSinJugar * 0.2) : 0;
        
        // Dificultad basada en nivel y puntosRanking (aumentada)
        const factorDificultad = (diffNivel * 6 + diffPuntosRivales * 0.002) * factorResultado;
        
        // Factor de tipo de partido (sin base fija)
        const factorTipo = tipoPartido === 'liga' ? 1.3 : tipoPartido === 'reto' ? 1.1 : 0.9;
        
        const factoresAdicionales = (factorSets + factorRacha + factorExp + factorComp + factorFormaRivales + factorDecisivo + factorDias + factorDificultad) * factorTipo;
        
        // === CÁLCULO FINAL ===
        const sumaTotal = cambioElo + factoresAdicionales;
        const cambio = Math.max(-40, Math.min(40, sumaTotal)); // Límite reducido a ±40
        const limiteAplicado = sumaTotal !== cambio;
        
        // === CÁLCULO DE NIVEL MEJORADO ===
        // Base más pequeña y equilibrada
        let baseNivel = tipoPartido === 'liga' ? 0.008 : tipoPartido === 'reto' ? 0.006 : 0.004;
        
        // Factor de dificultad basado en nivel y puntosRanking
        const factorDificultadNivel = 1 + (diffNivel * 0.8 + diffPuntosRivales * 0.0001) * factorResultado;
        
        // Factor marcador más equilibrado
        const factorMarcador = 1 + (Math.abs(margenSets) * 0.08);
        
        // Factor racha para nivel (más sutil)
        const factorRachaNivel = 1 + (Math.sign(racha) * Math.min(Math.abs(racha), 3) * 0.02);
        
        // Factor experiencia para nivel (estabilizador)
        const factorExpNivel = 1 - Math.min(experiencia, 20) * 0.005;
        
        // Factor compañero para nivel
        let factorCompaneroNivel = 1;
        if (companero) {
          const diffCompaneroNivel = (companero.nivel || 2) - (jugador.nivel || 2);
          factorCompaneroNivel = 1 + (diffCompaneroNivel * 0.1 * factorResultado);
        }
        
        // Cálculo final del cambio de nivel
        let cambioNivel = baseNivel * factorResultado * factorDificultadNivel * factorMarcador * factorRachaNivel * factorExpNivel * factorCompaneroNivel;
        
        // Límites más estrictos para el nivel
        cambioNivel = Math.max(-0.03, Math.min(0.03, cambioNivel));
        
        // Ajuste adicional: victoria contra rival inferior o derrota contra superior
        if ((resultado === 1 && diffNivel < -0.5) || (resultado === 0 && diffNivel > 0.5)) {
          cambioNivel *= 1.2; // 20% más de cambio en casos extremos
          cambioNivel = Math.max(-0.03, Math.min(0.03, cambioNivel));
        }
        
        return {
          puntos: cambio,
          cambioNivel: cambioNivel,
          cambioElo: cambioElo,
          factoresAdicionales: factoresAdicionales,
          sumaTotal: sumaTotal,
          limiteAplicado: limiteAplicado,
          desglose: {
            margenSets: factorSets,
            racha: factorRacha,
            experiencia: factorExp,
            companero: factorComp,
            formaRivales: factorFormaRivales,
            decisivo: factorDecisivo,
            diasSinJugar: factorDias,
            dificultad: factorDificultad,
            tipoPartido: factorTipo,
            baseNivel,
            factorDificultadNivel,
            factorMarcador,
            factorRachaNivel,
            factorExpNivel,
            factorCompaneroNivel
          }
        };
      }
    }
    </script>

    <script>
    // Mostrar datos comparativos en texto debajo de la gráfica
    function mostrarDatosComparativos(player1, player2) {
        if (!player1 || !player2) return;
        const statsDiv = document.getElementById('comparisonStats');
        if (!statsDiv) return;

        // Calcular winrate y sets
        const winrate1 = player1.matches > 0 ? ((player1.wins / player1.matches) * 100).toFixed(1) : '0';
        const winrate2 = player2.matches > 0 ? ((player2.wins / player2.matches) * 100).toFixed(1) : '0';
        const sets1 = player1.setsWon + '-' + player1.setsLost;
        const sets2 = player2.setsWon + '-' + player2.setsLost;
        
        // Diferencias
        const diffPuntos = (player1.puntosRanking - player2.puntosRanking).toFixed(1);
        const diffNivel = (player1.nivel - player2.nivel).toFixed(3);
        
        function diffClass(val) {
            if (val > 0) return 'positive';
            if (val < 0) return 'negative';
            return 'neutral';
        }
        
        // HTML con diseño de lista mejorado
        statsDiv.innerHTML = `
            <h4>📊 Comparativa de Puntos y Niveles</h4>
            <div class="stats-grid">
                <div class="stat-comparison">
                    <h5>${player1.name}</h5>
                    <div class="stat-row">
                        <span class="stat-label">Nivel Actual</span>
                        <span class="stat-value">${player1.nivel.toFixed(3)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Puntos Ranking</span>
                        <span class="stat-value">${player1.puntosRanking.toFixed(1)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Partidos Jugados</span>
                        <span class="stat-value">${player1.matches}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Victorias</span>
                        <span class="stat-value">${player1.wins}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Winrate</span>
                        <span class="stat-value">${winrate1}%</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Sets (G-P)</span>
                        <span class="stat-value">${sets1}</span>
                    </div>
                </div>
                <div class="stat-comparison">
                    <h5>${player2.name}</h5>
                    <div class="stat-row">
                        <span class="stat-label">Nivel Actual</span>
                        <span class="stat-value">${player2.nivel.toFixed(3)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Puntos Ranking</span>
                        <span class="stat-value">${player2.puntosRanking.toFixed(1)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Partidos Jugados</span>
                        <span class="stat-value">${player2.matches}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Victorias</span>
                        <span class="stat-value">${player2.wins}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Winrate</span>
                        <span class="stat-value">${winrate2}%</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Sets (G-P)</span>
                        <span class="stat-value">${sets2}</span>
                    </div>
                </div>
            </div>
            <div class="comparison-summary">
                <h5>📈 Diferencias Clave</h5>
                <div class="stat-row">
                    <span class="stat-label">Diferencia de Puntos</span>
                    <span class="stat-difference ${diffClass(diffPuntos)}">${diffPuntos > 0 ? '+' : ''}${diffPuntos}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Diferencia de Nivel</span>
                    <span class="stat-difference ${diffClass(diffNivel)}">${diffNivel > 0 ? '+' : ''}${diffNivel}</span>
                </div>
                <div class="summary-text">
                    ${diffPuntos > 0 ? `${player1.name} tiene ${Math.abs(diffPuntos)} puntos más que ${player2.name}.` : diffPuntos < 0 ? `${player2.name} tiene ${Math.abs(diffPuntos)} puntos más que ${player1.name}.` : 'Ambos jugadores tienen los mismos puntos de ranking.'}
                    <br>
                    ${diffNivel > 0 ? `${player1.name} tiene un nivel ${Math.abs(diffNivel)} superior a ${player2.name}.` : diffNivel < 0 ? `${player2.name} tiene un nivel ${Math.abs(diffNivel)} superior a ${player1.name}.` : 'Ambos jugadores tienen el mismo nivel.'}
                </div>
            </div>
        `;
        statsDiv.style.display = 'block';
    }

    // Modificar la función compararUsuarios para mostrar los datos comparativos
    const compararUsuariosOriginal = compararUsuarios;
    function compararUsuarios() {
        compararUsuariosOriginal();
        // Obtener los jugadores seleccionados
        const player1Id = document.getElementById('player1Select').value;
        const player2Id = document.getElementById('player2Select').value;
        const player1 = players.find(p => p.id === player1Id);
        const player2 = players.find(p => p.id === player2Id);
        mostrarDatosComparativos(player1, player2);
    }
    // Sobrescribir el event listener si ya existe
    const compareBtn = document.getElementById('compareBtn');
    if (compareBtn) {
        compareBtn.removeEventListener('click', compararUsuariosOriginal);
        compareBtn.addEventListener('click', compararUsuarios);
    }
    </script>
</body>
</html> 
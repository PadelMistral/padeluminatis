<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>Simulador Visual Real - Ranking P√°del</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
            margin: 0;
            margin-top: 80px; /* A√±adir margen para el header */
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }
        
        .page-header {
            text-align: center;
            padding: 15px;
            margin-bottom: 20px;
            margin-top: 90px; /* margen para header fijo */
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }
        
        .page-header h1 {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .page-header .subtitle {
            font-size: clamp(0.9rem, 2.5vw, 1.2rem);
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .panel-title {
            font-size: clamp(1.2rem, 3vw, 1.5rem);
            margin-top: 0;
            margin-bottom: 15px;
            color: #ffcc00;
            display: flex;
            align-items: center;
        }
        
        .panel-title i {
            margin-right: 8px;
        }
        
        .table-container {
            width: 100%;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 1rem;
        }
        
        .ranking-table th {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 4px;
            text-align: left;
            font-weight: 600;
            font-size: 1rem;
            white-space: nowrap;
        }
        
        .ranking-table td {
            padding: 8px 4px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 1rem;
        }
        
        .ranking-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* Top 10 con efectos especiales */
        .ranking-table tr:nth-child(1) {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 204, 0, 0.1));
            border-left: 3px solid #ffd700;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        }
        
        .ranking-table tr:nth-child(2) {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.2), rgba(169, 169, 169, 0.1));
            border-left: 3px solid #c0c0c0;
            box-shadow: 0 2px 8px rgba(192, 192, 192, 0.3);
        }
        
        .ranking-table tr:nth-child(3) {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.2), rgba(184, 115, 51, 0.1));
            border-left: 3px solid #cd7f32;
            box-shadow: 0 2px 8px rgba(205, 127, 50, 0.3);
        }
        
        .ranking-table tr:nth-child(4) {
            background: rgba(52, 152, 219, 0.15);
            border-left: 2px solid #3498db;
        }
        
        .ranking-table tr:nth-child(5) {
            background: rgba(52, 152, 219, 0.12);
            border-left: 2px solid #3498db;
        }
        
        .ranking-table tr:nth-child(6) {
            background: rgba(231, 76, 60, 0.15);
            border-left: 2px solid #e74c3c;
        }
        
        .ranking-table tr:nth-child(7) {
            background: rgba(241, 196, 15, 0.15);
            border-left: 2px solid #f1c40f;
        }
        
        .ranking-table tr:nth-child(8) {
            background: rgba(26, 188, 156, 0.15);
            border-left: 2px solid #1abc9c;
        }
        
        .ranking-table tr:nth-child(9) {
            background: rgba(155, 89, 182, 0.15);
            border-left: 2px solid #9b59b6;
        }
        
        .ranking-table tr:nth-child(10) {
            background: rgba(46, 204, 113, 0.15);
            border-left: 2px solid #2ecc71;
        }
        
        .elo-change {
            display: inline-block;
            padding: 1px 3px;
            border-radius: 6px;
            font-size: 0.6rem;
            font-weight: bold;
        }
        
        .elo-up {
            background: rgba(46, 204, 113, 0.3);
            color: #2ecc71;
        }
        
        .elo-down {
            background: rgba(231, 76, 60, 0.3);
            color: #e74c3c;
        }
        
        .position-change {
            display: inline-block;
            padding: 1px 2px;
            border-radius: 4px;
            font-size: 0.55rem;
            font-weight: bold;
            margin-left: 2px;
        }
        
        .position-up {
            background: rgba(46, 204, 113, 0.3);
            color: #2ecc71;
        }
        
        .position-down {
            background: rgba(231, 76, 60, 0.3);
            color: #e74c3c;
        }
        
        .position-same {
            background: rgba(149, 165, 166, 0.3);
            color: #95a5a6;
        }
        
        .match-result {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .teams {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 25px 0;
        }
        
        .team {
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            width: 45%;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .team.winner {
            background: rgba(46, 204, 113, 0.2);
            border: 2px solid #2ecc71;
        }
        
        .vs {
            font-size: 2rem;
            font-weight: bold;
            color: #ffcc00;
        }
        
        .player {
            font-size: 1.2rem;
            margin: 8px 0;
        }
        
        .sets {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 15px 0;
        }
        
        .set-score {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: bold;
            min-width: 60px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ffcc00;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .elo-difference {
            font-size: 1.1rem;
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .history {
            margin-top: 25px;
        }
        
        .history h3 {
            color: #ffcc00;
            margin-bottom: 15px;
        }
        
        .history-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 3px solid #ffcc00;
            font-size: 0.9rem;
        }
        
        .positive {
            color: #2ecc71;
        }
        
        .negative {
            color: #e74c3c;
        }
        
        .desglose-detallado {
            margin-top: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .desglose-detallado h3 {
            color: #ffcc00;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .desglose-partido {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .desglose-partido h4 {
            color: #ff9a00;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .jugador-desglose {
            margin: 10px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            border-left: 3px solid #ffcc00;
        }
        
        .jugador-nombre {
            font-weight: bold;
            color: #ffcc00;
            margin-bottom: 8px;
        }
        
        .factor-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 3px 0;
            font-size: 0.8rem;
        }
        
        .factor-nombre {
            color: #ccc;
        }
        
        .factor-valor {
            font-weight: bold;
        }
        
        .factor-positivo {
            color: #2ecc71;
        }
        
        .factor-negativo {
            color: #e74c3c;
        }
        
        .factor-neutral {
            color: #f39c12;
        }
        
        .total-cambio {
            margin-top: 10px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }
        
        .total-positivo {
            color: #2ecc71;
            border: 1px solid #2ecc71;
        }
        
        .total-negativo {
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }
        
        /* Responsive design */
        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .teams {
                flex-direction: column;
                gap: 20px;
            }
            
            .team {
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .page-header h1 {
                font-size: 2rem;
            }
            
            .page-header .subtitle {
                font-size: 1rem;
            }
            
            .panel {
                padding: 15px;
            }
            
            .ranking-table {
                font-size: 0.7rem;
            }
            
            .ranking-table th,
            .ranking-table td {
                padding: 6px 3px;
                font-size: 0.7rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .factor-item {
                flex-direction: column;
                gap: 2px;
            }
        }
        
        /* Responsive para pantallas muy peque√±as */
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            .panel {
                padding: 10px;
            }
            
            .ranking-table {
                font-size: 0.6rem;
            }
            
            .ranking-table th,
            .ranking-table td {
                padding: 4px 2px;
                font-size: 0.6rem;
            }
            
            .ranking-table th {
                font-size: 0.55rem;
            }
            
            .elo-change {
                font-size: 0.5rem;
                padding: 1px 2px;
            }
            
            .position-change {
                font-size: 0.45rem;
                padding: 1px 1px;
            }
        }
        
        /* Responsive para tablets */
        @media (min-width: 481px) and (max-width: 768px) {
            .ranking-table {
                font-size: 0.75rem;
            }
            
            .ranking-table th,
            .ranking-table td {
                padding: 6px 3px;
                font-size: 0.75rem;
            }
        }
        
        /* Responsive para pantallas medianas */
        @media (min-width: 769px) and (max-width: 1024px) {
            .ranking-table {
                font-size: 0.8rem;
            }
            
            .ranking-table th,
            .ranking-table td {
                padding: 7px 4px;
                font-size: 0.8rem;
            }
        }
        
        /* Responsive para pantallas grandes */
        @media (min-width: 1025px) {
            .ranking-table {
                font-size: 0.85rem;
            }
            
            .ranking-table th,
            .ranking-table td {
                padding: 8px 5px;
                font-size: 0.85rem;
            }
        }
        
        /* Scrollbar personalizado */
        .container::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        .container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
        
        .container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Estilos para el modal */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to {
                opacity: 1;
                backdrop-filter: blur(10px);
            }
        }

        .modal-content {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            margin: 3% auto;
            padding: 25px;
            border-radius: 15px;
            width: 95%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            color: #fff;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: modalSlideIn 0.4s ease-out;
            position: relative;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            animation: shimmer 3s infinite;
            pointer-events: none;
            border-radius: 15px;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            z-index: 10;
        }

        .close:hover {
            color: #fff;
            animation: pulse 0.3s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .player-info {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .player-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stat-label {
            font-weight: bold;
            color: #f1c40f;
            font-size: 0.9rem;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: bold;
        }

        .match-history {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .match-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a4190);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .nav-btn:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        #matchCounter {
            font-weight: bold;
            color: #f1c40f;
            font-size: 0.9rem;
        }

        .match-details {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .match-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .match-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        .match-factors {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .factor-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.9rem;
        }

        .factor-item:last-child {
            border-bottom: none;
        }

        .factor-nombre {
            font-weight: bold;
            flex: 1;
        }

        .factor-valor {
            font-weight: bold;
            padding: 3px 6px;
            border-radius: 4px;
            min-width: 60px;
            text-align: center;
        }

        .factor-positivo {
            background: rgba(46, 204, 113, 0.3);
            color: #2ecc71;
            border: 1px solid rgba(46, 204, 113, 0.5);
        }

        .factor-negativo {
            background: rgba(231, 76, 60, 0.3);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.5);
        }

        .factor-neutral {
            background: rgba(149, 165, 166, 0.3);
            color: #95a5a6;
            border: 1px solid rgba(149, 165, 166, 0.5);
        }

        .total-cambio {
            margin-top: 12px;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            font-size: 1rem;
            font-weight: bold;
            border: 2px solid;
        }

        .total-positivo {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            border-color: rgba(46, 204, 113, 0.5);
        }

        .total-negativo {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border-color: rgba(231, 76, 60, 0.5);
        }

        /* Hacer las filas de la tabla clickeables */
        .ranking-table tbody tr {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ranking-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="./css/header.css">
</head>
<body>
    <header class="app-header">
        <div class="header-content">
            <img src="./imagenes/Logojafs.png" alt="Logo" class="app-logo">
            <h1 class="app-title">Ranking en Tiempo Real - Padeluminatis</h1>
            <button class="menu-toggle" aria-label="Men√∫">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <nav class="app-nav">
            <a href="./home.html" class="nav-item"><i class="fas fa-home"></i><span>Inicio</span></a>
            <a href="./eventos.html" class="nav-item"><i class="fas fa-calendar-check"></i><span>Eventos</span></a>
            <a href="./calendario.html" class="nav-item"><i class="fas fa-calendar-alt"></i><span>Calendario</span></a>
            <a href="./clasificacion.html" class="nav-item"><i class="fas fa-trophy"></i><span>Clasificaci√≥n</span></a>
            <a href="./normas.html" class="nav-item"><i class="fas fa-gavel"></i><span>Normas</span></a>
            <a href="./chat.html" class="nav-item"><i class="fas fa-comments"></i><span>Chat</span></a>
            <a href="./simulador-visual-real.html" class="nav-item active"><i class="fas fa-chart-line"></i><span>Ranking</span></a>
            <a href="./admin.html" class="nav-item nav-admin" style="display:none"><i class="fas fa-user-shield"></i><span>Admin</span></a>
            <a href="./perfil.html" class="nav-item"><i class="fas fa-user"></i><span>Perfil</span></a>
            <a href="./notificaciones.html" class="nav-item"><i class="fas fa-bell"></i><span>Notificaciones</span></a>
            <a href="#" class="nav-item nav-logout"><i class="fas fa-sign-out-alt"></i><span>Cerrar sesi√≥n</span></a>
        </nav>
    </header>
    
    <div class="container">
        <div class="page-header">
            <h1>üèÜ Ranking en Tiempo Real</h1>
            <p class="subtitle">Clasificaci√≥n actualizada autom√°ticamente con los √∫ltimos partidos jugados</p>
            <button onclick="mostrarInfoDebug()" style="
                background: #ffcc00;
                color: #000;
                border: none;
                padding: 8px 16px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: bold;
                margin-top: 10px;
            ">üîç Mostrar Debug Info</button>
        </div>
        
        <div class="dashboard">
            <div class="panel">
                <h3 class="panel-title">
                    <i>üèÜ</i>
                    Ranking Oficial - Puntos Elo
                </h3>
                <div style="margin-bottom: 15px; font-size: 0.9rem; opacity: 0.8;">
                    Clasificaci√≥n actualizada con todos los partidos hist√≥ricos procesados
                </div>
                <div class="table-container">
                    <table class="ranking-table">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Jugador</th>
                                <th>Nivel</th>
                                <th>Partidos</th>
                                <th>Victorias</th>
                                <th>Sets</th>
                                <th>Dificultad</th>
                                <th>Puntos Elo</th>
                            </tr>
                        </thead>
                        <tbody id="rankingBody">
                            <!-- Datos del ranking -->
                        </tbody>
                    </table>
                </div>

        </div>
    </div>

    <!-- Modal para detalles del jugador -->
    <div id="playerModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalPlayerName">Detalles del Jugador</h2>
            
            <div class="player-info">
                <div class="player-stats">
                    <div class="stat-item">
                        <span class="stat-label">Nivel:</span>
                        <span id="modalPlayerLevel" class="stat-value"></span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Puntos Ranking:</span>
                        <span id="modalPlayerPoints" class="stat-value"></span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Partidos Jugados:</span>
                        <span id="modalPlayerMatches" class="stat-value"></span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Victorias:</span>
                        <span id="modalPlayerWins" class="stat-value"></span>
                    </div>
                </div>
            </div>
            
            <div class="match-history">
                <h3>Historial de Partidos</h3>
                <div class="match-navigation">
                    <button id="prevMatch" class="nav-btn">‚Üê Anterior</button>
                    <span id="matchCounter">Partido 1 de X</span>
                    <button id="nextMatch" class="nav-btn">Siguiente ‚Üí</button>
                </div>
                
                <div id="matchDetails" class="match-details">
                    <!-- Detalles del partido actual -->
                </div>
                
                <div id="matchFactors" class="match-factors">
                    <!-- Factores del partido actual -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
    import { db, auth } from './js/firebase-config.js';
    import { collection, getDocs, onSnapshot, query, doc, updateDoc, getDoc, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";
    import { signInAnonymously } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";

    let players = [];
    let partidos = [];
    let equipos = {};
    let lastMatchDetails = null;
    let previousRanking = [];
    let unsubscribePartidos = null;
    let unsubscribeUsuarios = null;
    let procesamientoCompletado = false;

    // Autenticaci√≥n an√≥nima para acceder a los datos
    async function inicializarFirebase() {
        try {
            await signInAnonymously(auth);
            console.log('‚úÖ Autenticaci√≥n an√≥nima exitosa');
        } catch (error) {
            console.error('‚ùå Error en autenticaci√≥n:', error);
        }
    }

    // Cargar usuarios en tiempo real
    async function cargarUsuariosTiempoReal() {
        try {
            console.log('üë• Cargando usuarios...');
            
            const usuariosQuery = query(collection(db, "usuarios"));
            unsubscribeUsuarios = onSnapshot(usuariosQuery, (snapshot) => {
                console.log(`üìä Snapshot de usuarios recibido: ${snapshot.docs.length} documentos`);
                
                players = snapshot.docs.map((doc) => {
                    const data = doc.data();
                    console.log(`üë§ Procesando usuario ${doc.id}:`, data);
                    
                    const nivel = parseFloat(data.nivel) || 2.0;
                    // Si no tiene puntosRanking, calcular el inicial
                    const puntosRanking = data.puntosRanking || (1000 + (nivel * 25));
                    
                    const player = {
                        id: doc.id,
                        name: data.nombreUsuario || data.displayName || data.nombre || 'Sin nombre',
                        nivel: nivel,
                        elo: puntosRanking, // Usar puntosRanking como Elo
                        puntosRanking: puntosRanking,
                        matches: data.matches || 0,
                        wins: data.wins || 0,
                        setsWon: data.setsWon || 0,
                        setsLost: data.setsLost || 0,
                        performance: data.performance || 0,
                        difficulty: data.difficulty || 0,
                        history: data.history || [],
                        equipoId: data.equipoId || null,
                        equipoNombre: data.equipoNombre || null
                    };
                    
                    console.log(`‚úÖ Usuario procesado: ${player.name} (${player.nivel}) - ${player.elo} puntos`);
                    return player;
                });
                
                console.log(`‚úÖ Total usuarios cargados: ${players.length}`);
                console.log('üìã Lista completa de usuarios:');
                players.forEach((p, index) => {
                    console.log(`${index + 1}. ${p.name} - Nivel: ${p.nivel} - Puntos: ${p.elo}`);
                });
                
                // Si es la primera carga y no se han procesado partidos, procesarlos
                if (!procesamientoCompletado && players.length > 0) {
                    procesarPartidosHistoricos();
                } else {
                    // Actualizar tabla de ranking inmediatamente
                    updateRankingTable();
                    actualizarInformacionSistema();
                }
            });
        } catch (error) {
            console.error('‚ùå Error cargando usuarios:', error);
        }
    }

    // Cargar equipos
    async function cargarEquipos() {
        try {
            const equiposSnap = await getDocs(collection(db, "equipos"));
            equipos = {};
            equiposSnap.docs.forEach(doc => {
                const data = doc.data();
                equipos[doc.id] = {
                    id: doc.id,
                    nombre: data.nombre || `Equipo ${doc.id}`,
                    jugadores: data.jugadores || []
                };
            });
            console.log(`‚úÖ Equipos cargados: ${Object.keys(equipos).length}`);
        } catch (error) {
            console.error('‚ùå Error cargando equipos:', error);
        }
    }

    // Funci√≥n para calcular el resultado de un partido
    function calcularResultadoPartido(resultado) {
        let setsLocal = 0, setsVisitante = 0, juegosLocal = 0, juegosVisitante = 0;
        Object.values(resultado)
            .filter(set => set && typeof set.puntos1 === 'number' && typeof set.puntos2 === 'number')
            .forEach(set => {
                if (set.puntos1 > set.puntos2) setsLocal++;
                else if (set.puntos2 > set.puntos1) setsVisitante++;
                juegosLocal += set.puntos1 || 0;
                juegosVisitante += set.puntos2 || 0;
            });
        return { setsLocal, setsVisitante, juegosLocal, juegosVisitante };
    }

    // Funci√≥n para actualizar datos en Firestore
    async function actualizarDatosEnFirestore() {
        try {
            const batch = writeBatch(db);
            for (const player of players) {
                const userRef = doc(db, 'usuarios', player.id);
                batch.update(userRef, {
                    puntosRanking: player.elo,
                    partidosJugados: player.matches,
                    victorias: player.wins,
                    setsGanados: player.setsWon,
                    setsPerdidos: player.setsLost,
                    performance: player.performance,
                    difficulty: player.difficulty,
                    history: player.history,
                    ultimaActualizacion: serverTimestamp()
                });
            }
            await batch.commit();
            console.log('‚úÖ Datos actualizados en Firestore correctamente');
        } catch (error) {
            console.error('‚ùå Error actualizando datos en Firestore:', error);
        }
    }

    // Cargar partidos en tiempo real
    async function cargarPartidosTiempoReal() {
        try {
            console.log('üéæ Cargando partidos...');
            
            let todosLosPartidos = [];
            
            // 1. Cargar partidos de liga (calendario)
            console.log('üìÖ Cargando partidos de liga...');
            const calendarioQuery = query(collection(db, "calendario"));
            const calendarioSnapshot = await getDocs(calendarioQuery);
            console.log(`üìÖ Jornadas encontradas: ${calendarioSnapshot.docs.length}`);
            
            for (const jornadaDoc of calendarioSnapshot.docs) {
                console.log(`üìÖ Procesando jornada: ${jornadaDoc.id}`);
                const partidosQuery = query(collection(db, `calendario/${jornadaDoc.id}/partidos`));
                const partidosSnapshot = await getDocs(partidosQuery);
                console.log(`üìÖ Partidos en jornada ${jornadaDoc.id}: ${partidosSnapshot.docs.length}`);
                
                partidosSnapshot.docs.forEach(partidoDoc => {
                    const partido = partidoDoc.data();
                    if (partido.resultado && partido.resultado.set1) {
                        todosLosPartidos.push({
                            ...partido,
                            id: partidoDoc.id,
                            tipo: 'liga',
                            fecha: partido.fecha?.toDate() || new Date(),
                            equipoLocalId: partido.equipoLocal,
                            equipoVisitanteId: partido.equipoVisitante,
                            jornadaId: jornadaDoc.id
                        });
                    }
                });
            }

            // 2. Cargar partidos amistosos
            console.log('ü§ù Cargando partidos amistosos...');
            const amistososQuery = query(collection(db, "partidosAmistosos"));
            const amistososSnapshot = await getDocs(amistososQuery);
            console.log(`ü§ù Partidos amistosos encontrados: ${amistososSnapshot.docs.length}`);
            
            amistososSnapshot.docs.forEach(doc => {
                const partido = doc.data();
                if (partido.resultado && partido.resultado.set1) {
                    todosLosPartidos.push({
                        ...partido,
                        id: doc.id,
                        tipo: 'amistoso',
                        fecha: partido.fecha?.toDate() || new Date(),
                        jugadores: partido.jugadores || []
                    });
                }
            });

            // 3. Cargar partidos de reto
            console.log('‚öîÔ∏è Cargando partidos de reto...');
            const retosQuery = query(collection(db, "partidosReto"));
            const retosSnapshot = await getDocs(retosQuery);
            console.log(`‚öîÔ∏è Partidos de reto encontrados: ${retosSnapshot.docs.length}`);
            
            retosSnapshot.docs.forEach(doc => {
                const partido = doc.data();
                if (partido.resultado && partido.resultado.set1) {
                    todosLosPartidos.push({
                        ...partido,
                        id: doc.id,
                        tipo: 'reto',
                        fecha: partido.fecha?.toDate() || new Date(),
                        jugadores: partido.jugadores || []
                    });
                }
            });

            // Ordenar por fecha (m√°s antigua a m√°s reciente)
            partidos = todosLosPartidos.sort((a, b) => a.fecha - b.fecha);
            
            console.log(`‚úÖ Total de partidos cargados: ${partidos.length}`);
            console.log('üìä Distribuci√≥n por tipo:');
            const distribucion = partidos.reduce((acc, p) => {
                acc[p.tipo] = (acc[p.tipo] || 0) + 1;
                return acc;
            }, {});
            console.log(distribucion);
            
            // Configurar listener para nuevos partidos
            configurarListenerPartidos();
            
        } catch (error) {
            console.error('‚ùå Error cargando partidos:', error);
        }
    }

    // Procesar todos los partidos hist√≥ricos con l√≥gica Elo (como el bot√≥n simular)
    async function procesarPartidosHistoricos() {
        try {
            console.log('üîÑ Iniciando procesamiento autom√°tico de partidos hist√≥ricos...');
            
            if (partidos.length === 0) {
                console.log('‚ÑπÔ∏è No hay partidos hist√≥ricos para procesar');
                procesamientoCompletado = true;
                updateRankingTable();
                actualizarInformacionSistema();
                return;
            }
            
            if (players.length === 0) {
                console.log('‚ö†Ô∏è No hay jugadores cargados para procesar partidos');
                return;
            }
            
            // Resetear todos los jugadores a valores iniciales basados en sus niveles actuales
            players.forEach((player, idx) => {
                player.elo = 1000 + (player.nivel * 25); // Puntos Elo reales basados en nivel
                player.puntosRanking = player.elo; // Mantener sincronizado
                player.matches = 0;
                player.wins = 0;
                player.setsWon = 0;
                player.setsLost = 0;
                player.performance = 0;
                player.difficulty = 0;
                player.history = [];
            });
            
            console.log(`üìä Procesando ${partidos.length} partidos hist√≥ricos autom√°ticamente...`);
            
            // Procesar partidos uno por uno (como el bot√≥n simular)
            for (let i = 0; i < partidos.length; i++) {
                const partido = partidos[i];
                
                console.log(`üéæ Procesando partido ${i + 1}/${partidos.length}: ${partido.tipo} - ${partido.id}`);
                
                await procesarPartidoComoSimulacion(partido);
                
                // Peque√±a pausa para no sobrecargar
                await new Promise(resolve => setTimeout(resolve, 40));
            }
            
            procesamientoCompletado = true;
            
            // Actualizar Firestore con los nuevos datos
            await actualizarDatosEnFirestore();
            
            // Actualizar tabla y mostrar resultados
            updateRankingTable();
            actualizarInformacionSistema();
            
            console.log('‚úÖ Procesamiento de partidos hist√≥ricos completado');
            
        } catch (error) {
            console.error('‚ùå Error procesando partidos hist√≥ricos:', error);
        }
    }

    // Funci√≥n corregida para procesar un partido individual
    async function procesarPartidoComoSimulacion(partido) {
        try {
            // Obtener jugadores del partido
            let team1 = [], team2 = [];
            
            if (partido.tipo === 'liga') {
                // Partidos de liga: obtener jugadores de equipos
                const equipoLocal = equipos[partido.equipoLocalId];
                const equipoVisitante = equipos[partido.equipoVisitanteId];
                
                if (!equipoLocal || !equipoVisitante) {
                    console.warn(`‚ö†Ô∏è Equipos no encontrados para partido ${partido.id}`);
                    return;
                }
                
                team1 = equipoLocal.jugadores.map(id => players.find(p => p.id === id)).filter(p => p);
                team2 = equipoVisitante.jugadores.map(id => players.find(p => p.id === id)).filter(p => p);
                
            } else {
                // Partidos amistosos/reto: jugadores directos
                team1 = partido.jugadores.slice(0, 2).map(id => players.find(p => p.id === id)).filter(p => p);
                team2 = partido.jugadores.slice(2, 4).map(id => players.find(p => p.id === id)).filter(p => p);
            }
            
            if (team1.length !== 2 || team2.length !== 2) {
                console.warn(`‚ö†Ô∏è No se pudieron obtener 4 jugadores para partido ${partido.id}`);
                return;
            }
            
            // Calcular resultado del partido
            const resultado = calcularResultadoPartido(partido.resultado);
            const team1Wins = resultado.setsLocal > resultado.setsVisitante;
            
            // Calcular estad√≠sticas del partido
            const stats = {
                totalSets: resultado.setsLocal + resultado.setsVisitante,
                totalGames: resultado.juegosLocal + resultado.juegosVisitante,
                averageGamesPerSet: (resultado.juegosLocal + resultado.juegosVisitante) / (resultado.setsLocal + resultado.setsVisitante)
            };
            
            // Calcular Elo esperado
            const elo1 = (team1[0].elo + team1[1].elo) / 2;
            const elo2 = (team2[0].elo + team2[1].elo) / 2;
            const expected1 = 1 / (1 + Math.pow(10, (elo2 - elo1) / 400));
            const expected2 = 1 - expected1;
            
            // Calcular rating individual
            const ri1 = team1Wins ? 1 : 0;
            const ri2 = team1Wins ? 0 : 1;
            
            // Calcular factor de dificultad
            const fd1 = Math.abs(elo2 - elo1) / 400;
            const fd2 = Math.abs(elo1 - elo2) / 400;
            
            // Procesar equipo 1
            team1.forEach(player => {
                const k = player.matches < 10 ? 32 : 16;
                const change = k * ((team1Wins ? 1 : 0) - expected1) + ri1 * 0.5;
                const finalChange = change * fd1;
                
                // Factores individuales
                const factorNivelPartido = ((team1[0].nivel + team1[1].nivel + team2[0].nivel + team2[1].nivel) / 4 - 2.0) * 3.5;
                const comp = team1[0] === player ? team1[1] : team1[0];
                const factorCompanero = (player.nivel - comp.nivel) * 4.2;
                const factorRivales = ((team2[0].nivel + team2[1].nivel) / 2 - player.nivel) * 5.1;
                const diffJuegos = Math.abs(resultado.juegosLocal - resultado.juegosVisitante);
                const factorMarcador = team1Wins ? diffJuegos * 2.2 : -diffJuegos * 1.5;
                const factorNivelIndividual = (player.nivel - 2.0) * 3.8;
                
                let factorTipoPartido = 0;
                switch (partido.tipo) {
                    case 'liga': factorTipoPartido = 3.5; break;
                    case 'reto': factorTipoPartido = 2.8; break;
                    case 'amistoso': factorTipoPartido = 1.2; break;
                    default: factorTipoPartido = 1.5;
                }
                
                const factorExperiencia = Math.min(2.5, player.matches * 0.15);
                
                let factorRacha = 0;
                if (player.matches > 0) {
                    const porcentajeVictorias = (player.wins / player.matches) * 100;
                    if (porcentajeVictorias < 30) factorRacha = 2.1;
                    else if (porcentajeVictorias > 70) factorRacha = -1.8;
                }
                
                let factorPresion = 0;
                if (partido.tipo === 'liga' && player.matches < 5) factorPresion = 1.8;
                else if (partido.tipo === 'liga' && player.matches > 20) factorPresion = -0.9;
                
                let factorConsistencia = 0;
                if (player.history.length > 3) {
                    const ultimos3 = player.history.slice(-3).map(h => h.change);
                    const variacion = Math.abs(ultimos3[2] - ultimos3[0]) / Math.abs(ultimos3[0] || 1);
                    if (variacion < 0.3) factorConsistencia = 1.5;
                    else if (variacion > 0.8) factorConsistencia = -1.2;
                }
                
                let factorMomentum = 0;
                if (player.history.length > 0) {
                    const ultimoCambio = player.history[player.history.length - 1].change;
                    if (ultimoCambio > 5) factorMomentum = 1.2;
                    else if (ultimoCambio < -5) factorMomentum = -1.0;
                }
                
                const totalJuegos = resultado.juegosLocal + resultado.juegosVisitante;
                let factorIntensidad = 0;
                if (totalJuegos > 20) factorIntensidad = 1.8;
                else if (totalJuegos > 15) factorIntensidad = 1.2;
                else if (totalJuegos < 10) factorIntensidad = -0.8;
                
                let factorClutch = 0;
                const diffSets = Math.abs(resultado.setsLocal - resultado.setsVisitante);
                const diffJuegosTotal = Math.abs(resultado.juegosLocal - resultado.juegosVisitante);
                if (diffSets === 1 && diffJuegosTotal <= 4) {
                    factorClutch = team1Wins ? 2.5 : -1.8;
                }
                
                const nivelPromedioRivales = (team2[0].nivel + team2[1].nivel) / 2;
                let factorAntiSandbagging = 0;
                if (player.nivel > 3.0 && nivelPromedioRivales < 2.5) {
                    factorAntiSandbagging = -2.8;
                } else if (player.nivel < 2.5 && nivelPromedioRivales > 3.0) {
                    factorAntiSandbagging = 2.5;
                }
                
                const miNivel = player.nivel;
                const rivalMasAlto = Math.max(team2[0].nivel, team2[1].nivel);
                const rivalMasBajo = Math.min(team2[0].nivel, team2[1].nivel);
                let factorRendimientoVsRivales = 0;
                if (miNivel > rivalMasAlto) factorRendimientoVsRivales = -1.5;
                else if (miNivel < rivalMasBajo) factorRendimientoVsRivales = 2.2;
                else factorRendimientoVsRivales = 0.8;
                
                const sumaFactoresIndividuales = factorNivelPartido + factorCompanero + factorRivales + 
                                               factorMarcador + factorNivelIndividual + factorTipoPartido + 
                                               factorExperiencia + factorRacha + factorPresion + factorConsistencia +
                                               factorMomentum + factorIntensidad + factorClutch + factorAntiSandbagging +
                                               factorRendimientoVsRivales;
                
                const puntosIndividuales = sumaFactoresIndividuales / 5.8;
                const cambioFinal = finalChange + puntosIndividuales;
                
                // Aplicar cambio al Elo
                player.elo += cambioFinal;
                player.puntosRanking = player.elo;
                player.matches++;
                if (team1Wins) player.wins++;
                player.setsWon += resultado.setsLocal;
                player.setsLost += resultado.setsVisitante;
                player.performance += ri1;
                player.difficulty += Math.round(fd1 * 100);
                player.history.push({
                    change: cambioFinal,
                    opponent: `${team2[0].name} & ${team2[1].name}`,
                    date: new Date(partido.fecha).toLocaleDateString(),
                    factores: {
                        nivelPartido: factorNivelPartido,
                        companero: factorCompanero,
                        rivales: factorRivales,
                        marcador: factorMarcador,
                        nivelIndividual: factorNivelIndividual,
                        tipoPartido: factorTipoPartido,
                        experiencia: factorExperiencia,
                        racha: factorRacha,
                        presion: factorPresion,
                        consistencia: factorConsistencia,
                        momentum: factorMomentum,
                        intensidad: factorIntensidad,
                        clutch: factorClutch,
                        antiSandbagging: factorAntiSandbagging,
                        rendimientoVsRivales: factorRendimientoVsRivales,
                        total: puntosIndividuales
                    }
                });
            });
            
            // Procesar equipo 2
            team2.forEach(player => {
                const k = player.matches < 10 ? 32 : 16;
                const change = k * ((team1Wins ? 0 : 1) - expected2) + ri2 * 0.5;
                const finalChange = change * fd2;
                
                // Factores individuales (mismo c√°lculo que equipo 1 pero con roles invertidos)
                const factorNivelPartido = ((team1[0].nivel + team1[1].nivel + team2[0].nivel + team2[1].nivel) / 4 - 2.0) * 3.5;
                const comp = team2[0] === player ? team2[1] : team2[0];
                const factorCompanero = (player.nivel - comp.nivel) * 4.2;
                const factorRivales = ((team1[0].nivel + team1[1].nivel) / 2 - player.nivel) * 5.1;
                const diffJuegos = Math.abs(resultado.juegosLocal - resultado.juegosVisitante);
                const factorMarcador = !team1Wins ? diffJuegos * 2.2 : -diffJuegos * 1.5;
                const factorNivelIndividual = (player.nivel - 2.0) * 3.8;
                
                let factorTipoPartido = 0;
                switch (partido.tipo) {
                    case 'liga': factorTipoPartido = 3.5; break;
                    case 'reto': factorTipoPartido = 2.8; break;
                    case 'amistoso': factorTipoPartido = 1.2; break;
                    default: factorTipoPartido = 1.5;
                }
                
                const factorExperiencia = Math.min(2.5, player.matches * 0.15);
                
                let factorRacha = 0;
                if (player.matches > 0) {
                    const porcentajeVictorias = (player.wins / player.matches) * 100;
                    if (porcentajeVictorias < 30) factorRacha = 2.1;
                    else if (porcentajeVictorias > 70) factorRacha = -1.8;
                }
                
                let factorPresion = 0;
                if (partido.tipo === 'liga' && player.matches < 5) factorPresion = 1.8;
                else if (partido.tipo === 'liga' && player.matches > 20) factorPresion = -0.9;
                
                let factorConsistencia = 0;
                if (player.history.length > 3) {
                    const ultimos3 = player.history.slice(-3).map(h => h.change);
                    const variacion = Math.abs(ultimos3[2] - ultimos3[0]) / Math.abs(ultimos3[0] || 1);
                    if (variacion < 0.3) factorConsistencia = 1.5;
                    else if (variacion > 0.8) factorConsistencia = -1.2;
                }
                
                let factorMomentum = 0;
                if (player.history.length > 0) {
                    const ultimoCambio = player.history[player.history.length - 1].change;
                    if (ultimoCambio > 5) factorMomentum = 1.2;
                    else if (ultimoCambio < -5) factorMomentum = -1.0;
                }
                
                const totalJuegos = resultado.juegosLocal + resultado.juegosVisitante;
                let factorIntensidad = 0;
                if (totalJuegos > 20) factorIntensidad = 1.8;
                else if (totalJuegos > 15) factorIntensidad = 1.2;
                else if (totalJuegos < 10) factorIntensidad = -0.8;
                
                let factorClutch = 0;
                const diffSets = Math.abs(resultado.setsLocal - resultado.setsVisitante);
                const diffJuegosTotal = Math.abs(resultado.juegosLocal - resultado.juegosVisitante);
                if (diffSets === 1 && diffJuegosTotal <= 4) {
                    factorClutch = !team1Wins ? 2.5 : -1.8;
                }
                
                const nivelPromedioRivales = (team1[0].nivel + team1[1].nivel) / 2;
                let factorAntiSandbagging = 0;
                if (player.nivel > 3.0 && nivelPromedioRivales < 2.5) {
                    factorAntiSandbagging = -2.8;
                } else if (player.nivel < 2.5 && nivelPromedioRivales > 3.0) {
                    factorAntiSandbagging = 2.5;
                }
                
                const miNivel = player.nivel;
                const rivalMasAlto = Math.max(team1[0].nivel, team1[1].nivel);
                const rivalMasBajo = Math.min(team1[0].nivel, team1[1].nivel);
                let factorRendimientoVsRivales = 0;
                if (miNivel > rivalMasAlto) factorRendimientoVsRivales = -1.5;
                else if (miNivel < rivalMasBajo) factorRendimientoVsRivales = 2.2;
                else factorRendimientoVsRivales = 0.8;
                
                const sumaFactoresIndividuales = factorNivelPartido + factorCompanero + factorRivales + 
                                               factorMarcador + factorNivelIndividual + factorTipoPartido + 
                                               factorExperiencia + factorRacha + factorPresion + factorConsistencia +
                                               factorMomentum + factorIntensidad + factorClutch + factorAntiSandbagging +
                                               factorRendimientoVsRivales;
                
                const puntosIndividuales = sumaFactoresIndividuales / 5.8;
                const cambioFinal = finalChange + puntosIndividuales;
                
                // Aplicar cambio al Elo
                player.elo += cambioFinal;
                player.puntosRanking = player.elo;
                player.matches++;
                if (!team1Wins) player.wins++;
                player.setsWon += resultado.setsVisitante;
                player.setsLost += resultado.setsLocal;
                player.performance += ri2;
                player.difficulty += Math.round(fd2 * 100);
                player.history.push({
                    change: cambioFinal,
                    opponent: `${team1[0].name} & ${team1[1].name}`,
                    date: new Date(partido.fecha).toLocaleDateString(),
                    factores: {
                        nivelPartido: factorNivelPartido,
                        companero: factorCompanero,
                        rivales: factorRivales,
                        marcador: factorMarcador,
                        nivelIndividual: factorNivelIndividual,
                        tipoPartido: factorTipoPartido,
                        experiencia: factorExperiencia,
                        racha: factorRacha,
                        presion: factorPresion,
                        consistencia: factorConsistencia,
                        momentum: factorMomentum,
                        intensidad: factorIntensidad,
                        clutch: factorClutch,
                        antiSandbagging: factorAntiSandbagging,
                        rendimientoVsRivales: factorRendimientoVsRivales,
                        total: puntosIndividuales
                    }
                });
            });
            
            // Guardar detalles del √∫ltimo partido para mostrar
            lastMatchDetails = {
                team1,
                team2,
                sets: [
                    { team1: resultado.juegosLocal, team2: resultado.juegosVisitante }
                ],
                team1Sets: resultado.setsLocal,
                team2Sets: resultado.setsVisitante,
                stats,
                winner: team1Wins ? 'team1' : 'team2',
                date: new Date(partido.fecha).toLocaleDateString(),
                tipo: partido.tipo
            };
            
        } catch (error) {
            console.error(`‚ùå Error procesando partido ${partido.id}:`, error);
        }
    }

    // Obtener jugadores de un equipo (como en la simulaci√≥n original)
    function obtenerJugadoresEquipo(equipoId) {
        const equipo = equipos[equipoId];
        if (!equipo || !equipo.jugadores) return [];
        return equipo.jugadores.map(jugadorId => {
            return players.find(j => j.id === jugadorId) || { id: jugadorId, name: 'Desconocido', nivel: 2.0, elo: 1050, matches: 0, wins: 0, setsWon: 0, setsLost: 0, performance: 0, difficulty: 0, history: [] };
        });
    }

    // Procesar resultado de un partido
    function procesarResultado(resultado) {
        if (!resultado || !resultado.set1) return null;
        const set1 = resultado.set1;
        const set2 = resultado.set2 || { puntos1: 0, puntos2: 0 };
        const set3 = resultado.set3 || { puntos1: 0, puntos2: 0 };
        let setsLocal = 0, setsVisitante = 0;
        let juegosLocal = 0, juegosVisitante = 0;
        if (set1.puntos1 > set1.puntos2) setsLocal++; else setsVisitante++;
        juegosLocal += set1.puntos1; juegosVisitante += set1.puntos2;
        if (set2.puntos1 > set2.puntos2) setsLocal++; else setsVisitante++;
        juegosLocal += set2.puntos1; juegosVisitante += set2.puntos2;
        if (set3.puntos1 > 0 || set3.puntos2 > 0) {
            if (set3.puntos1 > set3.puntos2) setsLocal++; else setsVisitante++;
            juegosLocal += set3.puntos1; juegosVisitante += set3.puntos2;
        }
        return {
            setsLocal, setsVisitante, juegosLocal, juegosVisitante,
            ganador: setsLocal > setsVisitante ? 'local' : 'visitante',
            sets: [set1, set2, set3]
        };
    }

    // Calcular cambio de puntos Elo con l√≥gica avanzada
    function calcularCambioPuntosElo(player, allPlayers, resultado, team1Wins, tipoPartido) {
        const team1 = allPlayers.slice(0, 2);
        const team2 = allPlayers.slice(2, 4);
        const avgElo1 = (team1[0].elo + team1[1].elo) / 2;
        const avgElo2 = (team2[0].elo + team2[1].elo) / 2;
        const expected1 = 1 / (1 + Math.pow(10, (avgElo2 - avgElo1) / 400));
        const isTeam1 = team1.includes(player);
        const teamWins = isTeam1 ? team1Wins : !team1Wins;
        
        // L√≥gica de puntuaci√≥n visual cl√°sica
        const k = player.matches < 10 ? 32 : 16;
        const change = k * ((teamWins ? 1 : 0) - (isTeam1 ? expected1 : (1 - expected1)));
        
        // Factores adicionales
        const factorNivelPartido = ((team1[0].nivel + team1[1].nivel + team2[0].nivel + team2[1].nivel) / 4 - 2.0) * 3.5;
        const factorTipoPartido = tipoPartido === 'liga' ? 3.5 : tipoPartido === 'reto' ? 2.8 : 1.2;
        const factorMarcador = teamWins ? Math.abs(resultado.juegosLocal - resultado.juegosVisitante) * 2.2 : -Math.abs(resultado.juegosLocal - resultado.juegosVisitante) * 1.5;
        const factorNivelIndividual = (player.nivel - 2.0) * 3.8;
        
        // Sumar todos los factores
        const puntosIndividuales = (factorNivelPartido + factorTipoPartido + factorMarcador + factorNivelIndividual) / 4;
        
        return change + puntosIndividuales;
    }

    // Actualizar jugador en Firestore
    async function actualizarJugadorEnFirestore(player) {
        try {
            const userRef = doc(db, "usuarios", player.id);
            await updateDoc(userRef, {
                puntosRanking: player.elo,
                matches: player.matches,
                wins: player.wins,
                setsWon: player.setsWon,
                setsLost: player.setsLost,
                performance: player.performance,
                difficulty: player.difficulty,
                history: player.history
            });
            console.log(`‚úÖ Usuario ${player.name} actualizado en Firestore`);
        } catch (error) {
            console.error(`‚ùå Error actualizando usuario ${player.name}:`, error);
        }
    }

    // Configurar listener para nuevos partidos
    function configurarListenerPartidos() {
        console.log('üëÇ Configurando listeners para nuevos partidos...');
        
        // Listener para partidos de liga
        const calendarioQuery = query(collection(db, "calendario"));
        onSnapshot(calendarioQuery, (calendarioSnapshot) => {
            calendarioSnapshot.docs.forEach(jornadaDoc => {
                const partidosQuery = query(collection(db, `calendario/${jornadaDoc.id}/partidos`));
                onSnapshot(partidosQuery, (partidosSnapshot) => {
                    partidosSnapshot.docChanges().forEach(change => {
                        if (change.type === 'added' || change.type === 'modified') {
                            const partido = change.doc.data();
                            if (partido.resultado && partido.resultado.set1) {
                                console.log(`üÜï Nuevo partido de liga detectado: ${change.doc.id}`);
                                procesarNuevoPartido({
                                    ...partido,
                                    id: change.doc.id,
                                    tipo: 'liga',
                                    fecha: partido.fecha?.toDate() || new Date(),
                                    equipoLocalId: partido.equipoLocal,
                                    equipoVisitanteId: partido.equipoVisitante,
                                    jornadaId: jornadaDoc.id
                                });
                            }
                        }
                    });
                });
            });
        });

        // Listener para partidos amistosos
        const amistososQuery = query(collection(db, "partidosAmistosos"));
        onSnapshot(amistososQuery, (snapshot) => {
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added' || change.type === 'modified') {
                    const partido = change.doc.data();
                    if (partido.resultado && partido.resultado.set1) {
                        console.log(`üÜï Nuevo partido amistoso detectado: ${change.doc.id}`);
                        procesarNuevoPartido({
                            ...partido,
                            id: change.doc.id,
                            tipo: 'amistoso',
                            fecha: partido.fecha?.toDate() || new Date(),
                            jugadores: partido.jugadores || []
                        });
                    }
                }
            });
        });

        // Listener para partidos de reto
        const retosQuery = query(collection(db, "partidosReto"));
        onSnapshot(retosQuery, (snapshot) => {
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added' || change.type === 'modified') {
                    const partido = change.doc.data();
                    if (partido.resultado && partido.resultado.set1) {
                        console.log(`üÜï Nuevo partido de reto detectado: ${change.doc.id}`);
                        procesarNuevoPartido({
                            ...partido,
                            id: change.doc.id,
                            tipo: 'reto',
                            fecha: partido.fecha?.toDate() || new Date(),
                            jugadores: partido.jugadores || []
                        });
                    }
                }
            });
        });

        console.log('‚úÖ Listeners configurados para todas las colecciones');
    }

    // Procesar un nuevo partido en tiempo real
    async function procesarNuevoPartido(partido) {
        console.log(`üÜï Procesando nuevo partido: ${partido.id} (${partido.tipo})`);
        
        // Verificar si el partido ya fue procesado
        const partidoProcesado = partidos.find(p => p.id === partido.id);
        if (partidoProcesado && partidoProcesado.procesado) {
            console.log(`‚ÑπÔ∏è Partido ${partido.id} ya fue procesado anteriormente`);
            return;
        }
        
        // Obtener jugadores actuales
        const jugadoresActuales = [...players];
        if (jugadoresActuales.length === 0) {
            console.log('‚ö†Ô∏è No hay jugadores cargados para procesar el partido');
            return;
        }
        
        let jugadoresLocal = [];
        let jugadoresVisitante = [];
        
        if (partido.tipo === 'liga') {
            jugadoresLocal = obtenerJugadoresActuales(partido.equipoLocalId, jugadoresActuales);
            jugadoresVisitante = obtenerJugadoresActuales(partido.equipoVisitanteId, jugadoresActuales);
        } else {
            if (partido.jugadores && partido.jugadores.length >= 4) {
                jugadoresLocal = partido.jugadores.slice(0, 2).map(jid => 
                    jugadoresActuales.find(j => j.id === jid)
                ).filter(Boolean);
                jugadoresVisitante = partido.jugadores.slice(2, 4).map(jid => 
                    jugadoresActuales.find(j => j.id === jid)
                ).filter(Boolean);
            }
        }
        
        if (jugadoresLocal.length < 2 || jugadoresVisitante.length < 2) {
            console.log(`‚ö†Ô∏è No se pudieron identificar todos los jugadores del partido: ${partido.id}`);
            return;
        }
        
        const resultado = procesarResultado(partido.resultado);
        if (!resultado) return;
        
        const team1Wins = resultado.ganador === 'local';
        
        // Aplicar l√≥gica Elo a cada jugador
        const allPlayers = [...jugadoresLocal, ...jugadoresVisitante];
        
        for (const player of allPlayers) {
            if (!player) continue;
            
            // Calcular cambio de puntos con l√≥gica Elo avanzada
            const cambioPuntos = calcularCambioPuntosElo(player, allPlayers, resultado, team1Wins, partido.tipo);
            
            // Actualizar estad√≠sticas del jugador
            player.elo += cambioPuntos;
            player.puntosRanking = player.elo; // Mantener sincronizado
            player.matches++;
            if ((team1Wins && jugadoresLocal.includes(player)) || (!team1Wins && jugadoresVisitante.includes(player))) {
                player.wins++;
            }
            player.setsWon += (team1Wins && jugadoresLocal.includes(player)) ? resultado.setsLocal : resultado.setsVisitante;
            player.setsLost += (team1Wins && jugadoresLocal.includes(player)) ? resultado.setsVisitante : resultado.setsLocal;
            
            // Actualizar en Firestore
            await actualizarJugadorEnFirestore(player);
        }
        
        // Marcar partido como procesado
        partido.procesado = true;
        partidos.push(partido);
        
        console.log(`‚úÖ Partido ${partido.id} procesado y actualizado en tiempo real`);
        
        // Actualizar tabla de ranking
        const currentRanking = players.map(p => p.id);
        const positionChanges = calcularCambiosPosicion(previousRanking, currentRanking);
        previousRanking = currentRanking;
        updateRankingTable(positionChanges);
    }

    // Obtener jugadores actuales de un equipo
    function obtenerJugadoresActuales(equipoId, jugadoresActuales) {
        if (!equipoId) return [];
        
        // Buscar jugadores por equipoId
        const jugadoresDelEquipo = jugadoresActuales.filter(j => 
            j.equipoId === equipoId || j.equipo === equipoId
        );
        
        if (jugadoresDelEquipo.length > 0) {
            return jugadoresDelEquipo;
        }
        
        // Buscar por nombre de equipo
        const jugadoresPorNombreEquipo = jugadoresActuales.filter(j => 
            j.nombreEquipo === equipoId || j.equipoNombre === equipoId
        );
        
        if (jugadoresPorNombreEquipo.length > 0) {
            return jugadoresPorNombreEquipo;
        }
        
        console.log(`‚ö†Ô∏è No se encontraron jugadores para el equipo: ${equipoId}`);
        return [];
    }

    // Calcular cambios de posici√≥n
    function calcularCambiosPosicion(rankingAnterior, rankingActual) {
        const cambios = {};
        
        rankingActual.forEach((playerId, nuevaPosicion) => {
            const posicionAnterior = rankingAnterior.indexOf(playerId);
            if (posicionAnterior !== -1 && posicionAnterior !== nuevaPosicion) {
                const cambio = posicionAnterior - nuevaPosicion;
                cambios[playerId] = cambio;
            }
        });
        
        return cambios;
    }

    // Actualizar tabla de ranking con cambios de posici√≥n
    function updateRankingTable(positionChanges = {}) {
        const tbody = document.getElementById('rankingBody');
        tbody.innerHTML = '';
        
        const sortedPlayers = [...players].sort((a, b) => b.elo - a.elo);
        
        console.log('üìä Actualizando tabla de ranking...');
        console.log(`üë• Total jugadores: ${sortedPlayers.length}`);
        
        sortedPlayers.forEach((player, index) => {
            const totalSets = player.setsWon + player.setsLost;
            const setPercentage = totalSets > 0 ? Math.round((player.setsWon / totalSets) * 100) : 0;
            const winPercentage = player.matches > 0 ? Math.round((player.wins / player.matches) * 100) : 0;
            const avgDifficulty = player.matches > 0 ? Math.round(player.difficulty / player.matches) : 0;
            
            console.log(`üë§ ${player.name}: ${player.matches} partidos, ${player.wins} victorias, ${player.elo.toFixed(2)} puntos`);
            
            // Calcular cambio de posici√≥n
            const positionChange = positionChanges[player.id] || 0;
            let positionChangeHtml = '';
            
            if (positionChange > 0) {
                positionChangeHtml = `<span class="position-change position-up">‚Üë${positionChange}</span>`;
            } else if (positionChange < 0) {
                positionChangeHtml = `<span class="position-change position-down">‚Üì${Math.abs(positionChange)}</span>`;
            } else if (player.matches > 0) {
                positionChangeHtml = `<span class="position-change position-same">‚Üí</span>`;
            }
            
            // Determinar color del nivel
            let nivelColor = '#fff';
            if (player.nivel >= 4.0) nivelColor = '#ffd700'; // Oro
            else if (player.nivel >= 3.5) nivelColor = '#c0c0c0'; // Plata
            else if (player.nivel >= 3.0) nivelColor = '#cd7f32'; // Bronce
            else if (player.nivel >= 2.5) nivelColor = '#3498db'; // Azul
            else nivelColor = '#95a5a6'; // Gris
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight: bold; color: #f1c40f;">${index + 1}</td>
                <td>
                    <div style="font-weight: 600;">${player.name}</div>
                    ${positionChangeHtml}
                </td>
                <td style="color: ${nivelColor}; font-weight: bold;">${player.nivel}</td>
                <td style="text-align: center;">
                    <div style="font-weight: bold;">${player.matches}</div>
                    <div style="font-size: 0.75rem; opacity: 0.8;">partidos</div>
                </td>
                <td style="text-align: center;">
                    <div style="font-weight: bold; color: #2ecc71;">${player.wins}</div>
                    <div style="font-size: 0.75rem; opacity: 0.8;">(${winPercentage}%)</div>
                </td>
                <td style="text-align: center;">
                    <div style="font-weight: bold;">${player.setsWon}-${player.setsLost}</div>
                    <div style="font-size: 0.75rem; opacity: 0.8;">(${setPercentage}%)</div>
                </td>
                <td style="text-align: center;">
                    <div style="font-weight: bold;">${avgDifficulty}%</div>
                </td>
                <td style="color: #f1c40f; font-weight: bold; font-size: 1.1rem;">
                    ${player.elo.toFixed(2)}
                </td>
            `;
            
            // Hacer la fila clickeable
            tr.addEventListener('click', () => {
                mostrarDetallesJugador(player);
            });
            
            tbody.appendChild(tr);
        });
        
        // Mostrar estad√≠sticas generales
        mostrarEstadisticasGenerales(sortedPlayers);
        
        console.log('‚úÖ Tabla de ranking actualizada');
    }

    // Mostrar estad√≠sticas generales del ranking
    function mostrarEstadisticasGenerales(sortedPlayers) {
        const statsContainer = document.getElementById('rankingStats');
        if (!statsContainer) return;
        
        const totalPlayers = sortedPlayers.length;
        const totalMatches = sortedPlayers.reduce((sum, p) => sum + p.matches, 0);
        const totalWins = sortedPlayers.reduce((sum, p) => sum + p.wins, 0);
        const totalSets = sortedPlayers.reduce((sum, p) => sum + p.setsWon + p.setsLost, 0);
        const avgPoints = totalPlayers > 0 ? (sortedPlayers.reduce((sum, p) => sum + p.elo, 0) / totalPlayers).toFixed(2) : 0;
        const maxPoints = sortedPlayers.length > 0 ? sortedPlayers[0].elo.toFixed(2) : 0;
        const minPoints = sortedPlayers.length > 0 ? sortedPlayers[sortedPlayers.length - 1].elo.toFixed(2) : 0;
        const jugadoresConPartidos = sortedPlayers.filter(p => p.matches > 0).length;
        const jugadoresSinPartidos = sortedPlayers.filter(p => p.matches === 0).length;
        
        console.log('üìä Estad√≠sticas generales:');
        console.log(`  - Total jugadores: ${totalPlayers}`);
        console.log(`  - Jugadores con partidos: ${jugadoresConPartidos}`);
        console.log(`  - Jugadores sin partidos: ${jugadoresSinPartidos}`);
        console.log(`  - Total partidos: ${totalMatches}`);
        console.log(`  - Total victorias: ${totalWins}`);
        console.log(`  - Total sets: ${totalSets}`);
        console.log(`  - Puntos promedio: ${avgPoints}`);
        console.log(`  - Puntos m√°ximos: ${maxPoints}`);
        console.log(`  - Puntos m√≠nimos: ${minPoints}`);
        
        statsContainer.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;">
                <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #f1c40f;">${totalPlayers}</div>
                    <div style="font-size: 0.8rem; opacity: 0.8;">Jugadores</div>
                </div>
                <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #2ecc71;">${totalMatches}</div>
                    <div style="font-size: 0.8rem; opacity: 0.8;">Partidos</div>
                </div>
                <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #3498db;">${totalWins}</div>
                    <div style="font-size: 0.8rem; opacity: 0.8;">Victorias</div>
                </div>
                <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #e74c3c;">${avgPoints}</div>
                    <div style="font-size: 0.8rem; opacity: 0.8;">Puntos Promedio</div>
                </div>
                <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #9b59b6;">${jugadoresConPartidos}</div>
                    <div style="font-size: 0.8rem; opacity: 0.8;">Con Partidos</div>
                </div>
                <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #f39c12;">${jugadoresSinPartidos}</div>
                    <div style="font-size: 0.8rem; opacity: 0.8;">Sin Partidos</div>
                </div>
            </div>
        `;
    }

    // Actualizar informaci√≥n del sistema
    function actualizarInformacionSistema() {
        const totalPartidos = partidos.length;
        const totalJugadores = players.length;
        
        console.log(`üìä Actualizando informaci√≥n del sistema:`);
        console.log(`  - Total partidos: ${totalPartidos}`);
        console.log(`  - Total jugadores: ${totalJugadores}`);
        console.log(`  - Procesamiento completado: ${procesamientoCompletado}`);
        
        // Mostrar informaci√≥n en consola
        if (totalJugadores > 0) {
            console.log('üë• Jugadores cargados:');
            players.forEach((p, index) => {
                console.log(`  ${index + 1}. ${p.name} - Nivel: ${p.nivel} - Puntos: ${p.puntosRanking} - Partidos: ${p.matches} - Victorias: ${p.wins}`);
            });
        }
        
        if (totalPartidos > 0) {
            console.log('üéæ Partidos cargados:');
            const distribucion = partidos.reduce((acc, p) => {
                acc[p.tipo] = (acc[p.tipo] || 0) + 1;
                return acc;
            }, {});
            console.log('  Distribuci√≥n:', distribucion);
        }
    }

    // Inicializar aplicaci√≥n
    async function init() {
        try {
            console.log('üöÄ Iniciando aplicaci√≥n autom√°ticamente...');
            
            // Autenticaci√≥n an√≥nima
            await inicializarFirebase();
            console.log('‚úÖ Autenticaci√≥n an√≥nima completada');
            
            // Cargar equipos primero
            await cargarEquipos();
            
            // Cargar partidos
            await cargarPartidosTiempoReal();
            
            // Cargar usuarios (esto activar√° el procesamiento autom√°tico)
            await cargarUsuariosTiempoReal();
            
            console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
            
        } catch (error) {
            console.error('‚ùå Error inicializando aplicaci√≥n:', error);
        }
    }

    // Limpiar listeners al salir
    window.addEventListener('beforeunload', () => {
        if (unsubscribePartidos) unsubscribePartidos();
        if (unsubscribeUsuarios) unsubscribeUsuarios();
    });

    // Inicializar cuando se carga la p√°gina
    window.onload = function() {
        init();
    };

    // Actualizar display del √∫ltimo partido (como en la simulaci√≥n original)
    function updateMatchDisplay() {
        if (!lastMatchDetails) return;
        const { team1, team2, sets, team1Sets, team2Sets, stats, avgElo1, avgElo2, team1Wins } = lastMatchDetails;
        
        // Verificar que los elementos existan antes de usarlos
        const player1El = document.getElementById('player1');
        const player2El = document.getElementById('player2');
        const player3El = document.getElementById('player3');
        const player4El = document.getElementById('player4');
        
        if (player1El) player1El.textContent = team1[0].name;
        if (player2El) player2El.textContent = team1[1].name;
        if (player3El) player3El.textContent = team2[0].name;
        if (player4El) player4El.textContent = team2[1].name;
        
        const setsTeam1 = document.getElementById('setsTeam1');
        const setsTeam2 = document.getElementById('setsTeam2');
        
        if (setsTeam1) {
            setsTeam1.innerHTML = '';
            sets.forEach(set => {
                const setEl1 = document.createElement('div');
                setEl1.className = 'set-score';
                setEl1.textContent = set.team1;
                setsTeam1.appendChild(setEl1);
            });
        }
        
        if (setsTeam2) {
            setsTeam2.innerHTML = '';
            sets.forEach(set => {
                const setEl2 = document.createElement('div');
                setEl2.className = 'set-score';
                setEl2.textContent = set.team2;
                setsTeam2.appendChild(setEl2);
            });
        }
        
        const team1El = document.getElementById('team1');
        const team2El = document.getElementById('team2');
        if (team1El) team1El.className = `team ${team1Wins ? 'winner' : ''}`;
        if (team2El) team2El.className = `team ${!team1Wins ? 'winner' : ''}`;
        
        const eloDiffEl = document.getElementById('eloDiff');
        if (eloDiffEl) {
            const diff = Math.round(avgElo2 - avgElo1);
            const diffText = `Diferencia de Elo: ${diff > 0 ? '+' : ''}${diff} puntos`;
            eloDiffEl.textContent = diffText;
        }
        
        // Actualizar estad√≠sticas si existen los elementos
        const aces1El = document.getElementById('aces1');
        const winners1El = document.getElementById('winners1');
        const errors1El = document.getElementById('errors1');
        const aces2El = document.getElementById('aces2');
        const winners2El = document.getElementById('winners2');
        const errors2El = document.getElementById('errors2');
        
        if (aces1El) aces1El.textContent = stats.team1.aces;
        if (winners1El) winners1El.textContent = stats.team1.winners;
        if (errors1El) errors1El.textContent = stats.team1.errors;
        if (aces2El) aces2El.textContent = stats.team2.aces;
        if (winners2El) winners2El.textContent = stats.team2.winners;
        if (errors2El) errors2El.textContent = stats.team2.errors;
    }

    // Actualizar historial (como en la simulaci√≥n original)
    function updateHistoryList() {
        if (!lastMatchDetails) return;
        const historyList = document.getElementById('historyList');
        if (!historyList) return;
        
        historyList.innerHTML = '';
        
        const { team1, team2 } = lastMatchDetails;
        const allPlayers = [...team1, ...team2];
        
        allPlayers.forEach(player => {
            const lastChange = player.history[player.history.length - 1];
            const changeClass = lastChange.change > 0 ? 'positive' : 'negative';
            const changeSymbol = lastChange.change > 0 ? '‚ñ≤' : '‚ñº';
            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `
                <strong>${player.name}</strong> ${changeSymbol} ${Math.abs(Math.round(lastChange.change))} puntos 
                <span class="${changeClass}">(${changeSymbol}${Math.abs(Math.round(lastChange.change))})</span>
                <div>vs ${lastChange.opponent}</div>
            `;
            historyList.appendChild(item);
        });
        
        // Mostrar bot√≥n de desglose si existe
        const toggleBtn = document.getElementById('toggleDesglose');
        if (toggleBtn) {
            toggleBtn.style.display = 'block';
        }
        
        // Mostrar desglose detallado
        mostrarDesgloseDetallado();
    }
    
    // Funci√≥n para alternar el desglose detallado
    function toggleDesgloseDetallado() {
        const desgloseDetallado = document.getElementById('desgloseDetallado');
        const toggleBtn = document.getElementById('toggleDesglose');
        
        if (!desgloseDetallado || !toggleBtn) return;
        
        if (desgloseDetallado.style.display === 'none') {
            desgloseDetallado.style.display = 'block';
            toggleBtn.textContent = 'üßÆ Ocultar Desglose Detallado';
        } else {
            desgloseDetallado.style.display = 'none';
            toggleBtn.textContent = 'üßÆ Mostrar Desglose Detallado';
        }
    }

    // Mostrar desglose detallado (como en la simulaci√≥n original)
    function mostrarDesgloseDetallado() {
        if (!lastMatchDetails) return;
        
        const desgloseContent = document.getElementById('desgloseContent');
        const desgloseDetallado = document.getElementById('desgloseDetallado');
        
        if (!desgloseContent || !desgloseDetallado) return;
        
        const { team1, team2 } = lastMatchDetails;
        const allPlayers = [...team1, ...team2];
        
        let html = '';
        
        allPlayers.forEach(player => {
            const lastChange = player.history[player.history.length - 1];
            if (!lastChange.factores) return;
            
            const factores = lastChange.factores;
            const cambioTotal = lastChange.change;
            
            html += `
                <div class="desglose-partido">
                    <h4>${player.name} - ${lastChange.opponent}</h4>
                    <div class="jugador-desglose">
                        <div class="jugador-nombre">${player.name}</div>
                        
                        <div class="factor-item">
                            <span class="factor-nombre">üéØ Factor Nivel del Partido:</span>
                            <span class="factor-valor ${factores.nivelPartido > 0 ? 'factor-positivo' : factores.nivelPartido < 0 ? 'factor-negativo' : 'factor-neutral'}">
                                ${factores.nivelPartido > 0 ? '+' : ''}${factores.nivelPartido.toFixed(2)}
                            </span>
                        </div>
                        
                        <div class="factor-item">
                            <span class="factor-nombre">ü§ù Factor Compa√±ero:</span>
                            <span class="factor-valor ${factores.companero > 0 ? 'factor-positivo' : factores.companero < 0 ? 'factor-negativo' : 'factor-neutral'}">
                                ${factores.companero > 0 ? '+' : ''}${factores.companero.toFixed(2)}
                            </span>
                        </div>
                        
                        <div class="factor-item">
                            <span class="factor-nombre">‚öîÔ∏è Factor Rivales:</span>
                            <span class="factor-valor ${factores.rivales > 0 ? 'factor-positivo' : factores.rivales < 0 ? 'factor-negativo' : 'factor-neutral'}">
                                ${factores.rivales > 0 ? '+' : ''}${factores.rivales.toFixed(2)}
                            </span>
                        </div>
                        
                        <div class="factor-item">
                            <span class="factor-nombre">üìä Factor Marcador:</span>
                            <span class="factor-valor ${factores.marcador > 0 ? 'factor-positivo' : factores.marcador < 0 ? 'factor-negativo' : 'factor-neutral'}">
                                ${factores.marcador > 0 ? '+' : ''}${factores.marcador.toFixed(2)}
                            </span>
                        </div>
                        
                        <div class="factor-item">
                            <span class="factor-nombre">‚≠ê Factor Nivel Individual:</span>
                            <span class="factor-valor ${factores.nivelIndividual > 0 ? 'factor-positivo' : factores.nivelIndividual < 0 ? 'factor-negativo' : 'factor-neutral'}">
                                ${factores.nivelIndividual > 0 ? '+' : ''}${factores.nivelIndividual.toFixed(2)}
                            </span>
                        </div>
                        
                        <div class="factor-item">
                            <span class="factor-nombre">üèÜ Factor Tipo de Partido:</span>
                            <span class="factor-valor factor-positivo">
                                +${factores.tipoPartido.toFixed(2)}
                            </span>
                        </div>
                        
                        <div class="factor-item">
                            <span class="factor-nombre">üìà Factor Experiencia:</span>
                            <span class="factor-valor ${factores.experiencia > 0 ? 'factor-positivo' : 'factor-neutral'}">
                                +${factores.experiencia.toFixed(2)}
                            </span>
                        </div>
                        
                        <div class="factor-item">
                            <span class="factor-nombre">üî• Factor Racha:</span>
                            <span class="factor-valor ${factores.racha > 0 ? 'factor-positivo' : factores.racha < 0 ? 'factor-negativo' : 'factor-neutral'}">
                                ${factores.racha > 0 ? '+' : ''}${factores.racha.toFixed(2)}
                            </span>
                        </div>
                        
                        <div class="factor-item">
                            <span class="factor-nombre">üò∞ Factor Presi√≥n:</span>
                            <span class="factor-valor ${factores.presion > 0 ? 'factor-positivo' : factores.presion < 0 ? 'factor-negativo' : 'factor-neutral'}">
                                ${factores.presion > 0 ? '+' : ''}${factores.presion.toFixed(2)}
                            </span>
                        </div>
                        
                        <div class="factor-item">
                            <span class="factor-nombre">üìè Factor Consistencia:</span>
                            <span class="factor-valor ${factores.consistencia > 0 ? 'factor-positivo' : factores.consistencia < 0 ? 'factor-negativo' : 'factor-neutral'}">
                                ${factores.consistencia > 0 ? '+' : ''}${factores.consistencia.toFixed(2)}
                            </span>
                        </div>
                        
                        <div class="factor-item">
                            <span class="factor-nombre">üöÄ Factor Momentum:</span>
                            <span class="factor-valor ${factores.momentum > 0 ? 'factor-positivo' : factores.momentum < 0 ? 'factor-negativo' : 'factor-neutral'}">
                                ${factores.momentum > 0 ? '+' : ''}${factores.momentum.toFixed(2)}
                            </span>
                        </div>
                        
                        <div class="factor-item">
                            <span class="factor-nombre">‚ö° Factor Intensidad:</span>
                            <span class="factor-valor ${factores.intensidad > 0 ? 'factor-positivo' : factores.intensidad < 0 ? 'factor-negativo' : 'factor-neutral'}">
                                ${factores.intensidad > 0 ? '+' : ''}${factores.intensidad.toFixed(2)}
                            </span>
                        </div>
                        
                        <div class="factor-item">
                            <span class="factor-nombre">üí™ Factor Clutch:</span>
                            <span class="factor-valor ${factores.clutch > 0 ? 'factor-positivo' : factores.clutch < 0 ? 'factor-negativo' : 'factor-neutral'}">
                                ${factores.clutch > 0 ? '+' : ''}${factores.clutch.toFixed(2)}
                            </span>
                        </div>
                        
                        <div class="factor-item">
                            <span class="factor-nombre">üõ°Ô∏è Factor Anti-Sandbagging:</span>
                            <span class="factor-valor ${factores.antiSandbagging > 0 ? 'factor-positivo' : factores.antiSandbagging < 0 ? 'factor-negativo' : 'factor-neutral'}">
                                ${factores.antiSandbagging > 0 ? '+' : ''}${factores.antiSandbagging.toFixed(2)}
                            </span>
                        </div>
                        
                        <div class="factor-item">
                            <span class="factor-nombre">üéØ Factor Rendimiento vs Rivales:</span>
                            <span class="factor-valor ${factores.rendimientoVsRivales > 0 ? 'factor-positivo' : factores.rendimientoVsRivales < 0 ? 'factor-negativo' : 'factor-neutral'}">
                                ${factores.rendimientoVsRivales > 0 ? '+' : ''}${factores.rendimientoVsRivales.toFixed(2)}
                            </span>
                        </div>
                        
                        <div class="total-cambio ${cambioTotal > 0 ? 'total-positivo' : 'total-negativo'}">
                            <strong>Cambio Total en Puntos de Ranking: ${cambioTotal > 0 ? '+' : ''}${cambioTotal.toFixed(2)}</strong>
                        </div>
                    </div>
                </div>
            `;
        });
        
        desgloseContent.innerHTML = html;
        desgloseDetallado.style.display = 'block';
    }

    // Mostrar detalles del jugador en el modal
    function mostrarDetallesJugador(player) {
        const modal = document.getElementById('playerModal');
        const modalPlayerName = document.getElementById('modalPlayerName');
        const modalPlayerLevel = document.getElementById('modalPlayerLevel');
        const modalPlayerPoints = document.getElementById('modalPlayerPoints');
        const modalPlayerMatches = document.getElementById('modalPlayerMatches');
        const modalPlayerWins = document.getElementById('modalPlayerWins');
        
        // Calcular posici√≥n actual en el ranking
        const sortedPlayers = [...players].sort((a, b) => b.elo - a.elo);
        const currentPosition = sortedPlayers.findIndex(p => p.id === player.id) + 1;
        
        // Actualizar informaci√≥n b√°sica del jugador
        modalPlayerName.textContent = player.name;
        modalPlayerLevel.textContent = player.nivel;
        modalPlayerPoints.textContent = player.elo.toFixed(2);
        modalPlayerMatches.textContent = (player.matches / 4).toFixed(1);
        modalPlayerWins.textContent = `${player.wins} (${player.matches > 0 ? Math.round((player.wins / player.matches) * 100) : 0}%)`;
        
        // Configurar navegaci√≥n de partidos
        let currentMatchIndex = player.history.length - 1;
        mostrarPartidoEnModal(player, currentMatchIndex, currentPosition);
        
        // Configurar botones de navegaci√≥n
        const prevBtn = document.getElementById('prevMatch');
        const nextBtn = document.getElementById('nextMatch');
        const matchCounter = document.getElementById('matchCounter');
        
        prevBtn.onclick = () => {
            if (currentMatchIndex > 0) {
                currentMatchIndex--;
                mostrarPartidoEnModal(player, currentMatchIndex, currentPosition);
            }
        };
        
        nextBtn.onclick = () => {
            if (currentMatchIndex < player.history.length - 1) {
                currentMatchIndex++;
                mostrarPartidoEnModal(player, currentMatchIndex, currentPosition);
            }
        };
        
        // Actualizar estado de botones
        function actualizarBotones() {
            prevBtn.disabled = currentMatchIndex <= 0;
            nextBtn.disabled = currentMatchIndex >= player.history.length - 1;
            matchCounter.textContent = `Partido ${player.history.length - currentMatchIndex} de ${player.history.length}`;
        }
        
        actualizarBotones();
        
        // Mostrar modal
        modal.style.display = 'block';
    }

    // Mostrar partido espec√≠fico en el modal
    function mostrarPartidoEnModal(player, matchIndex, currentPosition) {
        const matchDetails = document.getElementById('matchDetails');
        const matchFactors = document.getElementById('matchFactors');
        
        if (matchIndex < 0 || matchIndex >= player.history.length) {
            matchDetails.innerHTML = '<p>No hay partidos para mostrar</p>';
            matchFactors.innerHTML = '';
            return;
        }
        
        const match = player.history[matchIndex];
        
        // Calcular posici√≥n en el ranking durante ese partido
        const positionDuringMatch = calcularPosicionDurantePartido(player, matchIndex);
        
        // Mostrar detalles del partido
        matchDetails.innerHTML = `
            <h4>Partido vs ${match.opponent}</h4>
            <div class="match-info">
                <div class="match-stat">
                    <span class="stat-label">Fecha:</span>
                    <span class="stat-value">${match.date}</span>
                </div>
                <div class="match-stat">
                    <span class="stat-label">Cambio de Puntos Elo:</span>
                    <span class="stat-value ${match.change > 0 ? 'positive' : 'negative'}">
                        ${match.change > 0 ? '+' : ''}${match.change.toFixed(2)} puntos
                    </span>
                </div>
                <div class="match-stat">
                    <span class="stat-label">Puntos Elo Despu√©s:</span>
                    <span class="stat-value">${(player.elo - match.change).toFixed(2)}</span>
                </div>
                <div class="match-stat">
                    <span class="stat-label">Posici√≥n en Ranking:</span>
                    <span class="stat-value">${positionDuringMatch}¬∫</span>
                </div>
                <div class="match-stat">
                    <span class="stat-label">Posici√≥n Actual:</span>
                    <span class="stat-value">${currentPosition}¬∫</span>
                </div>
                <div class="match-stat">
                    <span class="stat-label">Partido N√∫mero:</span>
                    <span class="stat-value">${player.history.length - matchIndex}</span>
                </div>
            </div>
        `;
        
        // Mostrar factores si existen
        if (match.factores) {
            const factores = match.factores;
            let factorsHtml = '<h4>Factores que influyeron en los puntos Elo:</h4>';
            
            const factorList = [
                { nombre: 'üéØ Factor Nivel del Partido', valor: factores.nivelPartido },
                { nombre: 'ü§ù Factor Compa√±ero', valor: factores.companero },
                { nombre: '‚öîÔ∏è Factor Rivales', valor: factores.rivales },
                { nombre: 'üìä Factor Marcador', valor: factores.marcador },
                { nombre: '‚≠ê Factor Nivel Individual', valor: factores.nivelIndividual },
                { nombre: 'üèÜ Factor Tipo de Partido', valor: factores.tipoPartido },
                { nombre: 'üìà Factor Experiencia', valor: factores.experiencia },
                { nombre: 'üî• Factor Racha', valor: factores.racha },
                { nombre: 'üò∞ Factor Presi√≥n', valor: factores.presion },
                { nombre: 'üìè Factor Consistencia', valor: factores.consistencia },
                { nombre: 'üöÄ Factor Momentum', valor: factores.momentum },
                { nombre: '‚ö° Factor Intensidad', valor: factores.intensidad },
                { nombre: 'üí™ Factor Clutch', valor: factores.clutch },
                { nombre: 'üõ°Ô∏è Factor Anti-Sandbagging', valor: factores.antiSandbagging },
                { nombre: 'üéØ Factor Rendimiento vs Rivales', valor: factores.rendimientoVsRivales }
            ];
            
            factorList.forEach(factor => {
                const factorClass = factor.valor > 0 ? 'factor-positivo' : 
                                  factor.valor < 0 ? 'factor-negativo' : 'factor-neutral';
                factorsHtml += `
                    <div class="factor-item">
                        <span class="factor-nombre">${factor.nombre}:</span>
                        <span class="factor-valor ${factorClass}">
                            ${factor.valor > 0 ? '+' : ''}${factor.valor.toFixed(2)}
                        </span>
                    </div>
                `;
            });
            
            factorsHtml += `
                <div class="total-cambio ${match.change > 0 ? 'total-positivo' : 'total-negativo'}">
                    <strong>Cambio Total en Puntos Elo: ${match.change > 0 ? '+' : ''}${match.change.toFixed(2)} puntos</strong>
                </div>
            `;
            
            matchFactors.innerHTML = factorsHtml;
        } else {
            matchFactors.innerHTML = '<p>No hay factores detallados disponibles para este partido</p>';
        }
    }

    // Calcular posici√≥n en el ranking durante un partido espec√≠fico
    function calcularPosicionDurantePartido(player, matchIndex) {
        // Crear una copia de todos los jugadores con sus puntos Elo hasta ese partido
        const playersAtMatch = players.map(p => {
            const playerCopy = { ...p };
            // Calcular puntos Elo hasta ese partido espec√≠fico
            let eloAtMatch = 1000 + (p.nivel * 25); // Puntos iniciales
            
            // Sumar solo los cambios hasta ese partido
            for (let i = 0; i <= matchIndex && i < p.history.length; i++) {
                eloAtMatch += p.history[i].change;
            }
            
            playerCopy.elo = eloAtMatch;
            return playerCopy;
        });
        
        // Ordenar por puntos Elo y encontrar la posici√≥n
        const sortedAtMatch = playersAtMatch.sort((a, b) => b.elo - a.elo);
        const position = sortedAtMatch.findIndex(p => p.id === player.id) + 1;
        
        return position;
    }

    // Cerrar modal
    function cerrarModal() {
        const modal = document.getElementById('playerModal');
        modal.style.display = 'none';
    }

    // Configurar eventos del modal
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('playerModal');
        const closeBtn = document.querySelector('.close');
        
        // Cerrar modal con X
        closeBtn.onclick = cerrarModal;
        
        // Cerrar modal haciendo clic fuera
        window.onclick = function(event) {
            if (event.target === modal) {
                cerrarModal();
            }
        }
        
        // Cerrar modal con ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && modal.style.display === 'block') {
                cerrarModal();
            }
        });
    });

    // Funci√≥n para mostrar informaci√≥n de debug en la p√°gina
    function mostrarInfoDebug() {
        const debugContainer = document.createElement('div');
        debugContainer.id = 'debugInfo';
        debugContainer.style.cssText = `
            position: fixed;
            top: 100px;
            right: 20px;
            width: 300px;
            max-height: 400px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #ffcc00;
            border-radius: 10px;
            padding: 15px;
            font-size: 0.8rem;
            z-index: 1000;
            overflow-y: auto;
            color: #fff;
        `;
        
        const totalJugadores = players.length;
        const totalPartidos = partidos.length;
        const jugadoresConPartidos = players.filter(p => p.matches > 0).length;
        const jugadoresSinPartidos = players.filter(p => p.matches === 0).length;
        const totalVictorias = players.reduce((sum, p) => sum + p.wins, 0);
        const totalSets = players.reduce((sum, p) => sum + p.setsWon + p.setsLost, 0);
        
        debugContainer.innerHTML = `
            <h4 style="color: #ffcc00; margin: 0 0 10px 0;">üîç Debug Info</h4>
            <div style="margin-bottom: 8px;">
                <strong>Jugadores:</strong> ${totalJugadores}
            </div>
            <div style="margin-bottom: 8px;">
                <strong>Partidos cargados:</strong> ${totalPartidos}
            </div>
            <div style="margin-bottom: 8px;">
                <strong>Jugadores con partidos:</strong> ${jugadoresConPartidos}
            </div>
            <div style="margin-bottom: 8px;">
                <strong>Jugadores sin partidos:</strong> ${jugadoresSinPartidos}
            </div>
            <div style="margin-bottom: 8px;">
                <strong>Total victorias:</strong> ${totalVictorias}
            </div>
            <div style="margin-bottom: 8px;">
                <strong>Total sets:</strong> ${totalSets}
            </div>
            <div style="margin-bottom: 8px;">
                <strong>Procesamiento:</strong> ${procesamientoCompletado ? '‚úÖ Completado' : '‚è≥ En proceso'}
            </div>
            <button onclick="document.getElementById('debugInfo').remove()" style="
                background: #ffcc00;
                color: #000;
                border: none;
                padding: 5px 10px;
                border-radius: 5px;
                cursor: pointer;
                margin-top: 10px;
            ">Cerrar</button>
        `;
        
        document.body.appendChild(debugContainer);
    }

    // Funci√≥n mejorada para procesar un partido individual con m√°s debug
    async function procesarPartidoComoSimulacion(partido) {
        try {
            console.log(`üéæ Procesando partido: ${partido.id} (${partido.tipo})`);
            console.log(`üìä Datos del partido:`, partido);
            
            // Obtener jugadores del partido
            let team1 = [], team2 = [];
            
            if (partido.tipo === 'liga') {
                // Partidos de liga: obtener jugadores de equipos
                const equipoLocal = equipos[partido.equipoLocalId];
                const equipoVisitante = equipos[partido.equipoVisitanteId];
                
                console.log(`üè† Equipo local:`, equipoLocal);
                console.log(`üè† Equipo visitante:`, equipoVisitante);
                
                if (!equipoLocal || !equipoVisitante) {
                    console.warn(`‚ö†Ô∏è Equipos no encontrados para partido ${partido.id}`);
                    console.warn(`   Equipo local ID: ${partido.equipoLocalId}`);
                    console.warn(`   Equipo visitante ID: ${partido.equipoVisitanteId}`);
                    return;
                }
                
                team1 = equipoLocal.jugadores.map(id => players.find(p => p.id === id)).filter(p => p);
                team2 = equipoVisitante.jugadores.map(id => players.find(p => p.id === id)).filter(p => p);
                
                console.log(`üë• Team 1 (${team1.length} jugadores):`, team1.map(p => p.name));
                console.log(`üë• Team 2 (${team2.length} jugadores):`, team2.map(p => p.name));
                
            } else {
                // Partidos amistosos/reto: jugadores directos
                team1 = partido.jugadores.slice(0, 2).map(id => players.find(p => p.id === id)).filter(p => p);
                team2 = partido.jugadores.slice(2, 4).map(id => players.find(p => p.id === id)).filter(p => p);
                
                console.log(`üë• Team 1 (${team1.length} jugadores):`, team1.map(p => p.name));
                console.log(`üë• Team 2 (${team2.length} jugadores):`, team2.map(p => p.name));
            }
            
            if (team1.length !== 2 || team2.length !== 2) {
                console.warn(`‚ö†Ô∏è No se pudieron obtener 4 jugadores para partido ${partido.id}`);
                console.warn(`   Team 1: ${team1.length} jugadores`);
                console.warn(`   Team 2: ${team2.length} jugadores`);
                console.warn(`   Jugadores disponibles:`, players.map(p => `${p.name} (${p.id})`));
                return;
            }
            
            // Calcular resultado del partido
            const resultado = calcularResultadoPartido(partido.resultado);
            console.log(`üìà Resultado calculado:`, resultado);
            
            const team1Wins = resultado.setsLocal > resultado.setsVisitante;
            console.log(`üèÜ Ganador: ${team1Wins ? 'Team 1' : 'Team 2'}`);
            
            // Calcular estad√≠sticas del partido
            const stats = {
                totalSets: resultado.setsLocal + resultado.setsVisitante,
                totalGames: resultado.juegosLocal + resultado.juegosVisitante,
                averageGamesPerSet: (resultado.juegosLocal + resultado.juegosVisitante) / (resultado.setsLocal + resultado.setsVisitante)
            };
            
            // Calcular Elo esperado
            const elo1 = (team1[0].elo + team1[1].elo) / 2;
            const elo2 = (team2[0].elo + team2[1].elo) / 2;
            const expected1 = 1 / (1 + Math.pow(10, (elo2 - elo1) / 400));
            const expected2 = 1 - expected1;
            
            console.log(`üìä Elo promedio - Team 1: ${elo1.toFixed(2)}, Team 2: ${elo2.toFixed(2)}`);
            console.log(`üìä Probabilidad esperada - Team 1: ${(expected1 * 100).toFixed(1)}%, Team 2: ${(expected2 * 100).toFixed(1)}%`);
            
            // Calcular rating individual
            const ri1 = team1Wins ? 1 : 0;
            const ri2 = team1Wins ? 0 : 1;
            
            // Calcular factor de dificultad
            const fd1 = Math.abs(elo2 - elo1) / 400;
            const fd2 = Math.abs(elo1 - elo2) / 400;
            
            console.log(`üìä Factor dificultad - Team 1: ${fd1.toFixed(3)}, Team 2: ${fd2.toFixed(3)}`);
            
            // Procesar equipo 1
            team1.forEach(player => {
                const k = player.matches < 10 ? 32 : 16;
                const change = k * ((team1Wins ? 1 : 0) - expected1) + ri1 * 0.5;
                const finalChange = change * fd1;
                
                // Factores individuales (mismo c√°lculo que antes)
                const factorNivelPartido = ((team1[0].nivel + team1[1].nivel + team2[0].nivel + team2[1].nivel) / 4 - 2.0) * 3.5;
                const comp = team1[0] === player ? team1[1] : team1[0];
                const factorCompanero = (player.nivel - comp.nivel) * 4.2;
                const factorRivales = ((team2[0].nivel + team2[1].nivel) / 2 - player.nivel) * 5.1;
                const diffJuegos = Math.abs(resultado.juegosLocal - resultado.juegosVisitante);
                const factorMarcador = team1Wins ? diffJuegos * 2.2 : -diffJuegos * 1.5;
                const factorNivelIndividual = (player.nivel - 2.0) * 3.8;
                
                let factorTipoPartido = 0;
                switch (partido.tipo) {
                    case 'liga': factorTipoPartido = 3.5; break;
                    case 'reto': factorTipoPartido = 2.8; break;
                    case 'amistoso': factorTipoPartido = 1.2; break;
                    default: factorTipoPartido = 1.5;
                }
                
                const factorExperiencia = Math.min(2.5, player.matches * 0.15);
                
                let factorRacha = 0;
                if (player.matches > 0) {
                    const porcentajeVictorias = (player.wins / player.matches) * 100;
                    if (porcentajeVictorias < 30) factorRacha = 2.1;
                    else if (porcentajeVictorias > 70) factorRacha = -1.8;
                }
                
                let factorPresion = 0;
                if (partido.tipo === 'liga' && player.matches < 5) factorPresion = 1.8;
                else if (partido.tipo === 'liga' && player.matches > 20) factorPresion = -0.9;
                
                let factorConsistencia = 0;
                if (player.history.length > 3) {
                    const ultimos3 = player.history.slice(-3).map(h => h.change);
                    const variacion = Math.abs(ultimos3[2] - ultimos3[0]) / Math.abs(ultimos3[0] || 1);
                    if (variacion < 0.3) factorConsistencia = 1.5;
                    else if (variacion > 0.8) factorConsistencia = -1.2;
                }
                
                let factorMomentum = 0;
                if (player.history.length > 0) {
                    const ultimoCambio = player.history[player.history.length - 1].change;
                    if (ultimoCambio > 5) factorMomentum = 1.2;
                    else if (ultimoCambio < -5) factorMomentum = -1.0;
                }
                
                const totalJuegos = resultado.juegosLocal + resultado.juegosVisitante;
                let factorIntensidad = 0;
                if (totalJuegos > 20) factorIntensidad = 1.8;
                else if (totalJuegos > 15) factorIntensidad = 1.2;
                else if (totalJuegos < 10) factorIntensidad = -0.8;
                
                let factorClutch = 0;
                const diffSets = Math.abs(resultado.setsLocal - resultado.setsVisitante);
                const diffJuegosTotal = Math.abs(resultado.juegosLocal - resultado.juegosVisitante);
                if (diffSets === 1 && diffJuegosTotal <= 4) {
                    factorClutch = team1Wins ? 2.5 : -1.8;
                }
                
                const nivelPromedioRivales = (team2[0].nivel + team2[1].nivel) / 2;
                let factorAntiSandbagging = 0;
                if (player.nivel > 3.0 && nivelPromedioRivales < 2.5) {
                    factorAntiSandbagging = -2.8;
                } else if (player.nivel < 2.5 && nivelPromedioRivales > 3.0) {
                    factorAntiSandbagging = 2.5;
                }
                
                const miNivel = player.nivel;
                const rivalMasAlto = Math.max(team2[0].nivel, team2[1].nivel);
                const rivalMasBajo = Math.min(team2[0].nivel, team2[1].nivel);
                let factorRendimientoVsRivales = 0;
                if (miNivel > rivalMasAlto) factorRendimientoVsRivales = -1.5;
                else if (miNivel < rivalMasBajo) factorRendimientoVsRivales = 2.2;
                else factorRendimientoVsRivales = 0.8;
                
                const sumaFactoresIndividuales = factorNivelPartido + factorCompanero + factorRivales + 
                                               factorMarcador + factorNivelIndividual + factorTipoPartido + 
                                               factorExperiencia + factorRacha + factorPresion + factorConsistencia +
                                               factorMomentum + factorIntensidad + factorClutch + factorAntiSandbagging +
                                               factorRendimientoVsRivales;
                
                const puntosIndividuales = sumaFactoresIndividuales / 5.8;
                const cambioFinal = finalChange + puntosIndividuales;
                
                console.log(`üë§ ${player.name} - Cambio Elo: ${cambioFinal.toFixed(2)} (Base: ${finalChange.toFixed(2)}, Factores: ${puntosIndividuales.toFixed(2)})`);
                
                // Aplicar cambio al Elo
                player.elo += cambioFinal;
                player.puntosRanking = player.elo;
                player.matches++;
                if (team1Wins) player.wins++;
                player.setsWon += resultado.setsLocal;
                player.setsLost += resultado.setsVisitante;
                player.performance += ri1;
                player.difficulty += Math.round(fd1 * 100);
                player.history.push({
                    change: cambioFinal,
                    opponent: `${team2[0].name} & ${team2[1].name}`,
                    date: new Date(partido.fecha).toLocaleDateString(),
                    factores: {
                        nivelPartido: factorNivelPartido,
                        companero: factorCompanero,
                        rivales: factorRivales,
                        marcador: factorMarcador,
                        nivelIndividual: factorNivelIndividual,
                        tipoPartido: factorTipoPartido,
                        experiencia: factorExperiencia,
                        racha: factorRacha,
                        presion: factorPresion,
                        consistencia: factorConsistencia,
                        momentum: factorMomentum,
                        intensidad: factorIntensidad,
                        clutch: factorClutch,
                        antiSandbagging: factorAntiSandbagging,
                        rendimientoVsRivales: factorRendimientoVsRivales,
                        total: puntosIndividuales
                    }
                });
            });
            
            // Procesar equipo 2 (mismo proceso que equipo 1)
            team2.forEach(player => {
                const k = player.matches < 10 ? 32 : 16;
                const change = k * ((team1Wins ? 0 : 1) - expected2) + ri2 * 0.5;
                const finalChange = change * fd2;
                
                // Factores individuales (mismo c√°lculo que equipo 1 pero con roles invertidos)
                const factorNivelPartido = ((team1[0].nivel + team1[1].nivel + team2[0].nivel + team2[1].nivel) / 4 - 2.0) * 3.5;
                const comp = team2[0] === player ? team2[1] : team2[0];
                const factorCompanero = (player.nivel - comp.nivel) * 4.2;
                const factorRivales = ((team1[0].nivel + team1[1].nivel) / 2 - player.nivel) * 5.1;
                const diffJuegos = Math.abs(resultado.juegosLocal - resultado.juegosVisitante);
                const factorMarcador = !team1Wins ? diffJuegos * 2.2 : -diffJuegos * 1.5;
                const factorNivelIndividual = (player.nivel - 2.0) * 3.8;
                
                let factorTipoPartido = 0;
                switch (partido.tipo) {
                    case 'liga': factorTipoPartido = 3.5; break;
                    case 'reto': factorTipoPartido = 2.8; break;
                    case 'amistoso': factorTipoPartido = 1.2; break;
                    default: factorTipoPartido = 1.5;
                }
                
                const factorExperiencia = Math.min(2.5, player.matches * 0.15);
                
                let factorRacha = 0;
                if (player.matches > 0) {
                    const porcentajeVictorias = (player.wins / player.matches) * 100;
                    if (porcentajeVictorias < 30) factorRacha = 2.1;
                    else if (porcentajeVictorias > 70) factorRacha = -1.8;
                }
                
                let factorPresion = 0;
                if (partido.tipo === 'liga' && player.matches < 5) factorPresion = 1.8;
                else if (partido.tipo === 'liga' && player.matches > 20) factorPresion = -0.9;
                
                let factorConsistencia = 0;
                if (player.history.length > 3) {
                    const ultimos3 = player.history.slice(-3).map(h => h.change);
                    const variacion = Math.abs(ultimos3[2] - ultimos3[0]) / Math.abs(ultimos3[0] || 1);
                    if (variacion < 0.3) factorConsistencia = 1.5;
                    else if (variacion > 0.8) factorConsistencia = -1.2;
                }
                
                let factorMomentum = 0;
                if (player.history.length > 0) {
                    const ultimoCambio = player.history[player.history.length - 1].change;
                    if (ultimoCambio > 5) factorMomentum = 1.2;
                    else if (ultimoCambio < -5) factorMomentum = -1.0;
                }
                
                const totalJuegos = resultado.juegosLocal + resultado.juegosVisitante;
                let factorIntensidad = 0;
                if (totalJuegos > 20) factorIntensidad = 1.8;
                else if (totalJuegos > 15) factorIntensidad = 1.2;
                else if (totalJuegos < 10) factorIntensidad = -0.8;
                
                let factorClutch = 0;
                const diffSets = Math.abs(resultado.setsLocal - resultado.setsVisitante);
                const diffJuegosTotal = Math.abs(resultado.juegosLocal - resultado.juegosVisitante);
                if (diffSets === 1 && diffJuegosTotal <= 4) {
                    factorClutch = !team1Wins ? 2.5 : -1.8;
                }
                
                const nivelPromedioRivales = (team1[0].nivel + team1[1].nivel) / 2;
                let factorAntiSandbagging = 0;
                if (player.nivel > 3.0 && nivelPromedioRivales < 2.5) {
                    factorAntiSandbagging = -2.8;
                } else if (player.nivel < 2.5 && nivelPromedioRivales > 3.0) {
                    factorAntiSandbagging = 2.5;
                }
                
                const miNivel = player.nivel;
                const rivalMasAlto = Math.max(team1[0].nivel, team1[1].nivel);
                const rivalMasBajo = Math.min(team1[0].nivel, team1[1].nivel);
                let factorRendimientoVsRivales = 0;
                if (miNivel > rivalMasAlto) factorRendimientoVsRivales = -1.5;
                else if (miNivel < rivalMasBajo) factorRendimientoVsRivales = 2.2;
                else factorRendimientoVsRivales = 0.8;
                
                const sumaFactoresIndividuales = factorNivelPartido + factorCompanero + factorRivales + 
                                               factorMarcador + factorNivelIndividual + factorTipoPartido + 
                                               factorExperiencia + factorRacha + factorPresion + factorConsistencia +
                                               factorMomentum + factorIntensidad + factorClutch + factorAntiSandbagging +
                                               factorRendimientoVsRivales;
                
                const puntosIndividuales = sumaFactoresIndividuales / 5.8;
                const cambioFinal = finalChange + puntosIndividuales;
                
                console.log(`üë§ ${player.name} - Cambio Elo: ${cambioFinal.toFixed(2)} (Base: ${finalChange.toFixed(2)}, Factores: ${puntosIndividuales.toFixed(2)})`);
                
                // Aplicar cambio al Elo
                player.elo += cambioFinal;
                player.puntosRanking = player.elo;
                player.matches++;
                if (!team1Wins) player.wins++;
                player.setsWon += resultado.setsVisitante;
                player.setsLost += resultado.setsLocal;
                player.performance += ri2;
                player.difficulty += Math.round(fd2 * 100);
                player.history.push({
                    change: cambioFinal,
                    opponent: `${team1[0].name} & ${team1[1].name}`,
                    date: new Date(partido.fecha).toLocaleDateString(),
                    factores: {
                        nivelPartido: factorNivelPartido,
                        companero: factorCompanero,
                        rivales: factorRivales,
                        marcador: factorMarcador,
                        nivelIndividual: factorNivelIndividual,
                        tipoPartido: factorTipoPartido,
                        experiencia: factorExperiencia,
                        racha: factorRacha,
                        presion: factorPresion,
                        consistencia: factorConsistencia,
                        momentum: factorMomentum,
                        intensidad: factorIntensidad,
                        clutch: factorClutch,
                        antiSandbagging: factorAntiSandbagging,
                        rendimientoVsRivales: factorRendimientoVsRivales,
                        total: puntosIndividuales
                    }
                });
            });
            
            // Guardar detalles del √∫ltimo partido para mostrar
            lastMatchDetails = {
                team1,
                team2,
                sets: [
                    { team1: resultado.juegosLocal, team2: resultado.juegosVisitante }
                ],
                team1Sets: resultado.setsLocal,
                team2Sets: resultado.setsVisitante,
                stats,
                winner: team1Wins ? 'team1' : 'team2',
                date: new Date(partido.fecha).toLocaleDateString(),
                tipo: partido.tipo
            };
            
            console.log(`‚úÖ Partido ${partido.id} procesado correctamente`);
            
        } catch (error) {
            console.error(`‚ùå Error procesando partido ${partido.id}:`, error);
        }
    }
    </script>
    
    <script src="./js/menu-hamburguesa.js"></script>
</body>
</html> 